<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>40. Early Bird APC Injection</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="a9fb0ac0-fc46-4b7c-8a61-de3fba4d7c8c" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/40"><strong>40. Early Bird APC Injection</strong></a></h1></header><div class="page-body"><h2 id="583e6e18-c219-4aba-a786-ef2c124764cc" class=""><strong>Early Bird APC Injection</strong></h2><h3 id="bebe2395-76de-493e-a5f1-6ad76d8fc4e4" class=""><strong>Introduction</strong></h3><p id="d2b86ea5-8a87-4c0d-b4c6-e7e5613b4909" class="">In the previous module, <code>QueueUserAPC</code> was used to perform local APC injection. In this module, the same API will be used to execute the payload in a remote process. Although the approach will slightly differ, the method used is the same.</p><p id="67361d57-bf7c-4887-9afe-c1818d7e1dae" class="">By now it should be well understood that APC injection requires either a suspended or an alertable thread to successfully execute the payload. However, it is difficult to come across threads that are in these states, especially ones that are operating under normal user privileges.</p><p id="fa0f75ff-c8b3-48a0-ab36-d35fca9938e8" class="">The solution for this is to create a suspended process using the <code>CreateProcess</code> WinAPI and use the handle to its suspended thread. The suspended thread meets the criteria to be used in APC injection. This method is known as Early Bird APC Injection.</p><h3 id="fb581894-515a-4139-a46f-939988b0c2ae" class=""><strong>Early Bird Implementation Logic (1)</strong></h3><p id="11f21864-5f8f-47a6-b7d0-7b2c03727bde" class="">The implementation logic of this technique will be as follows:</p><ol type="1" id="b49708e3-38ba-49e5-8c45-8fad865ead7e" class="numbered-list" start="1"><li>Create a suspended process by using the <code>CREATE_SUSPENDED</code> flag.</li></ol><ol type="1" id="c2af5595-be4a-4265-9406-1af03241c7b4" class="numbered-list" start="2"><li>Write the payload to the address space of the new target process.</li></ol><ol type="1" id="0e0280d1-94c9-4811-a400-de9709ca8aea" class="numbered-list" start="3"><li>Get the suspended thread&#x27;s handle from <code>CreateProcess</code> along with the payload&#x27;s base address and pass them to <code>QueueUserAPC</code>.</li></ol><ol type="1" id="783cc4c4-db79-4e74-8f0b-b1bf9879e235" class="numbered-list" start="4"><li>Resume the thread using the <code>ResumeThread</code> WinAPI to execute the payload.</li></ol><h3 id="464ace98-e5b2-4292-a635-b914f3c5a130" class=""><strong>Early Bird Implementation Logic (2)</strong></h3><p id="6524cd42-a901-4c62-bbd7-501503294d54" class="">The implementation logic explained in the previous section is straightforward. This section introduces an alternative way of implementing Early Bird APC Injection.</p><p id="412802a1-d5ea-4646-997c-a732c4386652" class=""><code>CreateProcess</code> will still be used, but the <a href="https://learn.microsoft.com/en-us/windows/desktop/ProcThread/process-creation-flags">process creation flag</a> will be changed from <code>CREATE_SUSPENDED</code> to <code>DEBUG_PROCESS</code>. The <code>DEBUG_PROCESS</code> flag will create the new process as a debugged process and make the local process its debugger. When a process is created as a debugged process, a breakpoint will be placed in its entry point. This pauses the process and waits for the debugger (i.e. the malware) to resume execution.</p><p id="fda04979-ad00-41ff-86e2-7107b25a4c21" class="">When this occurs, the payload is injected into the target process to be executed using the <code>QueueUserAPC</code> WinAPI. Once the payload is injected and the remote debugged thread is queued to run the payload, the local process can be detached from the target process using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-debugactiveprocessstop">DebugActiveProcessStop</a> WinAPI which stops the remote process from being debugged.</p><p id="eecb400f-7fc3-48e0-9a3b-fbe4868386c4" class=""><code>DebugActiveProcessStop</code> requires only one parameter which is the PID of the debugged process that can be fetched from the <code>PROCESS_INFORMATION</code> structure populated by <code>CreateProcess</code>.</p><h3 id="dc37d8f2-1292-4183-b732-232c03b76e5f" class=""><strong>Updated Implementation Logic</strong></h3><p id="b95e0d72-1cdf-44e2-9d5e-fee11e662273" class="">The updated implementation will be as follows:</p><ol type="1" id="aa9676f7-df77-4d75-959d-c4d36e8ec2c9" class="numbered-list" start="1"><li>Create a debugged process by setting the <code>DEBUG_PROCESS</code> flag.</li></ol><ol type="1" id="804d539a-8529-4a00-a103-0eb9449b54b5" class="numbered-list" start="2"><li>Write the payload to the address space of the new target process.</li></ol><ol type="1" id="5a4a23be-6277-4da7-a714-0a2167711006" class="numbered-list" start="3"><li>Get the debugged thread&#x27;s handle from <code>CreateProcess</code> along with the payload&#x27;s base address and pass them to <code>QueueUserAPC</code>.</li></ol><ol type="1" id="99346bc2-fa6b-40f8-a0d8-93daf848f85c" class="numbered-list" start="4"><li>Stop the debugging of the remote process using <code>DebugActiveProcessStop</code> which resumes its threads and executes the payload.</li></ol><h3 id="19f74a02-aa82-4be8-aea7-8d0c35de1021" class=""><strong>Early Bird APC Injection Function</strong></h3><p id="d8af84dd-c0f9-4acc-9807-8e812b12c515" class=""><code>CreateSuspendedProcess2</code> is a function that performs Early Bird APC Injection and requires 4 arguments:</p><ul id="95323e4c-b84d-4d5b-bd71-79569b098bd7" class="bulleted-list"><li style="list-style-type:disc"><code>lpProcessName</code> - The name of the process to create.</li></ul><ul id="92e2d4f3-6063-4798-805d-f5433a53a65b" class="bulleted-list"><li style="list-style-type:disc"><code>dwProcessId</code> - A pointer to a DWORD which will receive the newly created process&#x27;s PID.</li></ul><ul id="21c9e39b-3255-4bb2-946c-330fb298a940" class="bulleted-list"><li style="list-style-type:disc"><code>hProcess</code> - Pointer to a HANDLE that will receive the newly created process&#x27;s handle.</li></ul><ul id="1c2a0441-ec89-4e31-99bf-9b1db9e8e181" class="bulleted-list"><li style="list-style-type:disc"><code>hThread</code> - Pointer to a HANDLE that will receive the newly created process&#x27;s thread.</li></ul><pre id="2a03cb5e-20e9-4680-8161-72d3ee33bf45" class="code code-wrap"><code>BOOL CreateSuspendedProcess2(LPCSTR lpProcessName, DWORD* dwProcessId, HANDLE* hProcess, HANDLE* hThread) {

	CHAR lpPath   [MAX_PATH * 2];
	CHAR WnDr     [MAX_PATH];

	STARTUPINFO            Si    = { 0 };
	PROCESS_INFORMATION    Pi    = { 0 };

	// Cleaning the structs by setting the element values to 0
	RtlSecureZeroMemory(&amp;Si, sizeof(STARTUPINFO));
	RtlSecureZeroMemory(&amp;Pi, sizeof(PROCESS_INFORMATION));

	// Setting the size of the structure
	Si.cb = sizeof(STARTUPINFO);

	// Getting the %WINDIR% environment variable path (That is generally &#x27;C:\Windows&#x27;)
	if (!GetEnvironmentVariableA(&quot;WINDIR&quot;, WnDr, MAX_PATH)) {
		printf(&quot;[!] GetEnvironmentVariableA Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	// Creating the target process path
	sprintf(lpPath, &quot;%s\\System32\\%s&quot;, WnDr, lpProcessName);
	printf(&quot;\n\t[i] Running : \&quot;%s\&quot; ... &quot;, lpPath);

	// Creating the process
	if (!CreateProcessA(
		NULL,
		lpPath,
		NULL,
		NULL,
		FALSE,
		DEBUG_PROCESS,		// Instead of CREATE_SUSPENDED
		NULL,
		NULL,
		&amp;Si,
		&amp;Pi)) {
		printf(&quot;[!] CreateProcessA Failed with Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	printf(&quot;[+] DONE \n&quot;);

	// Filling up the OUTPUT parameter with CreateProcessA&#x27;s output
	*dwProcessId        = Pi.dwProcessId;
	*hProcess           = Pi.hProcess;
	*hThread            = Pi.hThread;

	// Doing a check to verify we got everything we need
	if (*dwProcessId != NULL &amp;&amp; *hProcess != NULL &amp;&amp; *hThread != NULL)
		return TRUE;

	return FALSE;
}
</code></pre><h3 id="0f72b9be-591f-469c-9640-157077d534de" class=""><strong>Demo</strong></h3><p id="300f0793-ebe1-4068-8597-a8fe22cc2ba0" class="">The image below shows the newly created target process in a debug state. A debugged process is highlighted in purple in Process Hacker.</p><p id="a3d2f4eb-e4f4-46f6-a6ca-ea095addd710" class="">
</p><figure id="83add7a7-0733-4b65-ad90-8e3c7e144faa" class="image"><a href="40%20Early%20Bird%20APC%20Injection%20a9fb0ac0fc464b7c8a61de3fba4d7c8c/demo-109330271-93c3e529-dfea-4868-ad56-48ce90efe172.png"><img style="width:1332px" src="40%20Early%20Bird%20APC%20Injection%20a9fb0ac0fc464b7c8a61de3fba4d7c8c/demo-109330271-93c3e529-dfea-4868-ad56-48ce90efe172.png"/></a></figure><p id="fb795b7a-0875-4939-bb96-de2b56cab78e" class="">Next, the payload is written to the target process.</p><figure id="ec1a127b-5708-4da3-ab52-8ae7cdf7afd3" class="image"><a href="40%20Early%20Bird%20APC%20Injection%20a9fb0ac0fc464b7c8a61de3fba4d7c8c/demo-209330277-04b3a674-e5f7-41b1-95a3-423e34d2f5aa.png"><img style="width:1676px" src="40%20Early%20Bird%20APC%20Injection%20a9fb0ac0fc464b7c8a61de3fba4d7c8c/demo-209330277-04b3a674-e5f7-41b1-95a3-423e34d2f5aa.png"/></a></figure><p id="04588a0d-f42e-42b8-ae65-ea70419097e9" class="">Finally, the payload is executed.</p><figure id="f9534182-c3e8-43f8-bcdc-ca0b091fe02a" class="image"><a href="40%20Early%20Bird%20APC%20Injection%20a9fb0ac0fc464b7c8a61de3fba4d7c8c/demo-309330284-92aec1dc-b899-49a8-a170-f9845cbe5246.png"><img style="width:1557px" src="40%20Early%20Bird%20APC%20Injection%20a9fb0ac0fc464b7c8a61de3fba4d7c8c/demo-309330284-92aec1dc-b899-49a8-a170-f9845cbe5246.png"/></a></figure></div></article></body></html>