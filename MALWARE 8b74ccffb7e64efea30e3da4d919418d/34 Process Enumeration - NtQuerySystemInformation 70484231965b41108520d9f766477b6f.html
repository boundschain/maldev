<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>34. Process Enumeration - NtQuerySystemInformation</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="70484231-965b-4110-8520-d9f766477b6f" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/34"><strong>34. Process Enumeration - NtQuerySystemInformation</strong></a></h1></header><div class="page-body"><h2 id="0ddf3bfe-a030-4094-a282-914a9e4af122" class=""><strong>Process Enumeration - NtQuerySystemInformation</strong></h2><h3 id="9c83ee75-4996-4f79-a6d3-2f7ddb719312" class=""><strong>Introduction</strong></h3><p id="15481ac9-c9b5-40ae-9e70-a75145afe6e4" class="">This module discusses a more unique way of performing process enumeration using <code>NtQuerySystemInformation</code>, which is a <strong>syscall</strong> (more on syscalls later). <code>NtQuerySystemInformation</code> is exported from the <code>ntdll.dll</code> module and therefore it will require the use of <code>GetModuleHandle</code> and <code>GetProcAddress</code>.</p><p id="93f9a8f8-17d0-484d-966f-ede025a95f26" class=""><a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation">Microsoft&#x27;s documentation</a> on <code>NtQuerySystemInformation</code> shows that it is capable of returning a lot of information about the system. The focus of this module will be on using it to perform process enumeration.</p><h3 id="9271f3db-2368-436d-bd6a-2ae356b48f94" class=""><strong>Retrieve NtQuerySystemInformation&#x27;s Address</strong></h3><p id="37b6d32a-f673-4410-88b4-5576a8bd820f" class="">As previously mentioned, <code>GetProcAddress</code> and <code>GetModuleHandle</code> are needed to retrieve <code>NtQuerySystemInformation</code>&#x27;s address from <code>ntdll.dll</code>.</p><pre id="58a5c397-c05f-48ea-a942-e571f6aca900" class="code code-wrap"><code>// Function pointer
typedef NTSTATUS (NTAPI* fnNtQuerySystemInformation)(
	SYSTEM_INFORMATION_CLASS SystemInformationClass,
	PVOID                    SystemInformation,
	ULONG                    SystemInformationLength,
	PULONG                   ReturnLength
);

fnNtQuerySystemInformation pNtQuerySystemInformation = NULL;

// Getting NtQuerySystemInformation&#x27;s address
pNtQuerySystemInformation = (fnNtQuerySystemInformation)GetProcAddress(GetModuleHandle(L&quot;NTDLL.DLL&quot;), &quot;NtQuerySystemInformation&quot;);
if (pNtQuerySystemInformation == NULL) {
	printf(&quot;[!] GetProcAddress Failed With Error : %d\n&quot;, GetLastError());
	return FALSE;
}

</code></pre><h3 id="f8c97ebf-e580-490a-9ee6-6c5fa084be3c" class=""><strong>NtQuerySystemInformation Parameters</strong></h3><p id="2ff6af68-4eb5-4c18-8645-e45cb2429522" class=""><code>NtQuerySystemInformation</code>&#x27;s parameters are shown below.</p><pre id="2b3105c1-8061-4280-a6e8-f906d9a26c6f" class="code code-wrap"><code>__kernel_entry NTSTATUS NtQuerySystemInformation(
  [in]            SYSTEM_INFORMATION_CLASS SystemInformationClass,
  [in, out]       PVOID                    SystemInformation,
  [in]            ULONG                    SystemInformationLength,
  [out, optional] PULONG                   ReturnLength
);
</code></pre><ul id="9c5e92e8-833b-4cb6-bf75-ea5637df32ce" class="bulleted-list"><li style="list-style-type:disc"><code>SystemInformationClass</code> - Decides what type of system information the function returns.</li></ul><ul id="8116b852-8e3b-439e-932b-2bdd31beed24" class="bulleted-list"><li style="list-style-type:disc"><code>SystemInformation</code> - A pointer to a buffer that will receive the requested information. The returned information will be in a form of a structure of type specified according to the <code>SystemInformationClass</code> parameter.</li></ul><ul id="1ebf4f1c-fdf0-4f4f-a321-edaee502b4cf" class="bulleted-list"><li style="list-style-type:disc"><code>SystemInformationLength</code> - The size of the buffer pointed to by the <code>SystemInformation</code> parameter, in bytes.</li></ul><ul id="65d7e080-3258-4237-b3e2-a5256d8507e5" class="bulleted-list"><li style="list-style-type:disc"><code>ReturnLength</code> - A pointer to a ULONG variable that will receive the actual size of the information written to <code>SystemInformation</code>.</li></ul><p id="1b7c66a1-937a-42db-bded-cbce5a56983c" class="">Since the objective is process enumeration, the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation#systemprocessinformation">SystemProcessInformation</a> flag will be used. Using this flag will make the function return an array of <code>SYSTEM_PROCESS_INFORMATION</code> structures (via the <code>SystemInformation</code> parameter), one for each process running in the system.</p><figure id="bc1217e8-8b6e-4050-b5d8-731e7d5772be" class="image"><a href="34%20Process%20Enumeration%20-%20NtQuerySystemInformation%2070484231965b41108520d9f766477b6f/nt-108508463-27e8a0b8-4d4e-4391-bf1d-8d75ad2567d3.png"><img style="width:1032px" src="34%20Process%20Enumeration%20-%20NtQuerySystemInformation%2070484231965b41108520d9f766477b6f/nt-108508463-27e8a0b8-4d4e-4391-bf1d-8d75ad2567d3.png"/></a></figure><h3 id="72ebeb22-37e1-484b-a353-f59905c06958" class=""><strong>SYSTEM_PROCESS_INFORMATION Structure</strong></h3><p id="27c32df1-57d1-44ce-bc5d-b8693c345060" class="">The next step is to review <a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntquerysysteminformation#system_process_information">Microsoft&#x27;s documentation</a> to understand what the <code>SYSTEM_PROCESS_INFORMATION</code> structure looks like.</p><pre id="f1e45444-7692-4591-81c9-82583bfed7bf" class="code code-wrap"><code>typedef struct _SYSTEM_PROCESS_INFORMATION {
    ULONG NextEntryOffset;
    ULONG NumberOfThreads;
    BYTE Reserved1[48];
    UNICODE_STRING ImageName;
    KPRIORITY BasePriority;
    HANDLE UniqueProcessId;
    PVOID Reserved2;
    ULONG HandleCount;
    ULONG SessionId;
    PVOID Reserved3;
    SIZE_T PeakVirtualSize;
    SIZE_T VirtualSize;
    ULONG Reserved4;
    SIZE_T PeakWorkingSetSize;
    SIZE_T WorkingSetSize;
    PVOID Reserved5;
    SIZE_T QuotaPagedPoolUsage;
    PVOID Reserved6;
    SIZE_T QuotaNonPagedPoolUsage;
    SIZE_T PagefileUsage;
    SIZE_T PeakPagefileUsage;
    SIZE_T PrivatePageCount;
    LARGE_INTEGER Reserved7[6];
} SYSTEM_PROCESS_INFORMATION;
</code></pre><p id="ae8858e4-4c7e-4a50-bd27-f495928a9420" class="">The focus will be on <code>UNICODE_STRING ImageName</code> which contains the process name and <code>UniqueProcessId</code> which is the process ID. Additionally, <code>NextEntryOffset</code> will be used to move into the next element in the returned array.</p><p id="d5bcf323-e547-4912-bad3-a7fefb87e2fd" class="">Since calling <code>NtQuerySystemInformation</code> with the <code>SystemProcessInformation</code> flag will return an array of <code>SYSTEM_PROCESS_INFORMATION</code> of unknown size, <code>NtQuerySystemInformation</code> will need to be called twice. The first call will retrieve the array size, which is used to allocate a buffer, and then the second call will use the allocated buffer.</p><p id="a1014e39-280b-4572-b3bf-dd3f00655006" class="">It&#x27;s expected that the first <code>NtQuerySystemInformation</code> call will fail with a <code>STATUS_INFO_LENGTH_MISMATCH</code> (<a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55">0xC0000004</a>) error since invalid parameters are being passed simply to retrieve the array size.</p><pre id="5e88fbd9-2330-4599-aa05-326ec8989b6c" class="code code-wrap"><code>ULONG                        uReturnLen1    = NULL,
                             uReturnLen2    = NULL;
PSYSTEM_PROCESS_INFORMATION  SystemProcInfo = NULL;
NTSTATUS                     STATUS         = NULL;

// First NtQuerySystemInformation call
// This will fail with STATUS_INFO_LENGTH_MISMATCH
// But it will provide information about how much memory to allocate (uReturnLen1)
pNtQuerySystemInformation(SystemProcessInformation, NULL, NULL, &amp;uReturnLen1);

// Allocating enough buffer for the returned array of `SYSTEM_PROCESS_INFORMATION` struct
SystemProcInfo = (PSYSTEM_PROCESS_INFORMATION) HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, (SIZE_T)uReturnLen1);
if (SystemProcInfo == NULL) {
	printf(&quot;[!] HeapAlloc Failed With Error : %d\n&quot;, GetLastError());
	return FALSE;
}

// Second NtQuerySystemInformation call
// Calling NtQuerySystemInformation with the correct arguments, the output will be saved to &#x27;SystemProcInfo&#x27;
STATUS = pNtQuerySystemInformation(SystemProcessInformation, SystemProcInfo, uReturnLen1, &amp;uReturnLen2);
if (STATUS != 0x0) {
	printf(&quot;[!] NtQuerySystemInformation Failed With Error : 0x%0.8X \n&quot;, STATUS);
	return FALSE;
}
</code></pre><h3 id="9c519f30-7db7-4af7-b96c-4d1953ecd426" class=""><strong>Iterating Through Processes</strong></h3><p id="71617e45-6855-4cdc-80da-0c322a8a128a" class="">Now that the array has been successfully retrieved, the next step is to loop through it and access <code>ImageName.Buffer</code>, which holds the process name. Every iteration will compare the process name to the target process name.</p><p id="c3667d6d-2a33-45ec-9aef-a29e53120edd" class="">To access each element of type <code>SYSTEM_PROCESS_INFORMATION</code> in the array, the <code>NextEntryOffset</code> member must be used. To find the address of the next element, add the address of the previous element to <code>NextEntryOffset</code>. This is demonstrated in the snippet below.</p><pre id="446630bc-70b8-469b-b4e0-aa8767a729ab" class="code code-wrap"><code>// &#x27;SystemProcInfo&#x27; will now represent a new element in the array
SystemProcInfo = (PSYSTEM_PROCESS_INFORMATION)((ULONG_PTR)SystemProcInfo + SystemProcInfo-&gt;NextEntryOffset);
</code></pre><h3 id="cd2fa8c4-18ae-47c6-91cb-43edef339258" class=""><strong>Freeing allocated Memory</strong></h3><p id="e00a2909-e657-474e-87ce-71db917a9fdb" class="">Before moving <code>SystemProcInfo</code> to the new element in the array, the initial address of the allocated memory needs to be saved in order to be freed later. Therefore, right before the loop begins, the address needs to be saved to a temporary variable.</p><pre id="d35d2b86-2853-4976-a170-7d4f5bc722fe" class="code code-wrap"><code>// Since we will modify &#x27;SystemProcInfo&#x27;, we will save its initial value before the while loop to free it later
pValueToFree = SystemProcInfo;
</code></pre><h3 id="b24e3482-5ff8-4cd1-9298-2a768ddadc8f" class=""><strong>NtQuerySystemInformation Process Enumeration</strong></h3><p id="24b6aaa6-c69c-4473-8e91-ef0fdb18efce" class="">The complete code to perform process enumeration using <code>NtQuerySystemInformation</code> is shown below.</p><pre id="28d3791d-207a-4d76-b0a9-26ad91f03095" class="code code-wrap"><code>BOOL GetRemoteProcessHandle(LPCWSTR szProcName, DWORD* pdwPid, HANDLE* phProcess) {

	fnNtQuerySystemInformation   pNtQuerySystemInformation = NULL;
	ULONG                        uReturnLen1               = NULL,
                                 uReturnLen2               = NULL;
    PSYSTEM_PROCESS_INFORMATION  SystemProcInfo            = NULL;
    NTSTATUS                     STATUS                    = NULL;
	PVOID                        pValueToFree              = NULL;

	pNtQuerySystemInformation = (fnNtQuerySystemInformation)GetProcAddress(GetModuleHandle(L&quot;NTDLL.DLL&quot;), &quot;NtQuerySystemInformation&quot;);
	if (pNtQuerySystemInformation == NULL) {
		printf(&quot;[!] GetProcAddress Failed With Error : %d\n&quot;, GetLastError());
		return FALSE;
	}

	pNtQuerySystemInformation(SystemProcessInformation, NULL, NULL, &amp;uReturnLen1);

	SystemProcInfo = (PSYSTEM_PROCESS_INFORMATION)HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, (SIZE_T)uReturnLen1);
	if (SystemProcInfo == NULL) {
		printf(&quot;[!] HeapAlloc Failed With Error : %d\n&quot;, GetLastError());
		return FALSE;
	}

	// Since we will modify &#x27;SystemProcInfo&#x27;, we will save its initial value before the while loop to free it later
	pValueToFree = SystemProcInfo;

	STATUS = pNtQuerySystemInformation(SystemProcessInformation, SystemProcInfo, uReturnLen1, &amp;uReturnLen2);
	if (STATUS != 0x0) {
		printf(&quot;[!] NtQuerySystemInformation Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}

	while (TRUE) {

		// Check the process&#x27;s name size
		// Comparing the enumerated process name to the intended target process
		if (SystemProcInfo-&gt;ImageName.Length &amp;&amp; wcscmp(SystemProcInfo-&gt;ImageName.Buffer, szProcName) == 0) {

			// Opening a handle to the target process, saving it, and then breaking
			*pdwPid		= (DWORD)SystemProcInfo-&gt;UniqueProcessId;
			*phProcess	= OpenProcess(PROCESS_ALL_ACCESS, FALSE, (DWORD)SystemProcInfo-&gt;UniqueProcessId);
			break;
		}

		// If NextEntryOffset is 0, we reached the end of the array
		if (!SystemProcInfo-&gt;NextEntryOffset)
			break;

		// Move to the next element in the array
		SystemProcInfo = (PSYSTEM_PROCESS_INFORMATION)((ULONG_PTR)SystemProcInfo + SystemProcInfo-&gt;NextEntryOffset);
	}

	// Free using the initial address
	HeapFree(GetProcessHeap(), 0, pValueToFree);

	// Check if we successfully got the target process handle
	if (*pdwPid == NULL || *phProcess == NULL)
		return FALSE;
	else
		return TRUE;
}

</code></pre><h3 id="aad86a3e-bc6e-41bb-bd5f-2a27604a7fea" class=""><strong>Undocumented Part of NtQuerySystemInformation</strong></h3><p id="d4c67dda-e7a4-4ff9-9270-68cd0c58d040" class=""><code>NtQuerySystemInformation</code> remains largely undocumented and a large portion of it is still unknown. For example, notice the <code>Reserved</code> members in <code>SYSTEM_PROCESS_INFORMATION</code>.</p><figure id="469646ff-9adf-449d-a350-999c80e189e0" class="image"><a href="34%20Process%20Enumeration%20-%20NtQuerySystemInformation%2070484231965b41108520d9f766477b6f/nt-208666134-5c070d23-50f4-4e1d-978f-11122892a9c3.png"><img style="width:850px" src="34%20Process%20Enumeration%20-%20NtQuerySystemInformation%2070484231965b41108520d9f766477b6f/nt-208666134-5c070d23-50f4-4e1d-978f-11122892a9c3.png"/></a></figure><p id="a3b6041a-9bc9-41e2-81d1-1c64d59827bd" class="">The code provided in this module uses a different version of the <code>SYSTEM_PROCESS_INFORMATION</code> structure. Regardless, both Microsoft&#x27;s version and the version used in the module&#x27;s code lead to the same output. The main difference is the structure that&#x27;s used in this module contains more information rather than Microsoft&#x27;s limited version which contains several <code>Reserved</code> members. Furthermore, another version of the <code>SYSTEM_INFORMATION_CLASS</code> structure was used which is also more documented than Microsoft&#x27;s version. Both structures can be viewed via the links below.</p><ul id="03991002-c0a2-4f08-8425-b89012fa8bd7" class="bulleted-list"><li style="list-style-type:disc"><code>SYSTEM_PROCESS_INFORMATION</code> from <a href="https://doxygen.reactos.org/da/df4/struct__SYSTEM__PROCESS__INFORMATION.html">ReactOS Documentation</a></li></ul><ul id="a718f995-1720-47f6-abe2-639e972ec07b" class="bulleted-list"><li style="list-style-type:disc"><code>SYSTEM_INFORMATION_CLASS</code> from <a href="https://github.com/winsiderss/systeminformer/blob/master/phnt/include/ntexapi.h#L1345">System Informer Documentation</a></li></ul><h3 id="7d58b6b9-8757-406d-ab36-bee653e72321" class=""><strong>Demo</strong></h3><p id="5d40f69e-4659-491d-89e6-5ab3fe444022" class="">The image below shows the output after compiling and running the code presented in this module. The target process is <code>Notepad.exe</code>.</p><figure id="9757a496-3e2e-4f09-8511-47d74ee2545e" class="image"><a href="34%20Process%20Enumeration%20-%20NtQuerySystemInformation%2070484231965b41108520d9f766477b6f/nt-308665154-9c8bdf73-bfb4-40b5-a39f-3b6ee2044076.png"><img style="width:1282px" src="34%20Process%20Enumeration%20-%20NtQuerySystemInformation%2070484231965b41108520d9f766477b6f/nt-308665154-9c8bdf73-bfb4-40b5-a39f-3b6ee2044076.png"/></a></figure></div></article></body></html>