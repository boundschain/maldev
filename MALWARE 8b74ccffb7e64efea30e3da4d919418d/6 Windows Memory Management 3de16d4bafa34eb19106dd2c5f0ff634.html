<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>6. Windows Memory Management</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="3de16d4b-afa3-4eb1-9106-dd2c5f0ff634" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/6"><strong>6. Windows Memory Management</strong></a></h1></header><div class="page-body"><h2 id="182b0dc8-492f-446b-9d78-5fb2d4a6edce" class=""><strong>Windows Memory Management</strong></h2><h3 id="e5bb8418-2b97-40eb-aa35-aa4a5b2e1fb0" class=""><strong>Introduction</strong></h3><p id="380c9bd4-3138-4283-befd-a63a9385ca0b" class="">This module goes through the fundamentals of Windows memory. Understanding how Windows handles memory is crucial to building advanced malware.</p><h3 id="29b42361-9e92-47d4-80e4-fab4fb200743" class=""><strong>Virtual Memory &amp; Paging</strong></h3><p id="87dc7347-e4b5-422d-801b-c40d13e2666e" class="">Memory in modern operating systems is not mapped directly to physical memory (i.e the RAM). Instead, virtual memory addresses are used by processes that are mapped to physical memory addresses. There are several reasons for this but ultimately the goal is to save as much physical memory as possible. Virtual memory may be mapped to physical memory but can also be stored on disk. With virtual memory addressing it becomes possible for multiple processes to share the same physical address while having a unique virtual memory address. Virtual memory relies on the concept of <em>Memory paging</em> which divides memory into chunks of 4kb called &quot;pages&quot;.</p><p id="7d397345-cdc5-476a-98ef-80d1096cc192" class="">See the image below from the <a href="https://learn.microsoft.com/en-us/sysinternals/resources/windows-internals">Windows Internals 7th edition - part 1</a> book.</p><figure id="a046a763-bcc2-4bd5-9c02-938cb3bab0b3" class="image"><a href="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/virtual-memory.png"><img style="width:592px" src="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/virtual-memory.png"/></a></figure><h3 id="797e0378-1886-4964-a44c-9f697e1ac9d2" class=""><strong>Page State</strong></h3><p id="934016fb-602d-42d7-9984-2f7c0874098e" class="">The pages residing within a process&#x27;s virtual address space can be in one of 3 states:</p><ol type="1" id="f305d83c-018e-438b-b877-31d7cead2d45" class="numbered-list" start="1"><li><strong>Free</strong> - The page is neither committed nor reserved. The page is not accessible to the process. It is available to be reserved, committed, or simultaneously reserved and committed. Attempting to read from or write to a free page can result in an access violation exception.</li></ol><ol type="1" id="5a9ed0f6-a316-4730-888b-7a532e664cb6" class="numbered-list" start="2"><li><strong>Reserved</strong> - The page has been reserved for future use. The range of addresses cannot be used by other allocation functions. The page is not accessible and has no physical storage associated with it. It is available to be committed.</li></ol><ol type="1" id="b94d3589-abac-4efe-9e11-5717116f3bfa" class="numbered-list" start="3"><li><strong>Committed</strong> - Memory charges have been allocated from the overall size of RAM and paging files on disk. The page is accessible and access is controlled by one of the memory protection constants. The system initializes and loads each committed page into physical memory only during the first attempt to read or write to that page. When the process terminates, the system releases the storage for committed pages.</li></ol><h3 id="55553ff3-b41e-4974-94d5-919f9b2e83c1" class=""><strong>Page Protection Options</strong></h3><p id="ff802c4f-272e-48b8-9f00-f98ff90fa91f" class="">Once the pages are committed, they need to have their protection option set. The list of memory protection constants can be found <a href="https://learn.microsoft.com/en-us/windows/win32/memory/memory-protection-constants">here</a> but some examples are listed below.</p><ul id="eb6dd212-78c4-4da7-bbc9-436a15212fb4" class="bulleted-list"><li style="list-style-type:disc"><code>PAGE_NOACCESS</code> - Disables all access to the committed region of pages. An attempt to read from, write to or execute the committed region will result in an access violation.</li></ul><ul id="df3cedac-3051-42ec-b8be-49bdc6403375" class="bulleted-list"><li style="list-style-type:disc"><code>PAGE_EXECUTE_READWRITE</code> - Enables Read, Write and Execute. This is highly discouraged from being used and is generally an IoC because it&#x27;s uncommon for memory to be both writable and executable at the same time.</li></ul><ul id="2a39d078-171f-4eaf-816e-bf9911660a57" class="bulleted-list"><li style="list-style-type:disc"><code>PAGE_READONLY</code> - Enables read-only access to the committed region of pages. An attempt to write to the committed region results in an access violation.</li></ul><h3 id="38c28e23-efdc-455e-b872-bf459d935ab5" class=""><strong>Memory Protection</strong></h3><p id="f809828c-899a-447e-b8e2-f5be940cddab" class="">Modern operating systems generally have built-in memory protections to thwart exploits and attacks. These are also important to keep in mind as they will likely be encountered when building or debugging the malware.</p><ul id="e326659b-8662-4314-8172-76c5a9ed4993" class="bulleted-list"><li style="list-style-type:disc"><strong>Data Execution Prevention (DEP)</strong> - DEP is a system-level memory protection feature that is built into the operating system starting with Windows XP and Windows Server 2003. If the page protection option is set to PAGE_READONLY, then DEP will prevent code from executing in that memory region.</li></ul><ul id="0540d5ba-d5c0-4648-93ec-260dc2b7c485" class="bulleted-list"><li style="list-style-type:disc"><strong>Address space layout randomization (ASLR)</strong> - ASLR is a memory protection technique used to prevent the exploitation of memory corruption vulnerabilities. ASLR randomly arranges the address space positions of key data areas of a process, including the base of the executable and the positions of the stack, heap and libraries.</li></ul><h3 id="7ce87bc8-9e8b-45f7-840e-a0619d041e7e" class=""><strong>x86 vs x64 Memory Space</strong></h3><p id="319257ab-5450-49a6-99e0-d98c778effd2" class="">When working with Windows processes, it&#x27;s important to note whether the process is x86 or x64. x86 processes have a smaller memory space of 4GB (<code>0xFFFFFFFF</code>) whereas x64 has a vastly larger memory space of 128TB (<code>0xFFFFFFFFFFFFFFFF</code>).</p><h3 id="353c6a13-52e7-428c-b563-4dea2eee4857" class=""><strong>Allocating Memory Example</strong></h3><p id="7a9ade1a-09e9-4142-84cd-9d162fc97479" class="">This example goes through small code snippets to better understand how one can interact with Windows memory via C functions and Windows APIs. The first step in interacting with memory is allocating memory. The snippet below demonstrates several ways to allocate memory which is essentially reserving a memory inside the running process.</p><pre id="94563af9-bf98-4371-9316-76620154222d" class="code code-wrap"><code>// Allocating a memory buffer of *100* bytes

// Method 1 - Using malloc()
PVOID pAddress = malloc(100);

// Method 2 - Using HeapAlloc()
PVOID pAddress = HeapAlloc(GetProcessHeap(), 0, 100);

// Method 3 - Using LocalAlloc()
PVOID pAddress = LocalAlloc(LPTR, 100);
</code></pre><p id="ab987091-8b4d-42fc-be42-9ba55b29c576" class="">Memory allocation functions return the <em>base address</em> which is simply a pointer to the beginning of the memory block that was allocated. Using the snippets above, <code>pAddress</code> will be the base address of the memory block that was allocated. Using this pointer several actions can be taken such as reading, writing, and executing. The type of actions that can be performed will depend on the protection assigned to the allocated memory region.</p><p id="d2457896-1413-404f-8f47-d2fb40de60c2" class="">The image below shows what <code>pAddress</code> looks like under the debugger.</p><figure id="d90a8c43-f900-4639-b41d-6c1d707b0768" class="image"><a href="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-105290746-d5fa58f7-b3d7-4064-98b8-6f7ee5dcc12d.png"><img style="width:1321px" src="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-105290746-d5fa58f7-b3d7-4064-98b8-6f7ee5dcc12d.png"/></a></figure><p id="b216014c-9df5-436e-9f8c-d5cac668a1c7" class="">When memory is allocated, it may either be empty or contain random data. Some memory allocation functions provide an option to zero out the memory region during the allocation process.</p><figure id="9e900177-7430-496a-9ea5-f1768182d55f" class="image"><a href="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-205290946-31ab4c35-b0e6-4727-9d45-8e439453207d.png"><img style="width:1217px" src="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-205290946-31ab4c35-b0e6-4727-9d45-8e439453207d.png"/></a></figure><h3 id="18a8205f-8636-4feb-93db-50b5667eb469" class=""><strong>Writing To Memory Example</strong></h3><p id="22537a6d-e902-4166-b1ea-1a1c81635cc9" class="">The next step after memory allocation is generally writing to that buffer. Several options can be used to write to memory but for this example, <code>memcpy</code> is used.</p><pre id="876ab4ce-f050-43c5-af4e-f3f6dd972a05" class="code code-wrap"><code>PVOID pAddress	= HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, 100);

CHAR* cString	= &quot;MalDev Academy Is The Best&quot;;

memcpy(pAddress, cString, strlen(cString));
</code></pre><p id="b32074da-2fde-4fbf-8cbf-15c5794f04d2" class=""><code>HeapAlloc</code> uses the <code>HEAP_ZERO_MEMORY</code> flag which causes the allocated memory to be initialized to zero. The string is then copied to the allocated memory using <code>memcpy</code>. The last parameter in <code>memcpy</code> is the number of bytes to be copied. Next, recheck the buffer to verify that the data was successfully written.</p><figure id="9673517a-84f7-4428-ab7a-837d854fe934" class="image"><a href="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-305293097-6334290e-3d79-4254-9a79-cd7011ca4bbc.png"><img style="width:1534px" src="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-305293097-6334290e-3d79-4254-9a79-cd7011ca4bbc.png"/></a></figure><h3 id="e32a66fe-4966-4df3-972c-74b12080c65c" class=""><strong>Freeing Allocated Memory</strong></h3><p id="56b929fa-8553-4950-8083-bedf5691747c" class="">When the application is done using an allocated buffer, it is highly recommended to deallocate or free the buffer to avoid <a href="https://en.wikipedia.org/wiki/Memory_leak">memory leaks</a>.</p><p id="587d2d06-efad-4d2a-b5f0-27454d3d7b1c" class="">Depending on what function was used to allocate memory, it will have a corresponding memory deallocation function. For example:</p><ul id="067af562-c3c3-4548-ad5d-9a07009bc154" class="bulleted-list"><li style="list-style-type:disc">Allocating with <code>malloc</code> requires the use of the <code>free</code> function.</li></ul><ul id="439aef73-907d-4126-b221-e25e2b39c987" class="bulleted-list"><li style="list-style-type:disc">Allocating with <code>HeapAlloc</code> requires the use of the <code>HeapFree</code> function.</li></ul><ul id="dfa434b5-cc62-42b1-b84c-cd549dcf03bc" class="bulleted-list"><li style="list-style-type:disc">Allocating with <code>LocalAlloc</code> requires the use of the <code>LocalFree</code> function.</li></ul><p id="35bb2162-3612-4c0c-835e-3484a9f47be3" class="">The images below show <code>HeapFree</code> in action, freeing allocated memory at address <code>0000023ADE449900</code>. Notice the address <code>0000023ADE449900</code> still exists within the process but its original content was overwritten with random data. This new data is most likely due to a new allocation performed by the OS inside the process.</p><figure id="b67d00ed-b0e4-4748-b2ef-bcf0fae63864" class="image"><a href="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-424394866-a0dead3a-b72b-4600-8003-b8ecc2a27449.png"><img style="width:1444px" src="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-424394866-a0dead3a-b72b-4600-8003-b8ecc2a27449.png"/></a></figure><p id="045a5ae2-6182-42f1-b78b-ac4f7de4e62a" class="">
</p><figure id="389f270f-2c8a-463e-9611-e476d8d0291f" class="image"><a href="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-524394895-7c747075-d866-4ca8-a15f-09cb4fec7e6d.png"><img style="width:1434px" src="6%20Windows%20Memory%20Management%203de16d4bafa34eb19106dd2c5f0ff634/memory-mgmt-524394895-7c747075-d866-4ca8-a15f-09cb4fec7e6d.png"/></a></figure></div></article></body></html>