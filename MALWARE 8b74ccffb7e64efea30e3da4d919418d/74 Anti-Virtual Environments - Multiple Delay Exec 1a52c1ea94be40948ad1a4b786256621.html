<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>74. Anti-Virtual Environments - Multiple Delay Execution Techniques</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="1a52c1ea-94be-4094-8ad1-a4b786256621" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/74"><strong>74. Anti-Virtual Environments - Multiple Delay Execution Techniques</strong></a></h1></header><div class="page-body"><h2 id="d1cae430-2275-448a-bf32-6e48c1be2964" class=""><strong>Anti-Virtual Environments - Multiple Delay Execution Techniques</strong></h2><h3 id="ffe661b3-3071-4f5f-8df3-d4a3d7ef374a" class=""><strong>Introduction</strong></h3><p id="2104404c-cdf9-4abd-9a6f-69ea667c8adf" class="">Delay execution is a common technique utilized to bypass sandboxed environments. Sandboxes typically have time constraints that prevent them from analyzing a binary for a long duration. Therefore, malware can introduce long pauses in code execution that forces the sandbox to terminate before being able to analyze the binary.</p><p id="545ad2b2-5abe-4718-a412-1b869c45a7ec" class="">A sandbox with a two-minute analysis limit will not be able to analyze a payload if the malware sample executes a wait function for three minutes before decrypting and executing it.</p><p id="77c845a6-5567-4b83-ad1e-263f150b5309" class="">This module will introduce functions that can be used to delay the execution of the payload if a sandbox environment is detected.</p><h3 id="0b0b87f2-5abe-4fb2-9516-d981f6705003" class=""><strong>Detecting Fast-Forwards</strong></h3><p id="51353908-af0e-4fbb-84bd-b1b63f9f4239" class="">Several malware samples have taken advantage of delays in execution, so the majority of sandboxes have implemented mitigations to counter execution delays. Such mitigations may involve fast-forwarding the delay durations, either by changing the parameters passed through API hooking or via other approaches. Verifying that the delay has taken place is essential, and can be achieved using the WinAPI, <code>GetTickCount64</code>.</p><p id="2b83c22c-a977-4225-a2c2-41d1bca88e20" class="">The delay function then would look something like the following.</p><pre id="17331a23-fb60-45e5-b6ee-fc36e01725b2" class="code code-wrap"><code>BOOL DelayFunction(DWORD dwMilliSeconds){

  DWORD T0 = GetTickCount64();

  // The code needed to delay the execution for &#x27;dwMilliSeconds&#x27; ms

  DWORD T1 = GetTickCount64();

  // Slept for at least &#x27;dwMilliSeconds&#x27; ms, then &#x27;DelayFunction&#x27; succeeded
  if ((DWORD)(T1 - T0) &lt; dwMilliSeconds)
    return FALSE;
  else
    return TRUE;
}
</code></pre><h3 id="44c6a3e9-821b-498b-b7ac-c8e63c28059d" class=""><strong>Delaying Execution Via WaitForSingleObject</strong></h3><p id="07c20a80-695b-460a-a839-6bf50b0275f0" class="">The <code>WaitForSingleObject</code> WinAPI has been used throughout this course to wait for a specific object to be in a signaled state or for a time-out to occur. In this section, <code>WaitForSingleObject</code> will be used to wait for an empty event created using <code>CreateEvent</code>, meaning it will wait for a time-out to occur.</p><p id="4e614081-99d3-4373-b5ae-5bbe7d8c4480" class="">The <code>DelayExecutionVia_WFSO</code> function has one parameter, <code>ftMinutes</code>, that represents the time to delay the execution in minutes. The function returns <code>TRUE</code> if <code>WaitForSingleObject</code> succeeded in delaying the execution for the specified duration.</p><pre id="3b1c65f2-af58-45d6-b921-e1af3c4428e9" class="code code-wrap"><code>BOOL DelayExecutionVia_WFSO(FLOAT ftMinutes) {

  // converting minutes to milliseconds
  DWORD     dwMilliSeconds  = ftMinutes * 60000;
  HANDLE    hEvent          = CreateEvent(NULL, NULL, NULL, NULL);
  DWORD     _T0             = NULL,
            _T1             = NULL;


  _T0 = GetTickCount64();

  // Sleeping for &#x27;dwMilliSeconds&#x27; ms
  if (WaitForSingleObject(hEvent, dwMilliSeconds) == WAIT_FAILED) {
    printf(&quot;[!] WaitForSingleObject Failed With Error : %d \n&quot;, GetLastError());
    return FALSE;
  }

  _T1 = GetTickCount64();

  // Slept for at least &#x27;dwMilliSeconds&#x27; ms, then &#x27;DelayExecutionVia_WFSO&#x27; succeeded, otherwize it failed
  if ((DWORD)(_T1 - _T0) &lt; dwMilliSeconds)
    return FALSE;

  CloseHandle(hEvent);

  return TRUE;

}
</code></pre><h3 id="58dfeafb-ee1a-4e12-8984-8aea8cd452b0" class=""><strong>Delaying Execution Via MsgWaitForMultipleObjectsEx</strong></h3><p id="8761c42e-e866-4707-b271-4d94f8508196" class="">Another WinAPI that can be used for execution delays is the <code>MsgWaitForMultipleObjectsEx</code> WinAPI. It essentially fulfills that same task as <code>WaitForSingleObject</code> and was also demonstrated in previous modules.</p><p id="d4ef55f0-c7c2-4eb5-ad47-3559229862e2" class="">The <code>DelayExecutionVia_MWFMOEx</code> function uses the same logic shown in the previous section except here it utilizes the <code>MsgWaitForMultipleObjectsEx</code> WinAPI. The function has one parameter, <code>ftMinutes</code>, that represents the time to delay the execution in minutes. The function returns <code>TRUE</code> if <code>MsgWaitForMultipleObjectsEx</code> succeeded in delaying the execution for the specified duration.</p><pre id="ff2c84d3-b7bd-46fc-b2ac-925e052f8336" class="code code-wrap"><code>BOOL DelayExecutionVia_MWFMOEx(FLOAT ftMinutes) {

  // Converting minutes to milliseconds
  DWORD   dwMilliSeconds    = ftMinutes * 60000;
  HANDLE  hEvent            = CreateEvent(NULL, NULL, NULL, NULL);
  DWORD   _T0               = NULL,
          _T1               = NULL;


  _T0 = GetTickCount64();

  // Sleeping for &#x27;dwMilliSeconds&#x27; ms
  if (MsgWaitForMultipleObjectsEx(1, &amp;hEvent, dwMilliSeconds, QS_HOTKEY, NULL) == WAIT_FAILED) {
    printf(&quot;[!] MsgWaitForMultipleObjectsEx Failed With Error : %d \n&quot;, GetLastError());
    return FALSE;
  }

  _T1 = GetTickCount64();

  // Slept for at least &#x27;dwMilliSeconds&#x27; ms, then &#x27;DelayExecutionVia_MWFMOEx&#x27; succeeded, otherwize it failed
  if ((DWORD)(_T1 - _T0) &lt; dwMilliSeconds)
    return FALSE;

  CloseHandle(hEvent);

  return TRUE;
}
</code></pre><h3 id="13eb7f00-da19-4dae-bd2b-ceb4645e6b2b" class=""><strong>Delaying Execution Via NtWaitForSingleObject</strong></h3><p id="971db706-1ae9-4e82-a5ca-5b30b0c2e14b" class="">Code execution delays can also be done via the <a href="https://learn.microsoft.com/en-us/windows/win32/api/winternl/nf-winternl-ntwaitforsingleobject">NtWaitForSingleObject</a> syscall. <code>NtWaitForSingleObject</code> is the native API version of <code>WaitForSingleObject</code> and performs the same functionality. <code>NtWaitForSingleObject</code> is shown below.</p><pre id="0e08478f-b927-40bd-adaf-d3f3bd11ea78" class="code code-wrap"><code>NTSTATUS NtWaitForSingleObject(
  [in] HANDLE         Handle,       // Handle to the wait object
  [in] BOOLEAN        Alertable,    // Whether an alert can be delivered when the object is waiting
  [in] PLARGE_INTEGER Timeout       // Pointer to LARGE_INTEGER structure specifying time to wait for
);
</code></pre><p id="213fdd09-d07d-4586-817f-8765fc0adaeb" class="">The wait time for <code>NtWaitForSingleObject</code> is specified in 100-nanosecond negative intervals which are often referred to as <code>ticks</code>. A single tick is equivalent to 0.0001 milliseconds. The value passed to the syscall via the <code>Timeout</code> parameter should be the negative value of <code>dwMilliSeconds x 10000</code>, where <code>dwMilliSeconds</code> is the time to wait in milliseconds.</p><p id="08361317-c774-4b0d-bb80-b3d9b7d4bf3a" class="">The <code>DelayExecutionVia_NtWFSO</code> function below uses the <code>NtWaitForSingleObject</code> syscall to delay the execution for a given time specified by the <code>ftMinutes</code> parameter. <code>ftMinutes</code> represents the time to delay the execution in minutes. It returns <code>TRUE</code> if <code>NtWaitForSingleObject</code> succeeds in delaying the execution for the specified duration.</p><pre id="26ee94dd-0047-40df-b1ae-2552213bc23e" class="code code-wrap"><code>typedef NTSTATUS (NTAPI* fnNtWaitForSingleObject)(
	HANDLE         Handle,
	BOOLEAN        Alertable,
	PLARGE_INTEGER Timeout
);

BOOL DelayExecutionVia_NtWFSO(FLOAT ftMinutes) {

 	// Converting minutes to milliseconds
	DWORD                   dwMilliSeconds          = ftMinutes * 60000;
	HANDLE                  hEvent                  = CreateEvent(NULL, NULL, NULL, NULL);
	LONGLONG                Delay                   = NULL;
	NTSTATUS                STATUS                  = NULL;
	LARGE_INTEGER           DelayInterval           = { 0 };
	fnNtWaitForSingleObject pNtWaitForSingleObject  = (fnNtWaitForSingleObject)GetProcAddress(GetModuleHandle(L&quot;NTDLL.DLL&quot;), &quot;NtWaitForSingleObject&quot;);
	DWORD                   _T0                     = NULL,
	                        _T1                     = NULL;

  	// Converting from milliseconds to the 100-nanosecond - negative time interval
	Delay = dwMilliSeconds * 10000;
	DelayInterval.QuadPart = - Delay;

	_T0 = GetTickCount64();

  	// Sleeping for &#x27;dwMilliSeconds&#x27; ms
	if ((STATUS = pNtWaitForSingleObject(hEvent, FALSE, &amp;DelayInterval)) != 0x00 &amp;&amp; STATUS != STATUS_TIMEOUT) {
		printf(&quot;[!] NtWaitForSingleObject Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}

	_T1 = GetTickCount64();

  	// Slept for at least &#x27;dwMilliSeconds&#x27; ms, then &#x27;DelayExecutionVia_NtWFSO&#x27; succeeded
	if ((DWORD)(_T1 - _T0) &lt; dwMilliSeconds)
		return FALSE;

	CloseHandle(hEvent);

	return TRUE;
}
</code></pre><h3 id="6181cc0b-0fae-4c0b-b25a-f13ebd97b291" class=""><strong>Delaying Execution Via NtDelayExecution</strong></h3><p id="dc311bee-1bab-4d61-82b2-ae5eb18e1eed" class="">The last method in this module to delay execution is using the <a href="https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FNT%20Objects%2FThread%2FNtDelayExecution.html">NtDelayExecution</a> syscall. The name makes it obvious that the syscall is made for delaying the execution of code for synchronization. <code>NtDelayExecution</code> is similar to <code>NtWaitForSingleObject</code> with the exception that an object handle is not needed to wait on; its functionality is similar to <code>Sleep</code>, suspending the current code&#x27;s execution cycle. <code>NtDelayExecution</code> is shown below.</p><pre id="00fc9449-a0b4-4097-8054-20cafa9e23bc" class="code code-wrap"><code>NTSTATUS NtDelayExecution(
	IN BOOLEAN              Alertable,      // Whether an alert can be delivered when the object is waiting
	IN PLARGE_INTEGER       DelayInterval   // Pointer to LARGE_INTEGER structure specifying time to wait for
);
</code></pre><p id="36efdc1b-ecc4-4b54-9ce6-e02c2a1a145f" class=""><code>NtDelayExecution</code> uses ticks for its <code>DelayInterval</code> parameter.</p><p id="6dafbbbe-3a1a-41db-8e4e-962153e6137f" class="">The <code>DelayExecutionVia_NtDE</code> function below uses the <code>NtDelayExecution</code> syscall to delay execution for the given time <code>ftMinutes</code> which represents the time to wait for in minutes. It returns <code>TRUE</code> if <code>NtDelayExecution</code> succeeds in delaying the execution for the specified duration.</p><pre id="a3165d7a-2687-4032-a826-c99501f89b42" class="code code-wrap"><code>typedef NTSTATUS (NTAPI *fnNtDelayExecution)(
	BOOLEAN              Alertable,
	PLARGE_INTEGER       DelayInterval
);

BOOL DelayExecutionVia_NtDE(FLOAT ftMinutes) {

  	// Converting minutes to milliseconds
	DWORD               dwMilliSeconds        = ftMinutes * 60000;
	LARGE_INTEGER       DelayInterval         = { 0 };
	LONGLONG            Delay                 = NULL;
	NTSTATUS            STATUS                = NULL;
	fnNtDelayExecution  pNtDelayExecution     = (fnNtDelayExecution)GetProcAddress(GetModuleHandle(L&quot;NTDLL.DLL&quot;), &quot;NtDelayExecution&quot;);
	DWORD               _T0                   = NULL,
                        _T1                   = NULL;

  	// Converting from milliseconds to the 100-nanosecond - negative time interval
	Delay = dwMilliSeconds * 10000;
	DelayInterval.QuadPart = - Delay;

	_T0 = GetTickCount64();

	// Sleeping for &#x27;dwMilliSeconds&#x27; ms
	if ((STATUS = pNtDelayExecution(FALSE, &amp;DelayInterval)) != 0x00 &amp;&amp; STATUS != STATUS_TIMEOUT) {
		printf(&quot;[!] NtDelayExecution Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}

	_T1 = GetTickCount64();

    // Slept for at least &#x27;dwMilliSeconds&#x27; ms, then &#x27;DelayExecutionVia_NtDE&#x27; succeeded, otherwize it failed
	if ((DWORD)(_T1 - _T0) &lt; dwMilliSeconds)
		return FALSE;

	return TRUE;
}
</code></pre><h3 id="a070fcd3-4fcd-4fae-b2fc-640f050e82c2" class=""><strong>Demo</strong></h3><p id="837c7263-df01-4346-8457-5128abe32456" class="">The image below shows the techniques described in this module. The delay for execution is set to 6 seconds or 0.1 minute(s).</p><figure id="5bcb4310-582b-404d-89c3-b361bf7e943a" class="image"><a href="74%20Anti-Virtual%20Environments%20-%20Multiple%20Delay%20Exec%201a52c1ea94be40948ad1a4b786256621/delays-115710473-e0af0c25-7535-41ad-80a9-ac2be198e68f.png"><img style="width:1385px" src="74%20Anti-Virtual%20Environments%20-%20Multiple%20Delay%20Exec%201a52c1ea94be40948ad1a4b786256621/delays-115710473-e0af0c25-7535-41ad-80a9-ac2be198e68f.png"/></a></figure></div></article></body></html>