<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>57. IAT Hiding &amp; Obfuscation - Compile Time API Hashing</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="af3ce62d-28bb-4e0a-824b-7e3a42315d80" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/57"><strong>57. IAT Hiding &amp; Obfuscation - Compile Time API Hashing</strong></a></h1></header><div class="page-body"><h2 id="1459176d-66d0-45de-a022-2d7cc1a21a68" class=""><strong>IAT Hiding &amp; Obfuscation - Compile Time API Hashing</strong></h2><h3 id="d98233b1-70d3-4106-b4ac-6a96a71294dd" class=""><strong>Introduction</strong></h3><p id="883f259f-f0dc-4d2c-9a8d-5513359ebed5" class="">In the previous API Hashing module, the hashes of the functions and modules were generated before adding them to the code. Unfortunately, that can be highly time-consuming and can be avoided by using <em>Compile Time API Hashing</em>.</p><p id="c26755ed-157f-48f9-8524-3a67dc4467ee" class="">Furthermore, in the previous module hashes were hard coded which can allow security solutions to use them as IoC, if they are not updated in each implementation. With compile time API hashing, however, dynamic hashes are generated every time the binary is compiled.</p><h3 id="cdea63ec-b778-4897-a43a-d048c0f38b8f" class=""><strong>Caveat</strong></h3><p id="d613594f-204b-400c-872b-90482220c6e3" class="">This method only works with C++ projects due to the use of the <a href="https://en.cppreference.com/w/cpp/language/constexpr">constexpr</a> keyword. The <code>constexpr</code> operator in C++ is used to indicate that a function or variable can be evaluated at compile time. In addition, the <code>constexpr</code> operator on functions and variables improves the performance of an application by allowing the compiler to perform certain calculations at compile time rather than at runtime.</p><h3 id="50f55a69-c152-4d06-9d28-b901bbc2075f" class=""><strong>Compile Time Hashing Walkthrough</strong></h3><p id="0e348e9f-bed8-4551-abc3-fd96cb2db14d" class="">The sections below walk through the steps required to implement compile time hashing.</p><h3 id="cc28ec12-222c-4d88-9592-026979a49128" class=""><strong>Create Compile Time Functions</strong></h3><p id="2c1080b2-7958-41af-bcc0-42a2e4e5d708" class="">The first step is to convert the hashing functions that will be used to become compile time functions using the <code>constexpr</code> operator. In this case, the Dbj2 hashing algorithm will be modified to use the <code>constexpr</code> operator.</p><pre id="18b6009f-32ff-493b-bfa8-de21693fbf67" class="code code-wrap"><code>#define        SEED       5// Compile time Djb2 hashing function (WIDE)
constexpr DWORD HashStringDjb2W(const wchar_t* String) {
	ULONG Hash = (ULONG)g_KEY;
	INT c = 0;
	while ((c = *String++)) {
		Hash = ((Hash &lt;&lt; SEED) + Hash) + c;
	}

	return Hash;
}

// Compile time Djb2 hashing function (ASCII)
constexpr DWORD HashStringDjb2A(const char* String) {
	ULONG Hash = (ULONG)g_KEY;
	INT c = 0;
	while ((c = *String++)) {
		Hash = ((Hash &lt;&lt; SEED) + Hash) + c;
	}

	return Hash;
}
</code></pre><p id="6f32b248-cbb3-4259-8ac0-81165ad75a25" class="">The undefined variable, <code>g_KEY</code>, is used as the initial hash in both functions. <code>g_KEY</code> is a global <code>constexpr</code> variable and is randomly generated by a function named <code>RandomCompileTimeSeed</code> (explained below), on each compilation of the binary.</p><h3 id="4c4ff906-24c1-4c66-867e-43ec9bb91fff" class=""><strong>Generating a Random Seed Value</strong></h3><p id="7eca64f6-7760-4d1e-a606-0444d998a2b7" class=""><code>RandomCompileTimeSeed</code> is used to generate a random seed value based on the current time. It does this by extracting the digits from the <a href="https://www.cprogramming.com/reference/preprocessor/__TIME__.html#:~:text=__TIME__%20is%20a,moment%20a%20binary%20was%20built.&amp;text=You%20can%20also%20use%20the,to%20get%20the%20current%20date."><strong>TIME</strong></a> macro, which is a predefined macro in C++ that expands to the current time in the <code>HH:MM:SS</code> format. Then, the <code>RandomCompileTimeSeed</code> function multiplies each digit by a different random constant and adds them all together to produce a final seed value.</p><pre id="9bae12b8-532c-4e9b-b0b2-29f0bf8f005d" class="code code-wrap"><code>// Generate a random key at compile time which is used as the initial hash
constexpr int RandomCompileTimeSeed(void)
{
	return &#x27;0&#x27; * -40271 +
		__TIME__[7] * 1 +
		__TIME__[6] * 10 +
		__TIME__[4] * 60 +
		__TIME__[3] * 600 +
		__TIME__[1] * 3600 +
		__TIME__[0] * 36000;
};

// The compile time random seed
constexpr auto g_KEY = RandomCompileTimeSeed() % 0xFF;
</code></pre><h3 id="62db565b-6af7-440a-a56c-70bed7d27ece" class=""><strong>Creating Macros</strong></h3><p id="9b5b2c15-a5e2-46d2-bf88-dd560bdac24f" class="">Next, define two macros, <code>RTIME_HASHA</code> and <code>RTIME_HASHW</code>, to be used by the <code>GetProcAddressH</code> function during runtime to compare hashes. The macros should be defined as follows.</p><pre id="8f5d83df-2f10-499b-b4bf-bd8a235ff53a" class="code code-wrap"><code>#define RTIME_HASHA( API ) HashStringDjb2A((const char*) API)       // Calling HashStringDjb2A#define RTIME_HASHW( API ) HashStringDjb2W((const wchar_t*) API)    // Calling HashStringDjb2W</code></pre><p id="aa07806c-049f-4d3b-8295-70803822da69" class="">Once a random compile time hashing function is established, the next step is to declare compile time hash values in variables. To streamline the process, two macros will be implemented.</p><pre id="361f6281-1d28-40bf-9ad9-af1ac02e53d7" class="code code-wrap"><code>#define CTIME_HASHA( API ) constexpr auto API##_Rotr32A = HashStringDjb2A((const char*) #API);#define CTIME_HASHW( API ) constexpr auto API##_Rotr32W = HashStringDjb2W((const wchar_t*) L#API);</code></pre><h3 id="cabbb479-1826-40b9-8d76-49873452b263" class=""><strong>Stringizing Operator</strong></h3><p id="112024f4-1cd8-4f6a-bdfe-176f874e53c1" class="">The <code>#</code> symbol is known as the <em>stringizing operator</em>. It is used to convert a preprocessor macro parameter into a string literal.</p><p id="cb8eaaf8-cdd8-49db-807b-2c54a4784801" class="">For example, if the <code>CTIME_HASHA</code> macro is called with the argument <code>SomeFunction</code>, like <code>HASHA(SomeFunction)</code>, the <code>#API</code> expression would be replaced with the string literal <code>&quot;SomeFunction&quot;</code>.</p><h3 id="a1f877b2-af5e-48c4-971f-b2e396169beb" class=""><strong>Merging Operator</strong></h3><p id="3e849849-6f71-42a1-9372-86ac60b4fcd7" class="">The <code>##</code> operator is known as the <em>merging operator</em>. It is used to combine two preprocessor macros into a single macro. The <code>##</code> operator is used to combine the API parameter with the string <code>&quot;_Rotr32A&quot;</code> or <code>&quot;_Rotr32W&quot;</code>, respectively, to form the final name of the variable being defined.</p><p id="2f089b47-11c0-472d-b50e-4bfb86edf96c" class="">For example, if the <code>CTIME_HASHA</code> macro is called with the argument <code>SomeFunction</code>, like <code>HASHA(SomeFunction)</code>, the <code>##</code> operator would combine API with <code>&quot;_Rotr32A&quot;</code> to form the final variable name <code>SomeFunction_Rotr32A</code>.</p><h3 id="7ac25a7c-8d14-49d0-8e2e-2ce19da092e9" class=""><strong>Macro Expansion Demo</strong></h3><p id="4645b989-d508-4a20-aee4-9778ec0eaf73" class="">To better understand how the previous macros work, the image below shows an example using the <code>CTIME_HASHA</code> macro to create a hash for <code>MessageBoxA</code> by creating a variable called <code>MessageBoxA_Rotr32A</code> that will hold the compile time hash value.</p><figure id="2dfd8ce2-6bc0-4477-89aa-8b565e422db2" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-110127028-dfa23b5b-cc3a-430a-b792-23792ce51c5d.png"><img style="width:1205px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-110127028-dfa23b5b-cc3a-430a-b792-23792ce51c5d.png"/></a></figure><h3 id="b382a311-ccd5-42ef-8364-e708f5d2ce2b" class=""><strong>Compile Time Hashing - Code</strong></h3><p id="5c19762c-03db-4e72-a826-a7bd0d5a606a" class="">After putting all the pieces together, the code will be as shown below.</p><pre id="99feb8b0-7171-455c-af8b-14369dca486d" class="code code-wrap"><code>#include &lt;Windows.h&gt;#include &lt;stdio.h&gt;#include &lt;winternl.h&gt;#define        SEED       5// generate a random key (used as initial hash)
constexpr int RandomCompileTimeSeed(void)
{
	return &#x27;0&#x27; * -40271 +
		__TIME__[7] * 1 +
		__TIME__[6] * 10 +
		__TIME__[4] * 60 +
		__TIME__[3] * 600 +
		__TIME__[1] * 3600 +
		__TIME__[0] * 36000;
};

constexpr auto g_KEY = RandomCompileTimeSeed() % 0xFF;


// Compile time Djb2 hashing function (WIDE)
constexpr DWORD HashStringDjb2W(const wchar_t* String) {
	ULONG Hash = (ULONG)g_KEY;
	INT c = 0;
	while ((c = *String++)) {
		Hash = ((Hash &lt;&lt; SEED) + Hash) + c;
	}

	return Hash;
}

// Compile time Djb2 hashing function (ASCII)
constexpr DWORD HashStringDjb2A(const char* String) {
	ULONG Hash = (ULONG)g_KEY;
	INT c = 0;
	while ((c = *String++)) {
		Hash = ((Hash &lt;&lt; SEED) + Hash) + c;
	}

	return Hash;
}


// runtime hashing macros
#define RTIME_HASHA( API ) HashStringDjb2A((const char*) API)#define RTIME_HASHW( API ) HashStringDjb2W((const wchar_t*) API)// compile time hashing macros (used to create variables)
#define CTIME_HASHA( API ) constexpr auto API##_Rotr32A = HashStringDjb2A((const char*) #API);#define CTIME_HASHW( API ) constexpr auto API##_Rotr32W = HashStringDjb2W((const wchar_t*) L#API);


FARPROC GetProcAddressH(HMODULE hModule, DWORD dwApiNameHash) {

	PBYTE pBase = (PBYTE)hModule;

	PIMAGE_DOS_HEADER           pImgDosHdr        = (PIMAGE_DOS_HEADER)pBase;
	if (pImgDosHdr-&gt;e_magic != IMAGE_DOS_SIGNATURE)
		return NULL;

	PIMAGE_NT_HEADERS           pImgNtHdrs        = (PIMAGE_NT_HEADERS)(pBase + pImgDosHdr-&gt;e_lfanew);
	if (pImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return NULL;

	IMAGE_OPTIONAL_HEADER       ImgOptHdr         = pImgNtHdrs-&gt;OptionalHeader;

	PIMAGE_EXPORT_DIRECTORY     pImgExportDir     = (PIMAGE_EXPORT_DIRECTORY)(pBase + ImgOptHdr.DataDirectory[IMAGE_DIRECTORY_ENTRY_EXPORT].VirtualAddress);

	PDWORD      FunctionNameArray     = (PDWORD)(pBase + pImgExportDir-&gt;AddressOfNames);
	PDWORD      FunctionAddressArray  = (PDWORD)(pBase + pImgExportDir-&gt;AddressOfFunctions);
	PWORD       FunctionOrdinalArray  = (PWORD)(pBase + pImgExportDir-&gt;AddressOfNameOrdinals);

	for (DWORD i = 0; i &lt; pImgExportDir-&gt;NumberOfFunctions; i++) {
		CHAR*	pFunctionName       = (CHAR*)(pBase + FunctionNameArray[i]);
		PVOID	pFunctionAddress    = (PVOID)(pBase + FunctionAddressArray[FunctionOrdinalArray[i]]);

		if (dwApiNameHash == RTIME_HASHA(pFunctionName)) { // runtime hash value check
			return (FARPROC)pFunctionAddress;
		}
	}

	return NULL;
}
</code></pre><h3 id="b1fd579b-3ee6-4176-b65f-3e25f30ed0d3" class=""><strong>Demo</strong></h3><p id="da1a7a58-ba7a-4c84-a5d2-02790be5f066" class="">This demo calls <code>MessageBoxA</code> and <code>MessageBoxW</code> using compile time API hashing using the <code>MessageBoxA_Rotr32A</code> compile time variable.</p><figure id="85e1fdb3-7b2f-43a5-82ab-720c32174a8d" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-210127200-98154fdf-2810-472c-b3f8-6fa46605955b.png"><img style="width:1511px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-210127200-98154fdf-2810-472c-b3f8-6fa46605955b.png"/></a></figure><h3 id="48ea6d08-6c3a-4ddf-b7af-472f9614ec52" class=""><strong>Check for IoCs</strong></h3><p id="2febbf47-096e-4701-8db6-f21b4a2889c6" class="">Use the Sysinternal Strings tool to search for the &quot;MessageBox&quot;.</p><figure id="9c1c3eb8-c2b1-445d-af65-46329111db91" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-310127229-b041b0ac-e48e-4c12-88b5-cc39ce6e0d8e.png"><img style="width:1280px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-310127229-b041b0ac-e48e-4c12-88b5-cc39ce6e0d8e.png"/></a></figure><p id="ace04989-19cf-411f-a5df-e6b2edbb392e" class="">Use the Dumpbin tool to check the IAT for anything related to <code>MessageBox</code>.</p><figure id="93e21e27-31d1-492c-beee-ea9e8d225cf3" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-410127235-cfc37903-ef42-4ab6-8401-d1a20282a479.png"><img style="width:1356px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-410127235-cfc37903-ef42-4ab6-8401-d1a20282a479.png"/></a></figure><h3 id="1a4659ec-b16a-4ed9-833a-59de9cd61444" class=""><strong>Running The Binary</strong></h3><p id="d91fcb78-85bd-4d58-8ea8-d8fd05fb59b5" class="">Run the binary and see in fact <code>MessageBox</code> is being used.</p><figure id="47111c41-842b-47d8-8e02-228a8576b116" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-510127264-113b5309-cdbb-4d86-9c74-7e7a0b0c3918.png"><img style="width:1558px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-510127264-113b5309-cdbb-4d86-9c74-7e7a0b0c3918.png"/></a></figure><h3 id="cf204bb9-f262-4f98-9b8e-9fd5e01e2078" class=""><strong>Verify Dynamic Hash Value</strong></h3><p id="6e99a642-e31e-499a-8418-4c8920731a55" class="">Print the hash values to the console in order to verify it&#x27;s being modified every time the code is compiled.</p><figure id="41e7ec93-70d1-4f0a-a884-81faf46f1762" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-610127288-887779b6-b023-4a31-8bc7-e76018642b94.png"><img style="width:1303px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-610127288-887779b6-b023-4a31-8bc7-e76018642b94.png"/></a></figure><figure id="7789247b-2ca8-452b-a149-ab395777dee6" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-710127301-b4ad2456-74a9-4030-893a-d330d35dc25a.png"><img style="width:1383px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-710127301-b4ad2456-74a9-4030-893a-d330d35dc25a.png"/></a></figure><p id="f30b6013-36aa-4bd4-8dc9-52265c49318c" class="">Rebuild the Visual Studio Project, check the hash values again and notice that the hash values are different from the previous run.</p><figure id="720a8f44-9d53-4100-8df0-5b3782d6c632" class="image"><a href="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-810127330-fd9124e2-361c-463b-bc4e-7e5ea2dc65a7.png"><img style="width:1371px" src="57%20IAT%20Hiding%20&amp;%20Obfuscation%20-%20Compile%20Time%20API%20Has%20af3ce62d28bb4e0a824b7e3a42315d80/compile-time-hashing-810127330-fd9124e2-361c-463b-bc4e-7e5ea2dc65a7.png"/></a></figure></div></article></body></html>