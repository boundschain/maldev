<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>59. API Hooking - Detours Library</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="b06d3c8c-1d60-40d8-8647-2493a5084f2c" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/59"><strong>59. API Hooking - Detours Library</strong></a></h1></header><div class="page-body"><h2 id="3f49ca63-9f8a-4b3f-82d4-cc4f45acd180" class=""><strong>API Hooking - Detours Library</strong></h2><h3 id="6b0cadc5-9e60-44c9-8c22-d302a66923af" class=""><strong>Introduction</strong></h3><p id="5e164146-be78-44e9-ada8-63732aae0508" class="">The <a href="https://github.com/microsoft/Detours">Detours Hooking Library</a>, is a software library developed by Microsoft Research that allows for intercepting and redirecting function calls in Windows. The library redirect calls of specific functions to a user-defined replacement function that can then perform additional tasks or modify the behavior of the original function. Detours is typically used with C/C++ programs and can be used with both 32-bit and 64-bit applications.</p><p id="f9559095-abcd-48b6-944f-a9eaa621bec6" class="">The library&#x27;s wiki page is available <a href="https://github.com/microsoft/Detours/wiki/">here</a>.</p><h3 id="aaee6e35-3f2f-4de3-bf3e-21382faf6d53" class=""><strong>Transactions</strong></h3><p id="7d82441d-3542-477b-908d-cf948a179772" class="">The Detours library replaces the first few instructions of the target function, that is the function to be hooked, with an unconditional jump to the user-provided detour function, which is the function to be executed instead. The term unconditional jump is also referred to as trampoline.</p><p id="f4118df7-1d7a-442c-8c1a-c0aa95ad08c7" class="">The library uses <em>transactions</em> to install and uninstall hooks from a targeted function. Transactions allow hooking routines to group multiple function hooks together and apply them as a single unit, which can be beneficial when making multiple changes to a program&#x27;s behavior. It also provides the advantage of enabling the user to easily undo all changes if necessary. When using transactions, a new transaction can be started, function hooks added, and then committed. Upon committing the transaction, all function hooks added to the transaction will be applied to the program, as would be the case with unhooking.</p><h3 id="7eccd966-1f74-4829-a463-c1d7a220a7ea" class=""><strong>Using The Detours Library</strong></h3><p id="58369fea-48ec-4cc5-9717-64cdc9494dc0" class="">To use the Detours library&#x27;s functions, the Detours repository must be downloaded and compiled to get the static library files (.lib) files needed for the compilation. In addition to that the <a href="https://github.com/microsoft/Detours/blob/master/src/detours.h">detours.h</a> header file should be included, this is explained in the Detours wiki under the <a href="https://github.com/microsoft/Detours/wiki/Using-Detours">Using Detours</a> section.</p><p id="ed67c7f6-cecd-4401-ac56-a3ec618fa385" class="">For additional help adding .lib files to a project, review <a href="https://learn.microsoft.com/en-us/cpp/build/reference/dot-lib-files-as-linker-input?view=msvc-170">Microsoft&#x27;s documentation</a>.</p><h3 id="a267ceff-6943-4ef4-afd9-7bcb16a22226" class=""><strong>32-bit vs 64-bit Detours Library</strong></h3><p id="d38a2680-3c30-4dda-99d8-36b625339f0a" class="">The shared code in this module has preprocessor code that determines which version of the Detours <code>.lib</code> file to include, depending on the architecture of the machine being used. To do so, the <code>_M_X64</code> and <code>_M_IX86</code> macros are used. These macros are defined by the compiler to indicate whether the machine is running a 64-bit or 32-bit version of Windows. The preprocessor code looks like the following:</p><pre id="35e3f0e0-27ca-4632-84e1-c81016b29806" class="code code-wrap"><code>// If compiling as 64-bit
#ifdef _M_X64#pragma comment (lib, &quot;detoursx64.lib&quot;)#endif // _M_X64// If compiling as 32-bit
#ifdef _M_IX86#pragma comment (lib, &quot;detoursx86.lib&quot;)#endif // _M_IX86</code></pre><p id="af6962ef-c54d-4d0f-959f-cf7cf3905a97" class="">The <code>#ifdef _M_X64</code> checks if the macro <code>_M_X64</code> is defined, and if it is, the code following it will be included in the compilation. If it is not defined, the code will be ignored. Similarly, <code>#ifdef _M_IX86</code> checks if the macro <code>_M_IX86</code> is defined, and if it is, the code following it will be included in the compilation. The <code>#pragma comment (lib, &quot;detoursx64.lib&quot;)</code> is used to link the <em>detoursx64.lib</em> library during compilation for 64-bit systems, and <code>#pragma comment (lib, &quot;detoursx86.lib&quot;)</code> is used to link the <em>detoursx86.lib</em> library during compilation for 32-bit systems.</p><p id="fa2c228a-f09d-4148-84e8-6cc0ee05d49b" class="">Both <em>detoursx64.lib</em> and <em>detoursx86.lib</em> files are created when compiling the Detours library, <em>detoursx64.lib</em> is created when compiling the Detours library as a 64-bit project, likewise, the <em>detoursx86.lib</em> is created when compiling the Detours library as a 32-bit project.</p><h3 id="ee80d483-7019-4b3e-b697-0d63fea7c0c7" class=""><strong>Detours API Functions</strong></h3><p id="46813081-4b45-4d32-8ea7-84d64221da1f" class="">When using any hooking method, the first step is to always retrieve the address of the WinAPI function to hook. The function&#x27;s address is required to determine where the jump instructions will be placed. In this module, the <code>MessageBoxA</code> function will be utilized as a function to hook.</p><p id="ff171840-887d-4180-a0d0-bdf2ad325630" class="">Below are the API functions the Detours Library offers:</p><ul id="65e6e1df-e80b-4979-a214-4d428ed47ede" class="bulleted-list"><li style="list-style-type:disc"><a href="https://github.com/microsoft/Detours/wiki/DetourTransactionBegin">DetourTransactionBegin</a> - Begin a new transaction for attaching or detaching detours. This function should be called first when hooking and unhooking.</li></ul><ul id="4752e03f-c531-422a-8d6c-a542fb661120" class="bulleted-list"><li style="list-style-type:disc"><a href="https://github.com/microsoft/Detours/wiki/DetourUpdateThread">DetourUpdateThread</a> - Update the current transaction. This is used by Detours library to <em>Enlist</em> a thread in the current transaction.</li></ul><ul id="b6cc834c-21d7-483a-abd9-5bfd3fc90e0e" class="bulleted-list"><li style="list-style-type:disc"><a href="https://github.com/microsoft/Detours/wiki/DetourAttach">DetourAttach</a> - Install the hook on the target function in a current transaction. This won&#x27;t be committed until <code>DetourTransactionCommit</code> is called.</li></ul><ul id="6d3a6b27-499f-4004-b608-c241847607dd" class="bulleted-list"><li style="list-style-type:disc"><a href="https://github.com/microsoft/Detours/wiki/DetourDetach">DetourDetach</a> - Remove the hook from the targetted function in a current transaction. This won&#x27;t be committed until <code>DetourTransactionCommit</code> is called.</li></ul><ul id="24978ae5-992a-40e1-a9f7-73ddae96d78b" class="bulleted-list"><li style="list-style-type:disc"><a href="https://github.com/microsoft/Detours/wiki/DetourTransactionCommit">DetourTransactionCommit</a> - Commit the current transaction for attaching or detaching detours.</li></ul><p id="2b8c82af-3aac-4126-b1bf-092278b7cd06" class="">The functions above return a <code>LONG</code> value which is used to understand the result of the function&#x27;s execution. A Detours API will return <code>NO_ERROR</code>, which is a 0, if it succeeds and a non-zero value upon failure. The non-zero value can be used as an error code for debugging purposes.</p><h3 id="447707b5-0d64-4344-8e7e-a5f119658105" class=""><strong>Replacing The Hooked API</strong></h3><p id="3f2b5838-8904-41a6-b3e8-458c04806edb" class="">The next step is to create a function to replace the hooked API. The replacement function should be of the same data type, and optionally, take the same parameters. This allows for inspection or modification of the parameter values. For example, the following function can be used as a detour function for <code>MessageBoxA</code> which allows one to check the original parameter values.</p><pre id="5c68861f-2846-413f-8c38-c639ca6fcb3e" class="code code-wrap"><code>INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {
  // we can check hWnd - lpText - lpCaption - uType parametes
}
</code></pre><p id="a8298b1f-fab2-438f-a462-3005c4f239be" class="">It is worth noting that the replacement function can take fewer parameters, but can&#x27;t take more than the original function because then it would access an invalid address which will throw access violation exceptions.</p><h3 id="1845a813-986f-499f-a178-fe90d2f3d5ee" class=""><strong>The Infinite Loop Problem</strong></h3><p id="c486322a-ef35-4a75-8b31-413873ea0076" class="">When a hooked function is called and the hook is triggered, the custom function is executed, however, for the execution flow to continue, the custom function must return a valid value that the original hooked function was meant to return. A naive approach would be to return the same value by calling the original function inside of the hook. This can lead to problems as the replacement function will be called instead, resulting in an infinite loop. This is a general hooking issue and not a bug in the Detours library.</p><p id="ce9477e6-e7a0-49c8-9dde-a6a7ec8694ba" class="">In order to gain a better understanding of this, the code snippet below shows the replacement function, <code>MyMessageBoxA</code> calling <code>MessageBoxA</code>. This results in an infinite loop. The program will get stuck running <code>MyMessageBoxA</code>, that is because <code>MyMessageBoxA</code> is calling <code>MessageBoxA</code>, and <code>MessageBoxA</code> leads to the <code>MyMessageBoxA</code> function again.</p><pre id="6a477448-5c14-4b0d-b1f8-87764852cf07" class="code code-wrap"><code>INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {
  // Printing original parameters value
  printf(&quot;Original lpText Parameter	: %s\n&quot;, lpText);
  printf(&quot;Original lpCaption Parameter : %s\n&quot;, lpCaption);

  // DON&#x27;T DO THIS
  // Changing the parameters value
  return MessageBoxA(hWnd, &quot;different lpText&quot;, &quot;different lpCaption&quot;, uType); // Calling MessageBoxA (this is hooked)
}
</code></pre><h3 id="31e6f022-1ff0-4736-a303-dc479638df2d" class=""><strong>Solution 1 - Global Original Function Pointer</strong></h3><p id="183bbdf6-d808-43fe-a86f-9791998a4dbb" class="">The Detours library can resolve this issue by saving a pointer to the original function prior to hooking it. This pointer can be stored in a global variable and invoked instead of the hooked function within the detour function.</p><pre id="f9509b93-8661-4350-8bc6-8a1ef8ff750e" class="code code-wrap"><code>// Used as a unhooked MessageBoxA in `MyMessageBoxA`
fnMessageBoxA g_pMessageBoxA = MessageBoxA;

INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {
  // Printing original parameters value
  printf(&quot;Original lpText Parameter	: %s\n&quot;, lpText);
  printf(&quot;Original lpCaption Parameter : %s\n&quot;, lpCaption);

  // Changing the parameters value
  // Calling an unhooked MessageBoxA
  return g_pMessageBoxA(hWnd, &quot;different lpText&quot;, &quot;different lpCaption&quot;, uType);
}
</code></pre><h3 id="0b011857-8c83-4979-a34b-5ff585293809" class=""><strong>Solution 2 - Using a Different API</strong></h3><p id="422d9237-8cb2-43d4-a56b-240ce7f30568" class="">Another more general solution worth mentioning is calling a different <em>unhooked</em> function that has the same functionality as the hooked function. For example <code>MessageBoxA</code> and <code>MessageBoxW</code>, <code>VirtualAlloc</code> and <code>VirtualAllocEx</code>.</p><pre id="09591104-cdd9-45bb-8127-a0d555021682" class="code code-wrap"><code>INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {
  // Printing original parameters value
  printf(&quot;Original lpText Parameter	: %s\n&quot;, lpText);
  printf(&quot;Original lpCaption Parameter : %s\n&quot;, lpCaption);

  // Changing the parameters value
  return MessageBoxW(hWnd, L&quot;different lpText&quot;, L&quot;different lpCaption&quot;, uType);
}
</code></pre><h3 id="9d2eaaba-d1af-46e0-972b-86140acd27b5" class=""><strong>Detours Hooking Routine</strong></h3><p id="291519be-d686-4c8d-93e7-3f287a855ae7" class="">As previously explained, the Detours library works using transactions therefore to hook an API function, one must create a transaction, submit an action (hooking/unhooking) to the transaction, and then commit the transaction. The code snippet below performs these steps.</p><pre id="5454c17e-4637-4d39-b173-592a5cf3fc81" class="code code-wrap"><code>// Used as a unhooked MessageBoxA in `MyMessageBoxA`
// And used by `DetourAttach` &amp; `DetourDetach`
fnMessageBoxA g_pMessageBoxA = MessageBoxA;


// The function that will run instead MessageBoxA when hooked
INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {

	printf(&quot;[+] Original Parameters : \n&quot;);
	printf(&quot;\t - lpText	: %s\n&quot;, lpText);
	printf(&quot;\t - lpCaption	: %s\n&quot;, lpCaption);

	return g_pMessageBoxA(hWnd, &quot;different lpText&quot;, &quot;different lpCaption&quot;, uType);
}


BOOL InstallHook() {

	DWORD	dwDetoursErr = NULL;

  	// Creating the transaction &amp; updating it
	if ((dwDetoursErr = DetourTransactionBegin()) != NO_ERROR) {
		printf(&quot;[!] DetourTransactionBegin Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

	if ((dwDetoursErr = DetourUpdateThread(GetCurrentThread())) != NO_ERROR) {
		printf(&quot;[!] DetourUpdateThread Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

  	// Running MyMessageBoxA instead of g_pMessageBoxA that is MessageBoxA
	if ((dwDetoursErr = DetourAttach((PVOID)&amp;g_pMessageBoxA, MyMessageBoxA)) != NO_ERROR) {
		printf(&quot;[!] DetourAttach Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

  	// Actual hook installing happen after `DetourTransactionCommit` - commiting the transaction
	if ((dwDetoursErr = DetourTransactionCommit()) != NO_ERROR) {
		printf(&quot;[!] DetourTransactionCommit Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

	return TRUE;
}
</code></pre><h3 id="07b53d67-e056-46af-aa5e-6db5ae067e0e" class=""><strong>Detours Unhooking Routine</strong></h3><p id="77296f4d-3670-46c4-9fdb-a34892c63fa4" class="">The code snippet below shows the same routine as the previous section except this is for unhooking.</p><pre id="243b47ba-b5c5-4007-83b2-373d58508668" class="code code-wrap"><code>// Used as a unhooked MessageBoxA in `MyMessageBoxA`
// And used by `DetourAttach` &amp; `DetourDetach`
fnMessageBoxA g_pMessageBoxA = MessageBoxA;


// The function that will run instead MessageBoxA when hooked
INT WINAPI MyMessageBoxA(HWND hWnd, LPCSTR lpText, LPCSTR lpCaption, UINT uType) {

	printf(&quot;[+] Original Parameters : \n&quot;);
	printf(&quot;\t - lpText	: %s\n&quot;, lpText);
	printf(&quot;\t - lpCaption	: %s\n&quot;, lpCaption);

	return g_pMessageBoxA(hWnd, &quot;different lpText&quot;, &quot;different lpCaption&quot;, uType);
}


BOOL Unhook() {

	DWORD	dwDetoursErr = NULL;

  	// Creating the transaction &amp; updating it
	if ((dwDetoursErr = DetourTransactionBegin()) != NO_ERROR) {
		printf(&quot;[!] DetourTransactionBegin Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

	if ((dwDetoursErr = DetourUpdateThread(GetCurrentThread())) != NO_ERROR) {
		printf(&quot;[!] DetourUpdateThread Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

  	// Removing the hook from MessageBoxA
	if ((dwDetoursErr = DetourDetach((PVOID)&amp;g_pMessageBoxA, MyMessageBoxA)) != NO_ERROR) {
		printf(&quot;[!] DetourDetach Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

  	// Actual hook removal happen after `DetourTransactionCommit` - commiting the transaction
	if ((dwDetoursErr = DetourTransactionCommit()) != NO_ERROR) {
		printf(&quot;[!] DetourTransactionCommit Failed With Error : %d \n&quot;, dwDetoursErr);
		return FALSE;
	}

	return TRUE;
}

</code></pre><h3 id="de63d16b-33db-459b-a485-9fd492dd81c0" class=""><strong>The Main Function</strong></h3><p id="c527acec-6ab3-40b1-acda-9c9ee3d889fa" class="">The hooking and unhooking routines previously shown do not include a main function. The main function is shown below which simply invokes the unhooked and hooked versions of <code>MessageBoxA</code>.</p><pre id="c6aae593-f7af-4bff-b380-a7ad9c3ba411" class="code code-wrap"><code>int main() {

    // Will run - not hooked
	MessageBoxA(NULL, &quot;What Do You Think About Malware Development ?&quot;, &quot;Original MsgBox&quot;, MB_OK | MB_ICONQUESTION);


//------------------------------------------------------------------
    //  Hooking
	if (!InstallHook())
	    return -1;

//------------------------------------------------------------------
    // Won&#x27;t run - will run MyMessageBoxA instead
	MessageBoxA(NULL, &quot;Malware Development Is Bad&quot;, &quot;Original MsgBox&quot;, MB_OK | MB_ICONWARNING);


//------------------------------------------------------------------
    //  Unhooking
	if (!Unhook())
	    return -1;

//------------------------------------------------------------------
    //  Will run - hook removed
	MessageBoxA(NULL, &quot;Normal MsgBox Again&quot;, &quot;Original MsgBox&quot;, MB_OK | MB_ICONINFORMATION);

  	return 0;
}

</code></pre><h3 id="f0afe2ed-a14a-4140-a33b-6cf121d38c6a" class=""><strong>Demo</strong></h3><p id="baec56d3-bc25-445c-b3d8-e1ee9332b12f" class="">Running the first MessageBoxA (Unhooked)</p><p id="4c20ef34-c058-45c8-8d7a-161a2b0df465" class="">
</p><figure id="c66a6531-c451-40e8-852d-4e54714e1d67" class="image"><a href="59%20API%20Hooking%20-%20Detours%20Library%20b06d3c8c1d6040d886472493a5084f2c/detours-113692112-13168cc0-dd84-4b71-9c9a-c639b6bcd3e8.png"><img style="width:1409px" src="59%20API%20Hooking%20-%20Detours%20Library%20b06d3c8c1d6040d886472493a5084f2c/detours-113692112-13168cc0-dd84-4b71-9c9a-c639b6bcd3e8.png"/></a></figure><p id="8457b18d-acdc-4079-b58e-0f24baf8ed8b" class="">Running the second MessageBoxA (Hooked)</p><figure id="d26f43a0-5392-494f-8793-9ad21b9b78b4" class="image"><a href="59%20API%20Hooking%20-%20Detours%20Library%20b06d3c8c1d6040d886472493a5084f2c/detours-213692174-164b9d16-059a-4587-a4d2-3e264f3ac539.png"><img style="width:1449px" src="59%20API%20Hooking%20-%20Detours%20Library%20b06d3c8c1d6040d886472493a5084f2c/detours-213692174-164b9d16-059a-4587-a4d2-3e264f3ac539.png"/></a></figure><p id="ce618d8b-22af-4e85-af8b-f594fc5bfe82" class="">Running the third MessageBoxA (Unhooked)</p><figure id="6f0c3cf2-a2e9-488e-9e3e-f931e654c1ec" class="image"><a href="59%20API%20Hooking%20-%20Detours%20Library%20b06d3c8c1d6040d886472493a5084f2c/detours-313692221-be94d5d0-34a4-42a9-9545-a4934e5878ef.png"><img style="width:1370px" src="59%20API%20Hooking%20-%20Detours%20Library%20b06d3c8c1d6040d886472493a5084f2c/detours-313692221-be94d5d0-34a4-42a9-9545-a4934e5878ef.png"/></a></figure></div></article></body></html>