<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>61. API Hooking - Custom Code</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="7e6302f7-1fe9-4f67-8676-0d6f2b619236" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/61"><strong>61. API Hooking - Custom Code</strong></a></h1></header><div class="page-body"><h2 id="781b1bdf-3259-4e4e-8a4a-d0c9b81ce80a" class=""><strong>API Hooking - Custom Code</strong></h2><h3 id="491f3707-1aa7-4b23-bff5-e5dc6cdaff5e" class=""><strong>Introduction</strong></h3><p id="0f788631-a5c7-4c5d-94d2-6ba04cd29b7d" class="">So far, open source libraries have been used to implement API hooking. However, a major issue with this approach is that the source code for these libraries is publicly available, making it straightforward for security researchers and security product vendors to build IoCs. For this reason, API hooking will be implemented manually in this module, although not as sophisticated as the previously demonstrated libraries, but enough to achieve the desired result without IoCs.</p><p id="92ccbe1a-9116-41b1-b3ce-c5775b6196e4" class="">Custom hooking code can be a better option if the intent is to hook a single function. This avoids the additional effort of linking other libraries, and avoiding the additional weight these libraries add to the binary&#x27;s size.</p><h3 id="610dfb00-ffe1-437a-aed6-351bda99fe66" class=""><strong>Creating The Trampoline Shellcode</strong></h3><p id="e538bf57-4deb-4eda-9d31-d8f874412bc8" class="">One of the ways to hook a function is to overwrite its first few instructions with new ones. These new instructions are the trampoline which is responsible for altering the execution flow of the function to the replacement function. This trampoline is typically a small jump shellcode that executes a <code>jmp</code> instruction to the address of the function to be executed. To execute the <code>jmp</code> instruction, the address that needs to be jumped to must be saved inside of a register. In the presented example, the register will be <code>eax</code> on a 32-bit processor and <code>r10</code> on a 64-bit processor. A <code>mov</code> instruction will be used to save the address inside of these registers.</p><p id="329a5d59-d419-468d-adde-6ad3558066eb" class="">This is all that is needed for the trampoline, a <code>mov</code> and a <code>jmp</code> instruction. Diving deeper into how these instructions are used is not the focus of this module. If one would like to explore them further, <a href="https://www.felixcloutier.com/x86/mov">felixcloutier.com/x86/mov</a> and <a href="https://www.felixcloutier.com/x86/jmp">felixcloutier.com/x86/jmp</a> can provide more details.</p><h3 id="fd5121a1-b256-4296-b1ce-a90f1d4c7568" class=""><strong>64-bit Jump Shellcode</strong></h3><p id="69175f54-ac3c-4002-9216-b1f404039e5b" class="">The 64-bit jump shellcode should be as follows:</p><pre id="17907035-470c-4d36-9d3f-3a1ebeaec206" class="code code-wrap"><code>mov r10, pAddress
jmp r10
</code></pre><p id="fc7b0492-6391-4427-91f4-6777b3e3f79c" class="">Where <code>pAddres</code> is the address of the function to jump to (e.g. <code>0x0000FFFEC32A300</code>). To use these instructions in the code they must first be converted to <em>opcode</em>.</p><pre id="2994f062-88d2-453c-ae04-74144dc5e181" class="code code-wrap"><code>0x49, 0xBA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // mov r10, pAddress
0x41, 0xFF, 0xE2                                            // jmp r10
</code></pre><h3 id="c65f7ea8-5aee-4d8f-aeeb-46bc4f903f40" class=""><strong>32-bit Jump Shellcode</strong></h3><p id="4757a7c7-0c11-42ea-84fa-58989c4c4186" class="">And the 32-bit version:</p><pre id="b8d45f0d-ec39-4490-84e7-a41197459f66" class="code code-wrap"><code>mov eax, pAddress
jmp eax
</code></pre><p id="37f739e9-774f-497c-87d6-5b3490ada6e9" class="">Again, convert the instructions to opcode.</p><pre id="45b84c3c-5fac-444d-ade3-0af30c649897" class="code code-wrap"><code>0xB8, 0x00, 0x00, 0x00, 0x00,     // mov eax, pAddress
0xFF, 0xE0                        // jmp eax
</code></pre><p id="7d477374-afcb-43e1-9ff2-46f6a9ffb4fb" class="">Note that <code>pAddress</code> is represented as <code>NULL</code>, which explains the <code>0x00</code> sequence. These <code>0x00</code> opcodes are placeholders that will be overwritten during runtime.</p><h3 id="eb913512-2c6f-48a3-b86f-e56e2472c789" class=""><strong>Retrieving pAddress</strong></h3><p id="423341a7-606f-4acd-815a-b4cc3935eae6" class="">Since the hooks are installed during runtime, the <code>pAddress</code> value must be retrieved and added to the shellcode during runtime. The retrieval of the address can be done using <code>GetProcAddress</code> and once that&#x27;s completed, <code>memcpy</code> is used to copy the address to the correct location in the shellcode.</p><h3 id="f6fb3b7e-4517-49b0-ba8d-71f7c2edc408" class=""><strong>64-bit Patching</strong></h3><pre id="585558e0-af5d-4e0a-a74f-2d8e062d986e" class="code code-wrap"><code>uint8_t		uTrampoline[] = {
			0x49, 0xBA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // mov r10, pFunctionToRun
			0x41, 0xFF, 0xE2                                            // jmp r10
};

uint64_t uPatch = (uint64_t)pAddress;
memcpy(&amp;uTrampoline[2], &amp;uPatch, sizeof(uPatch)); // copying the address to the offset &#x27;2&#x27; in uTrampoline
</code></pre><h3 id="3703f01f-05ec-4861-a3d0-a9b807d0f4ce" class=""><strong>32-bit Patching</strong></h3><pre id="172319ef-6e29-477f-a885-b806ac022128" class="code code-wrap"><code>uint8_t		uTrampoline[] = {
	   0xB8, 0x00, 0x00, 0x00, 0x00,     // mov eax, pFunctionToRun
	   0xFF, 0xE0                        // jmp eax
};

uint32_t uPatch = (uint32_t)pAddress;
memcpy(&amp;uTrampoline[1], &amp;uPatch, sizeof(uPatch)); // copying the address to the offset &#x27;1&#x27; in uTrampoline
</code></pre><p id="d598e2f7-02de-454a-a827-2708db868a5b" class="">As previously mentioned, <code>pAddress</code> is the address of the function to jump to. The <code>uint32_t</code> and <code>uint64_t</code> data types are used to ensure that the address is the correct number of bytes, that is 4 bytes for 32-bit machines and 8 bytes for 64-bit machines. <code>uint32_t</code> is of size 4 bytes, and <code>uint64_t</code> is of size 8 bytes. <code>memcpy</code> will then place the address into the trampoline by overwriting the <code>0x00</code> placeholder bytes.</p><h3 id="9f504d51-7843-484e-b9ad-b198334b6dde" class=""><strong>Writing The Trampoline</strong></h3><p id="af24684d-3766-456d-930d-ca5afb4b690b" class="">Before overwriting the target function&#x27;s first few instructions with the prepared shellcode, it is important to mark the memory where the trampoline will be written as writable. In most cases, the memory region will not be writable, requiring the <code>VirtualProtect</code> WinAPI to change the memory permissions to <code>PAGE_EXECUTE_READWRITE</code>. It is worth noting that it must be writable and executable because when the program calls the function, it needs to execute instructions that will not be permitted on write-only memory.</p><p id="bf623ab2-d439-447f-b737-f77b45d08ecb" class="">With that in mind, the trampoline should first modify the permissions of the target function and then copy the shellcode over.</p><pre id="4754528b-5fb5-401e-b85b-7040f7793a0d" class="code code-wrap"><code>// Changing the memory permissons at &#x27;pFunctionToHook&#x27; to be PAGE_EXECUTE_READWRITE
if (!VirtualProtect(pFunctionToHook, sizeof(uTrampoline), PAGE_EXECUTE_READWRITE, &amp;dwOldProtection)) {
	return FALSE;
}

// Copying the trampoline shellcode to &#x27;pFunctionToHook&#x27;
memcpy(pFunctionToHook, uTrampoline, sizeof(uTrampoline));
</code></pre><p id="934c3fb4-6dcf-4b6d-a11b-2c3fb946c77d" class="">Where <code>pFunctionToHook</code> is the address of the function to hook, and <code>uTrampoline</code> is the jump shellcode.</p><h3 id="a5360356-c66e-4494-b248-ec07658a23cb" class=""><strong>Unhooking</strong></h3><p id="73cc09a5-5d83-49f1-8822-9d86a0e30841" class="">When the hooked function is called, the trampoline shellcode should be able to work for both 64-bit and 32-bit architectures. However, the unhooking of the hooked function has not been discussed. To do this, the original bytes which were overwritten by the trampoline should be restored by using a buffer containing these bytes that were created prior to the installation of the trampoline shellcode. This buffer should then be used as the source buffer in the <code>memcpy</code> function when unhooking the function.</p><pre id="c082c33b-1c47-4766-9107-cd8b5bf92323" class="code code-wrap"><code>memcpy(pFunctionToHook, pOriginalBytes, sizeof(pOriginalBytes));
</code></pre><p id="d23cf37d-7b31-4004-b1b9-2e824e5c0647" class="">Where <code>pFunctionToHook</code> is the address of the hooked function and <code>pOriginalBytes</code> is the buffer that&#x27;s holding the original bytes of the function which should have been saved before hooking, and can be done via a <code>memcpy</code> call. The size of the <code>pOriginalBytes</code> buffer should be the same as the trampoline shellcode size that way only the shellcode is overwritten. Lastly, it&#x27;s recommended to revert the memory permissions which can be done via the code snippet below.</p><pre id="e17bea3d-f4ee-4c2a-885b-4050952c4e5e" class="code code-wrap"><code>if (!VirtualProtect(pFunctionToHook, sizeof(uTrampoline), dwOldProtection, &amp;dwOldProtection)) {
	return FALSE;
}
</code></pre><p id="7b67a10c-151b-4589-987a-f993025a84f9" class="">Where <code>dwOldProtection</code> is the old memory permission returned by the first <code>VirtualProtect</code> call.</p><h3 id="218c9f6a-dc93-499a-a7cf-faf627e67ff7" class=""><strong>HookSt Structure</strong></h3><p id="ca9948cd-fd53-42da-bfe9-f471b5e25ab4" class="">To make the implementation easier, the <code>HookSt</code> structure was created. This structure will contain the needed information to hook and unhook a certain function. The value <code>TRAMPOLINE_SIZE</code> is set to <em>13</em> if the program is set to be compiled as a 64-bit application, and its set to <em>7</em> if the program is to be compiled in 32-bit mode. The values 13 and 7 are the sizes of the trampoline shellcode, denoted in the <code>uTrampoline</code> variable previously shown, in 64-bit and 32-bit systems, respectively.</p><pre id="0dee8054-034b-4ff6-afd6-1efc2de7843a" class="code code-wrap"><code>typedef struct _HookSt{

	PVOID	pFunctionToHook;                  // address of the function to hook
	PVOID	pFunctionToRun;                   // address of the function to run instead
	BYTE	pOriginalBytes[TRAMPOLINE_SIZE];  // buffer to keep some original bytes (needed for cleanup)
	DWORD	dwOldProtection;                  // holds the old memory protection of the &quot;function to hook&quot; address (needed for cleanup)

}HookSt, *PHookSt;
</code></pre><p id="88daa87b-ecb4-43ce-9994-a18cbcc2ff88" class="">Setting the <code>TRAMPOLINE_SIZE</code> value is done via the following preprocessor code</p><pre id="28fd6942-49a3-4279-ae36-4140bf69054a" class="code code-wrap"><code>// if compiling as 64-bit
#ifdef _M_X64#define TRAMPOLINE_SIZE		13#endif // _M_X64// if compiling as 32-bit
#ifdef _M_IX86#define TRAMPOLINE_SIZE		7#endif // _M_IX86</code></pre><h3 id="debcf73d-ee6a-4d4e-904a-b47727c465f0" class=""><strong>Installing Hooks</strong></h3><p id="d3ead95b-8c57-4a8f-b435-f866f2cad046" class="">The following function uses <code>HookSt</code> to install hooks.</p><pre id="0aef375e-0b45-4a40-a920-1b6b18c0620f" class="code code-wrap"><code>BOOL InstallHook (IN PHookSt Hook) {

#ifdef _M_X64// 64-bit trampoline
	uint8_t	uTrampoline [] = {
			0x49, 0xBA, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, // mov r10, pFunctionToRun
			0x41, 0xFF, 0xE2                                            // jmp r10
	};

	// Patching the shellcode with the address to jump to (pFunctionToRun)
	uint64_t uPatch = (uint64_t)(Hook-&gt;pFunctionToRun);
	// Copying the address of the function to jump to, to the offset &#x27;2&#x27; in uTrampoline
	memcpy(&amp;uTrampoline[2], &amp;uPatch, sizeof(uPatch));
#endif // _M_X64#ifdef _M_IX86// 32-bit trampoline
	uint8_t	uTrampoline[] = {
	   0xB8, 0x00, 0x00, 0x00, 0x00,     // mov eax, pFunctionToRun
	   0xFF, 0xE0                        // jmp eax
	};

	// Patching the shellcode with the address to jump to (pFunctionToRun)
	uint32_t uPatch = (uint32_t)(Hook-&gt;pFunctionToRun);
	// Copying the address of the function to jump to, to the offset &#x27;1&#x27; in uTrampoline
	memcpy(&amp;uTrampoline[1], &amp;uPatch, sizeof(uPatch));
#endif // _M_IX86


	// Placing the trampoline function - installing the hook
	memcpy(Hook-&gt;pFunctionToHook, uTrampoline, sizeof(uTrampoline));

	return TRUE;
}

</code></pre><h3 id="a4c92389-805b-477b-9a3f-19151c8dd194" class=""><strong>Removing Hooks</strong></h3><p id="abd2fd34-ecd0-4171-a9bf-c9aafe012a6f" class="">The function below uses <code>HookSt</code> to remove hooks.</p><pre id="bd782f05-a532-4053-b83a-f4e4f2035b58" class="code code-wrap"><code>BOOL RemoveHook (IN PHookSt Hook) {

	DWORD	dwOldProtection		= NULL;

	// Copying the original bytes over
	memcpy(Hook-&gt;pFunctionToHook, Hook-&gt;pOriginalBytes, TRAMPOLINE_SIZE);
	// Cleaning up our buffer
	memset(Hook-&gt;pOriginalBytes, &#x27;\0&#x27;, TRAMPOLINE_SIZE);
	// Setting the old memory protection back to what it was before hooking
	if (!VirtualProtect(Hook-&gt;pFunctionToHook, TRAMPOLINE_SIZE, Hook-&gt;dwOldProtection, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	// Setting all to null
	Hook-&gt;pFunctionToHook   = NULL;
	Hook-&gt;pFunctionToRun    = NULL;
	Hook-&gt;dwOldProtection   = NULL;

	return TRUE;
}

</code></pre><h3 id="372fbdeb-6717-454d-9119-ed956631bb7b" class=""><strong>Populating The HookSt Structure</strong></h3><p id="5b1841f2-3a70-4f24-a49f-5d6d3fdf4469" class="">The <code>InitializeHookStruct</code> function is used to populate the <code>HookSt</code> structure with the necessary information to perform hooking.</p><pre id="958f00c0-6a5b-43db-a7ad-659c59a9ad0b" class="code code-wrap"><code>BOOL InitializeHookStruct(IN PVOID pFunctionToHook, IN PVOID pFunctionToRun, OUT PHookSt Hook) {

	// Filling up the struct
	Hook-&gt;pFunctionToHook   = pFunctionToHook;
	Hook-&gt;pFunctionToRun    = pFunctionToRun;

	// Save original bytes of the same size that we will overwrite (that is TRAMPOLINE_SIZE)
	// This is done to be able to do cleanups when done
	memcpy(Hook-&gt;pOriginalBytes, pFunctionToHook, TRAMPOLINE_SIZE);

	// Changing the protection to RWX so that we can modify the bytes
	// We are saving the old protection to the struct (to re-place it at cleanup)
	if (!VirtualProtect(pFunctionToHook, TRAMPOLINE_SIZE, PAGE_EXECUTE_READWRITE, &amp;Hook-&gt;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	return TRUE;
}
</code></pre><h3 id="fecff805-1c14-4fe0-9922-52db71d79f52" class=""><strong>The Main function</strong></h3><p id="3888e390-86db-4700-8000-12038986672d" class="">The main function below calls the previously demonstrated functions and hooks the <code>MessageBoxA</code> WinAPI.</p><pre id="0b9fb742-1a63-4821-839b-bdecea40b56c" class="code code-wrap"><code>int main() {

	// Initializing the structure (needed before installing/removing the hook)
	HookSt st = { 0 };

	if (!InitializeHookStruct(&amp;MessageBoxA, &amp;MyMessageBoxA, &amp;st)) {
		return -1;
	}

	// will run
	MessageBoxA(NULL, &quot;What Do You Think About Malware Development ?&quot;, &quot;Original MsgBox&quot;, MB_OK | MB_ICONQUESTION);

	//  hooking
	if (!InstallHook(&amp;st)) {
		return -1;
	}

	//  wont run - hooked
	MessageBoxA(NULL, &quot;Malware Development Is Bad&quot;, &quot;Original MsgBox&quot;, MB_OK | MB_ICONWARNING);


	//  unhooking
	if (!RemoveHook(&amp;st)) {
		return -1;
	}


	//  will run - hook disabled
	MessageBoxA(NULL, &quot;Normal MsgBox Again&quot;, &quot;Original MsgBox&quot;, MB_OK | MB_ICONINFORMATION);


	return 0;
}
</code></pre><h3 id="f747cbdd-45f9-4ac1-a594-041cfb738758" class=""><strong>Demo</strong></h3><p id="dd07b625-9c72-4581-84b2-590b1405eb5c" class="">Due to the trampoline-based hook, it is impossible to have a global original function pointer be called to resume execution. Therefore, the <code>MessageBoxW</code> WinAPI will be called in the <code>MyMessageBoxA</code> detour function.</p><p id="8c36fbc0-2214-400a-90d8-83c451a4aea5" class="">Running the first <code>MessageBoxA</code> (Unhooked).</p><figure id="b7e1a10c-d9a4-452a-926a-b94e6451cb20" class="image"><a href="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-113731211-c0c71ee9-93b5-4e56-811e-b9595193062f.png"><img style="width:1636px" src="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-113731211-c0c71ee9-93b5-4e56-811e-b9595193062f.png"/></a></figure><p id="f99ab2de-792d-43aa-bbc1-9d92db0ff403" class="">The original <code>MessageBoxA</code> instructions before hooking.</p><figure id="3b041527-3d94-4a08-8753-e158c417d5ca" class="image"><a href="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-213732622-0d251a96-90b6-43fa-ae02-6bc14b0b6c3e.png"><img style="width:1111px" src="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-213732622-0d251a96-90b6-43fa-ae02-6bc14b0b6c3e.png"/></a></figure><p id="0b8c9141-19aa-4e66-9ba2-32fa9ffd39a5" class="">Running the second <code>MessageBoxA</code> (Hooked).</p><figure id="90221743-7da4-4614-97df-002e6bdbaf10" class="image"><a href="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-313731997-b35bff75-14b3-4b32-96d7-913132055062.png"><img style="width:1633px" src="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-313731997-b35bff75-14b3-4b32-96d7-913132055062.png"/></a></figure><p id="eac72760-bf6e-4e06-ba3c-7247c4ca101c" class="">The trampoline shellcode is in memory.</p><figure id="b6594a12-251a-4d6f-b7a3-439bd9a3cde8" class="image"><a href="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-413732637-5e2985c7-2bda-4e75-98c4-9ea6e8c1798b.png"><img style="width:1374px" src="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-413732637-5e2985c7-2bda-4e75-98c4-9ea6e8c1798b.png"/></a></figure><p id="3d58c3a8-d4b4-4ace-bf89-ffd1efb666d7" class="">Running the third <code>MessageBoxA</code> (Unhooked).</p><figure id="1c84d169-4111-4f50-b168-c418cc4581d9" class="image"><a href="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-513732042-e95b475c-72ed-4797-b8e5-4d7cb545f209.png"><img style="width:1522px" src="61%20API%20Hooking%20-%20Custom%20Code%207e6302f71fe94f6786760d6f2b619236/custom-trampoline-513732042-e95b475c-72ed-4797-b8e5-4d7cb545f209.png"/></a></figure></div></article></body></html>