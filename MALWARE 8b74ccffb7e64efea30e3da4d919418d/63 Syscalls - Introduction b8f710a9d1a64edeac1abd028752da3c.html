<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>63. Syscalls - Introduction</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="b8f710a9-d1a6-4ede-ac1a-bd028752da3c" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/63"><strong>63. Syscalls - Introduction</strong></a></h1></header><div class="page-body"><h2 id="03774e6e-bfd0-4457-8615-cdcb5e8c8372" class=""><strong>Syscalls - Introduction</strong></h2><h3 id="d25eac15-7ead-4ae6-9d01-9d6380808b6c" class=""><strong>What Are Syscalls</strong></h3><p id="ba89aaa1-04e8-4d70-8862-c26f6b87ef94" class="">Windows system calls or syscalls serve as an interface for programs to interact with the system, enabling them to request specific services such as reading or writing to a file, creating a new process, or allocating memory. Recall from the introductory modules that syscalls are the APIs that carry out the actions when a WinAPI function is called. For example, the <code>NtAllocateVirtualMemory</code> syscall is triggered when either <code>VirtualAlloc</code> or <code>VirtualAllocEx</code> WinAPIs functions are called. This syscall then moves the parameters provided by the user in the previous function call to the Windows kernel, carries out the requested action and returns the result to the program.</p><p id="b7065ecc-1fc0-4f06-be62-b3b013b6203a" class="">All syscalls return an <a href="https://learn.microsoft.com/en-us/openspecs/windows_protocols/ms-erref/596a1078-e883-4972-9bbc-49e60bebca55">NTSTATUS Value</a> that indicates the error code. <code>STATUS_SUCCESS</code> (zero) is returned if the syscall succeeds in performing the operation.</p><p id="8ca4f105-a5ba-40fa-b95d-f29d4eb6b3b6" class="">The majority of syscalls are not documented by Microsoft, therefore the syscall modules will reference the documentation shown below.</p><ul id="6bc2d86a-105c-4160-8be8-2ac765abb36a" class="bulleted-list"><li style="list-style-type:disc"><a href="http://undocumented.ntinternals.net/">Undocumented NTinternals</a></li></ul><ul id="9a03118c-c489-4a56-8437-4e31003a8e92" class="bulleted-list"><li style="list-style-type:disc"><a href="https://doxygen.reactos.org/dir_a7ad942ac829d916497d820c4a26c555.html">ReactOS&#x27;s NTDLL Reference</a></li></ul><h3 id="7313c3f7-da53-40fb-b2e0-30d72617e08b" class=""><strong>NTDLL &amp; Syscalls</strong></h3><p id="b17c21e0-476f-407b-84ab-a10e87974f30" class="">The majority of syscalls are exported from the <code>ntdll.dll</code> DLL.</p><h3 id="75040c35-8890-45ea-85f1-402f0c8f0b67" class=""><strong>Why Use Syscalls</strong></h3><p id="f778ebd2-8cf2-47a0-95c8-058ce0b92ebb" class="">Using system calls provides low-level access to the operating system, which can be advantageous for executing actions that are not available or more complex to accomplish with standard WinAPIs. For example, the <code>NtCreateUserProcess</code> syscall provides additional options when creating processes that <code>CreateProcess</code> WinAPI can&#x27;t.</p><p id="5d4a704e-331f-458a-aa36-ce6ec7b7debb" class="">Additionally, syscalls can be used for evading host-based security solutions which will be discussed in upcoming modules.</p><h3 id="29ada4e0-5add-4cf1-ab67-e900bbe83ee6" class=""><strong>Zw vs Nt Syscalls</strong></h3><p id="603a73ed-742a-461b-b56f-27ff14f4d813" class="">There are two types of syscalls, ones that start with <code>Nt</code> and others with <code>Zw</code>.</p><p id="7129da3e-bcb7-4bba-ba71-f1b9ab2a1569" class="">NT syscalls are the primary interface for user-mode programs. These are the system calls that are typically used by most Windows programs.</p><p id="3b877dfb-ab54-4b2b-8708-cb6b066cee29" class=""><code>Zw</code> syscalls on the other hand are a low-level, kernel-mode interface to the operating system. They are typically used by device drivers and other kernel-mode code that needs direct access to the operating system&#x27;s functionality.</p><p id="bfa07ae5-0e57-48dc-850e-7dba72f16c61" class="">To summarize, <code>Zw</code> syscalls are used in kernel mode in device driver development, whereas the <code>Nt</code> system calls are executed from user-mode programs. Although it is possible to use both from user mode programs and still achieve the same result. This can be noticed in the below images, where both the <code>Zw</code> and <code>Nt</code> versions of the same syscall share the same function address.</p><figure id="e8194493-64c2-4df1-836b-c9e7ab783a6b" class="image"><a href="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscalls-intro-213904491-110e794d-616f-4239-8a0a-96c2d2be77df.png"><img style="width:659px" src="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscalls-intro-213904491-110e794d-616f-4239-8a0a-96c2d2be77df.png"/></a></figure><p id="fa3ceee9-86db-48be-9554-72757f65087c" class="">For the sake of simplicity in this course, only <code>Nt</code> system calls will be used.</p><h3 id="4e1d6d2d-9a62-48be-b717-ea1cd8f5647b" class=""><strong>Syscall Service Number</strong></h3><p id="8300aef9-f51b-41b7-ba24-120635f2ba00" class="">Every syscall has a special syscall number, which is known as <em>System Service Number</em> or <em>SSN</em>. These syscall numbers are what the kernel uses to distinguish syscalls from each other. For example, the <code>NtAllocateVirtualMemory</code> syscall will have an SSN of 24 whereas <code>NtProtectVirtualMemory</code> will have an SSN of 80, these numbers are what the kernel uses to differentiate <code>NtAllocateVirtualMemory</code> from <code>NtProtectVirtualMemory</code>.</p><h3 id="d611b971-225c-4db0-a9d0-a263b0cf6cd4" class=""><strong>Differing SSNs By OS</strong></h3><p id="965a9650-2a35-43e0-9dc5-6da11e902df6" class="">It is important to be aware that SSNs will differ depending on the OS (e.g. Windows 10 vs 11) and within the version itself (e.g. Windows 11 21h2 vs Windows 11 22h2). Using the same example mentioned above, <code>NtAllocateVirtualMemory</code> may have an SSN of 24 on one version of Windows whereas on another version it will be 34. The same would apply to <code>NtProtectVirtualMemory</code> as well as the rest of the syscalls.</p><h3 id="9ef74f46-f796-471f-ad49-d453f6f65d29" class=""><strong>Syscalls In Memory</strong></h3><p id="450d1cea-f3b4-4cc1-b48b-08d834c2164d" class="">Within a machine, SSNs are not completely arbitrary and have a relation to one another. Each syscall number in memory is equal to the previous SSN + 1. For example, the SSN of syscall B is equal to the SSN of syscall A plus one. This is also true when approaching the syscall from the other end, where the SSN of syscall C will be that of syscall D minus one.</p><p id="844b5022-378a-48a4-a81d-546c5d6b8ba6" class="">This relation is shown in the following image where the SSN of <code>ZwAxxessCheck</code> is 0 and the SSN of the next syscall, <code>NtWorkerFactoryWorkerReady</code> is 1 and so on.</p><figure id="b6a30c5c-f7bb-4ad5-98d8-b15b8162ce68" class="image"><a href="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscall-intro-221095509-588e2694-4323-4de4-a929-01a0fc209ff0.png"><img style="width:1134px" src="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscall-intro-221095509-588e2694-4323-4de4-a929-01a0fc209ff0.png"/></a></figure><p id="5b103694-232c-4450-adcb-b6809d6b2b68" class="">Understanding that the syscalls have a relation to one another will come in handy for evasion purposes in upcoming syscall modules.</p><h3 id="eb75f201-2350-4b4b-a81d-a1ba2794d6f9" class=""><strong>Syscall Structure</strong></h3><p id="438e6cd8-0e72-4e7f-a077-c0ef248a1b4f" class="">The syscall structure is generally the same and will look like the snippet shown below.</p><pre id="a8fc3c52-733c-472e-b376-b522d3da54e9" class="code code-wrap"><code>mov r10, rcx
mov eax, SSN
syscall
</code></pre><p id="3460e7ce-a468-453f-9132-cdfe2322dce4" class="">For example, <code>NtAllocateVirtualMemory</code> on a 64-bit system is shown below.</p><figure id="611200f8-a843-411b-9a30-b6aca2ca774a" class="image"><a href="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscalls-intro-313903469-08ed9596-55bd-4c09-b39b-dc1f8e169d49.png"><img style="width:1419px" src="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscalls-intro-313903469-08ed9596-55bd-4c09-b39b-dc1f8e169d49.png"/></a></figure><p id="5734c414-fccb-4cf0-9d3c-07750408875b" class="">And <code>NtProtectVirtualMemory</code> is shown below.</p><figure id="6e6439bf-7f8c-47d5-996b-f8b96948de53" class="image"><a href="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscalls-intro-413903414-69957a37-e317-4913-aa29-d9720b6f9eb4.png"><img style="width:1404px" src="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscalls-intro-413903414-69957a37-e317-4913-aa29-d9720b6f9eb4.png"/></a></figure><h3 id="28a34c86-af94-478f-9ad0-31451a3d1ef2" class=""><strong>Syscall Instructions Explained</strong></h3><p id="c59d3e50-73a5-4f21-8bb1-9cc904cd1019" class="">The first line of the syscall moves the first parameter value, saved in <code>RCX</code>, to the <code>R10</code> register. Subsequently, the SSN of the syscall is moved to the <code>EAX</code> register. Finally, the special <code>syscall</code> instruction is executed.</p><p id="eb9b8a6b-f400-4e09-bcf5-9aeb8dab5f1f" class="">The <code>syscall</code> instruction on 64-bit systems or <code>sysenter</code> on 32-bit systems, are the instructions that initiate the system call. Executing the <code>syscall</code> instruction will cause the program to transfer control from user mode to kernel mode. The kernel will then perform the requested action and return control to the user mode program when completed.</p><h3 id="61fc89fb-fa02-4aaf-aa0f-bece5c3edf09" class=""><strong>Test &amp; Jne Instructions</strong></h3><p id="80669cab-e680-4a05-8fd1-6262357f60a5" class="">The <code>test</code> and <code>jne</code> instructions are for <a href="https://learn.microsoft.com/en-us/windows/win32/winprog64/wow64-implementation-details">WoW64</a> purposes which are meant to allow 32-bit processes to run on a 64-bit machine. These instructions do not affect the execution flow when the process is a 64-bit process.</p><h3 id="35be5f01-394f-4a3f-a335-704a367b8a0e" class=""><strong>Not All NtAPIs Are Syscalls</strong></h3><p id="3d662ee6-8bd2-4e6f-9fda-8d1b0c64cc19" class="">It is important to note that while some NtAPIs return <code>NTSTATUS</code>, they are not necessarily syscalls. These NtAPIs may instead be lower-level functions that are used by WinAPIs or syscalls. The reason why certain NtAPIs are not classified as syscalls is due to their non-compliance with the structure of a syscall, such as not having a syscall number or the lack of the usual <code>mov r10, rcx</code> instruction at the start. An example of NtAPIs that are not syscalls is shown below.</p><ul id="fa7ce34a-a836-48cb-a7ae-bb8ec7a6edb0" class="bulleted-list"><li style="list-style-type:disc"><code>LdrLoadDll</code> - This is used by the <code>LoadLibrary</code> WinAPI to load an image to the calling process.</li></ul><ul id="96deebe7-0c0d-4f7f-8114-36fc5ded0a0d" class="bulleted-list"><li style="list-style-type:disc"><code>SystemFunction032</code> and <code>SystemFunction033</code> - These NtAPIs were introduced earlier and perform RC4 encryption/decryption operations.</li></ul><ul id="a73e4086-7dc7-4f05-a712-3d5732543fcd" class="bulleted-list"><li style="list-style-type:disc"><code>RtlCreateProcessParametersEx</code> - This is used by the <code>CreateProcess</code> WinAPI to create arguments of a process.</li></ul><h3 id="cea7b7fa-01ba-4644-853f-66b04e99ba21" class=""><strong>LdrLoadDll</strong></h3><p id="d7bd6310-a99b-431e-abca-ca4a85eba656" class=""><code>LdrLoadDll</code>&#x27;s instructions are shown below. Notice how it does not follow the typical syscall structure.</p><figure id="474b51f8-284f-4dca-be29-b02bec60df17" class="image"><a href="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscall-intro-321109035-b09edb7e-5ecb-4c6f-96d5-de081603d047.png"><img style="width:1523px" src="63%20Syscalls%20-%20Introduction%20b8f710a9d1a64edeac1abd028752da3c/syscall-intro-321109035-b09edb7e-5ecb-4c6f-96d5-de081603d047.png"/></a></figure></div></article></body></html>