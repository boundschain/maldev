<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf-8"/><title>15. Payload Placement - .rsrc Section</title><style>
/* cspell:disable-file */
/* webkit printing magic: print all background colors */
html {
	-webkit-print-color-adjust: exact;
}
* {
	box-sizing: border-box;
	-webkit-print-color-adjust: exact;
}

html,
body {
	margin: 0;
	padding: 0;
}
@media only screen {
	body {
		margin: 2em auto;
		max-width: 900px;
		color: rgb(55, 53, 47);
	}
}

body {
	line-height: 1.5;
	white-space: pre-wrap;
}

a,
a.visited {
	color: inherit;
	text-decoration: underline;
}

.pdf-relative-link-path {
	font-size: 80%;
	color: #444;
}

h1,
h2,
h3 {
	letter-spacing: -0.01em;
	line-height: 1.2;
	font-weight: 600;
	margin-bottom: 0;
}

.page-title {
	font-size: 2.5rem;
	font-weight: 700;
	margin-top: 0;
	margin-bottom: 0.75em;
}

h1 {
	font-size: 1.875rem;
	margin-top: 1.875rem;
}

h2 {
	font-size: 1.5rem;
	margin-top: 1.5rem;
}

h3 {
	font-size: 1.25rem;
	margin-top: 1.25rem;
}

.source {
	border: 1px solid #ddd;
	border-radius: 3px;
	padding: 1.5em;
	word-break: break-all;
}

.callout {
	border-radius: 3px;
	padding: 1rem;
}

figure {
	margin: 1.25em 0;
	page-break-inside: avoid;
}

figcaption {
	opacity: 0.5;
	font-size: 85%;
	margin-top: 0.5em;
}

mark {
	background-color: transparent;
}

.indented {
	padding-left: 1.5em;
}

hr {
	background: transparent;
	display: block;
	width: 100%;
	height: 1px;
	visibility: visible;
	border: none;
	border-bottom: 1px solid rgba(55, 53, 47, 0.09);
}

img {
	max-width: 100%;
}

@media only print {
	img {
		max-height: 100vh;
		object-fit: contain;
	}
}

@page {
	margin: 1in;
}

.collection-content {
	font-size: 0.875rem;
}

.column-list {
	display: flex;
	justify-content: space-between;
}

.column {
	padding: 0 1em;
}

.column:first-child {
	padding-left: 0;
}

.column:last-child {
	padding-right: 0;
}

.table_of_contents-item {
	display: block;
	font-size: 0.875rem;
	line-height: 1.3;
	padding: 0.125rem;
}

.table_of_contents-indent-1 {
	margin-left: 1.5rem;
}

.table_of_contents-indent-2 {
	margin-left: 3rem;
}

.table_of_contents-indent-3 {
	margin-left: 4.5rem;
}

.table_of_contents-link {
	text-decoration: none;
	opacity: 0.7;
	border-bottom: 1px solid rgba(55, 53, 47, 0.18);
}

table,
th,
td {
	border: 1px solid rgba(55, 53, 47, 0.09);
	border-collapse: collapse;
}

table {
	border-left: none;
	border-right: none;
}

th,
td {
	font-weight: normal;
	padding: 0.25em 0.5em;
	line-height: 1.5;
	min-height: 1.5em;
	text-align: left;
}

th {
	color: rgba(55, 53, 47, 0.6);
}

ol,
ul {
	margin: 0;
	margin-block-start: 0.6em;
	margin-block-end: 0.6em;
}

li > ol:first-child,
li > ul:first-child {
	margin-block-start: 0.6em;
}

ul > li {
	list-style: disc;
}

ul.to-do-list {
	padding-inline-start: 0;
}

ul.to-do-list > li {
	list-style: none;
}

.to-do-children-checked {
	text-decoration: line-through;
	opacity: 0.375;
}

ul.toggle > li {
	list-style: none;
}

ul {
	padding-inline-start: 1.7em;
}

ul > li {
	padding-left: 0.1em;
}

ol {
	padding-inline-start: 1.6em;
}

ol > li {
	padding-left: 0.2em;
}

.mono ol {
	padding-inline-start: 2em;
}

.mono ol > li {
	text-indent: -0.4em;
}

.toggle {
	padding-inline-start: 0em;
	list-style-type: none;
}

/* Indent toggle children */
.toggle > li > details {
	padding-left: 1.7em;
}

.toggle > li > details > summary {
	margin-left: -1.1em;
}

.selected-value {
	display: inline-block;
	padding: 0 0.5em;
	background: rgba(206, 205, 202, 0.5);
	border-radius: 3px;
	margin-right: 0.5em;
	margin-top: 0.3em;
	margin-bottom: 0.3em;
	white-space: nowrap;
}

.collection-title {
	display: inline-block;
	margin-right: 1em;
}

.simple-table {
	margin-top: 1em;
	font-size: 0.875rem;
	empty-cells: show;
}
.simple-table td {
	height: 29px;
	min-width: 120px;
}

.simple-table th {
	height: 29px;
	min-width: 120px;
}

.simple-table-header-color {
	background: rgb(247, 246, 243);
	color: black;
}
.simple-table-header {
	font-weight: 500;
}

time {
	opacity: 0.5;
}

.icon {
	display: inline-block;
	max-width: 1.2em;
	max-height: 1.2em;
	text-decoration: none;
	vertical-align: text-bottom;
	margin-right: 0.5em;
}

img.icon {
	border-radius: 3px;
}

.user-icon {
	width: 1.5em;
	height: 1.5em;
	border-radius: 100%;
	margin-right: 0.5rem;
}

.user-icon-inner {
	font-size: 0.8em;
}

.text-icon {
	border: 1px solid #000;
	text-align: center;
}

.page-cover-image {
	display: block;
	object-fit: cover;
	width: 100%;
	max-height: 30vh;
}

.page-header-icon {
	font-size: 3rem;
	margin-bottom: 1rem;
}

.page-header-icon-with-cover {
	margin-top: -0.72em;
	margin-left: 0.07em;
}

.page-header-icon img {
	border-radius: 3px;
}

.link-to-page {
	margin: 1em 0;
	padding: 0;
	border: none;
	font-weight: 500;
}

p > .user {
	opacity: 0.5;
}

td > .user,
td > time {
	white-space: nowrap;
}

input[type="checkbox"] {
	transform: scale(1.5);
	margin-right: 0.6em;
	vertical-align: middle;
}

p {
	margin-top: 0.5em;
	margin-bottom: 0.5em;
}

.image {
	border: none;
	margin: 1.5em 0;
	padding: 0;
	border-radius: 0;
	text-align: center;
}

.code,
code {
	background: rgba(135, 131, 120, 0.15);
	border-radius: 3px;
	padding: 0.2em 0.4em;
	border-radius: 3px;
	font-size: 85%;
	tab-size: 2;
}

code {
	color: #eb5757;
}

.code {
	padding: 1.5em 1em;
}

.code-wrap {
	white-space: pre-wrap;
	word-break: break-all;
}

.code > code {
	background: none;
	padding: 0;
	font-size: 100%;
	color: inherit;
}

blockquote {
	font-size: 1.25em;
	margin: 1em 0;
	padding-left: 1em;
	border-left: 3px solid rgb(55, 53, 47);
}

.bookmark {
	text-decoration: none;
	max-height: 8em;
	padding: 0;
	display: flex;
	width: 100%;
	align-items: stretch;
}

.bookmark-title {
	font-size: 0.85em;
	overflow: hidden;
	text-overflow: ellipsis;
	height: 1.75em;
	white-space: nowrap;
}

.bookmark-text {
	display: flex;
	flex-direction: column;
}

.bookmark-info {
	flex: 4 1 180px;
	padding: 12px 14px 14px;
	display: flex;
	flex-direction: column;
	justify-content: space-between;
}

.bookmark-image {
	width: 33%;
	flex: 1 1 180px;
	display: block;
	position: relative;
	object-fit: cover;
	border-radius: 1px;
}

.bookmark-description {
	color: rgba(55, 53, 47, 0.6);
	font-size: 0.75em;
	overflow: hidden;
	max-height: 4.5em;
	word-break: break-word;
}

.bookmark-href {
	font-size: 0.75em;
	margin-top: 0.25em;
}

.sans { font-family: ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol"; }
.code { font-family: "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace; }
.serif { font-family: Lyon-Text, Georgia, ui-serif, serif; }
.mono { font-family: iawriter-mono, Nitti, Menlo, Courier, monospace; }
.pdf .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK JP'; }
.pdf:lang(zh-CN) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK SC'; }
.pdf:lang(zh-TW) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK TC'; }
.pdf:lang(ko-KR) .sans { font-family: Inter, ui-sans-serif, -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, "Apple Color Emoji", Arial, sans-serif, "Segoe UI Emoji", "Segoe UI Symbol", 'Twemoji', 'Noto Color Emoji', 'Noto Sans CJK KR'; }
.pdf .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .code { font-family: Source Code Pro, "SFMono-Regular", Menlo, Consolas, "PT Mono", "Liberation Mono", Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.pdf .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK JP'; }
.pdf:lang(zh-CN) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK SC'; }
.pdf:lang(zh-TW) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK TC'; }
.pdf:lang(ko-KR) .serif { font-family: PT Serif, Lyon-Text, Georgia, ui-serif, serif, 'Twemoji', 'Noto Color Emoji', 'Noto Serif CJK KR'; }
.pdf .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK JP'; }
.pdf:lang(zh-CN) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK SC'; }
.pdf:lang(zh-TW) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK TC'; }
.pdf:lang(ko-KR) .mono { font-family: PT Mono, iawriter-mono, Nitti, Menlo, Courier, monospace, 'Twemoji', 'Noto Color Emoji', 'Noto Sans Mono CJK KR'; }
.highlight-default {
	color: rgba(55, 53, 47, 1);
}
.highlight-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.highlight-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.highlight-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.highlight-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.highlight-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.highlight-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.highlight-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.highlight-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.highlight-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.highlight-gray_background {
	background: rgba(241, 241, 239, 1);
}
.highlight-brown_background {
	background: rgba(244, 238, 238, 1);
}
.highlight-orange_background {
	background: rgba(251, 236, 221, 1);
}
.highlight-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.highlight-teal_background {
	background: rgba(237, 243, 236, 1);
}
.highlight-blue_background {
	background: rgba(231, 243, 248, 1);
}
.highlight-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.highlight-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.highlight-red_background {
	background: rgba(253, 235, 236, 1);
}
.block-color-default {
	color: inherit;
	fill: inherit;
}
.block-color-gray {
	color: rgba(120, 119, 116, 1);
	fill: rgba(120, 119, 116, 1);
}
.block-color-brown {
	color: rgba(159, 107, 83, 1);
	fill: rgba(159, 107, 83, 1);
}
.block-color-orange {
	color: rgba(217, 115, 13, 1);
	fill: rgba(217, 115, 13, 1);
}
.block-color-yellow {
	color: rgba(203, 145, 47, 1);
	fill: rgba(203, 145, 47, 1);
}
.block-color-teal {
	color: rgba(68, 131, 97, 1);
	fill: rgba(68, 131, 97, 1);
}
.block-color-blue {
	color: rgba(51, 126, 169, 1);
	fill: rgba(51, 126, 169, 1);
}
.block-color-purple {
	color: rgba(144, 101, 176, 1);
	fill: rgba(144, 101, 176, 1);
}
.block-color-pink {
	color: rgba(193, 76, 138, 1);
	fill: rgba(193, 76, 138, 1);
}
.block-color-red {
	color: rgba(212, 76, 71, 1);
	fill: rgba(212, 76, 71, 1);
}
.block-color-gray_background {
	background: rgba(241, 241, 239, 1);
}
.block-color-brown_background {
	background: rgba(244, 238, 238, 1);
}
.block-color-orange_background {
	background: rgba(251, 236, 221, 1);
}
.block-color-yellow_background {
	background: rgba(251, 243, 219, 1);
}
.block-color-teal_background {
	background: rgba(237, 243, 236, 1);
}
.block-color-blue_background {
	background: rgba(231, 243, 248, 1);
}
.block-color-purple_background {
	background: rgba(244, 240, 247, 0.8);
}
.block-color-pink_background {
	background: rgba(249, 238, 243, 0.8);
}
.block-color-red_background {
	background: rgba(253, 235, 236, 1);
}
.select-value-color-pink { background-color: rgba(245, 224, 233, 1); }
.select-value-color-purple { background-color: rgba(232, 222, 238, 1); }
.select-value-color-green { background-color: rgba(219, 237, 219, 1); }
.select-value-color-gray { background-color: rgba(227, 226, 224, 1); }
.select-value-color-translucentGray { background-color: rgba(255, 255, 255, 0.0375); }
.select-value-color-orange { background-color: rgba(250, 222, 201, 1); }
.select-value-color-brown { background-color: rgba(238, 224, 218, 1); }
.select-value-color-red { background-color: rgba(255, 226, 221, 1); }
.select-value-color-yellow { background-color: rgba(253, 236, 200, 1); }
.select-value-color-blue { background-color: rgba(211, 229, 239, 1); }

.checkbox {
	display: inline-flex;
	vertical-align: text-bottom;
	width: 16;
	height: 16;
	background-size: 16px;
	margin-left: 2px;
	margin-right: 5px;
}

.checkbox-on {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20width%3D%2216%22%20height%3D%2216%22%20fill%3D%22%2358A9D7%22%2F%3E%0A%3Cpath%20d%3D%22M6.71429%2012.2852L14%204.9995L12.7143%203.71436L6.71429%209.71378L3.28571%206.2831L2%207.57092L6.71429%2012.2852Z%22%20fill%3D%22white%22%2F%3E%0A%3C%2Fsvg%3E");
}

.checkbox-off {
	background-image: url("data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%2216%22%20height%3D%2216%22%20viewBox%3D%220%200%2016%2016%22%20fill%3D%22none%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%3E%0A%3Crect%20x%3D%220.75%22%20y%3D%220.75%22%20width%3D%2214.5%22%20height%3D%2214.5%22%20fill%3D%22white%22%20stroke%3D%22%2336352F%22%20stroke-width%3D%221.5%22%2F%3E%0A%3C%2Fsvg%3E");
}
	
</style></head><body><article id="c6369f39-7458-44c8-af17-d37db5a75eac" class="page sans"><header><h1 class="page-title"><a href="https://maldevacademy.com/modules/15"><strong>15. Payload Placement - .rsrc Section</strong></a></h1></header><div class="page-body"><h2 id="923ab94d-09e6-4195-a141-e0d549a4a825" class=""><strong>Payload Placement - .rsrc Section</strong></h2><h3 id="37748c2c-c916-4e79-9f5f-0a50ce0f4bb8" class=""><strong>Introduction</strong></h3><p id="7b94b1e0-ad2c-4def-82e7-1a4f5da2b11a" class="">Saving the payload in the <code>.rsrc</code> section is one of the best options as this is where most real-world binaries save their data. It is also a cleaner method for malware authors, since larger payloads cannot be stored in the <code>.data</code> or <code>.rdata</code> sections due to size limits, leading to errors from Visual Studio during compilation.</p><h3 id="5de8bf27-6f51-469c-9f91-935dd43c7a82" class=""><strong>.rsrc Section</strong></h3><p id="fe34ce1c-0e0c-4481-9d6e-4dd8588d6714" class="">The steps below illustrate how to store a payload in the <code>.rsrc</code> section.</p><p id="dc49ed2e-24fd-4ccb-b80b-f8a5d4f254d0" class="">1.Inside Visual Studio, right-click on &#x27;Resource files&#x27; then click Add &gt; New Item.</p><figure id="4e3ad7ab-9521-4203-81d3-a9d1c0e71df9" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-1.png"><img style="width:973px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-1.png"/></a></figure><p id="93beaeda-aced-4acd-bf65-be851f95a228" class="">2.Click on &#x27;Resource File&#x27;.</p><figure id="547c626e-2d9d-415b-bcc5-eee71732026d" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-2.png"><img style="width:973px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-2.png"/></a></figure><p id="0432c122-c8ee-4320-bd1f-29ee74033621" class="">3.This will generate a new sidebar, the Resource View. Right-click on the .rc file (Resource.rc is the default name), and select the &#x27;Add Resource&#x27; option.</p><figure id="f02aecc9-b102-46a4-81c1-184f130d6535" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-3.png"><img style="width:711px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-3.png"/></a></figure><p id="79fa97d0-2ebe-42ad-a090-591401ec2ef1" class="">4.Click &#x27;Import&#x27;.</p><figure id="f681c387-6d30-47f6-b174-3687d4c1bfb4" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-4.png"><img style="width:970px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-4.png"/></a></figure><p id="87b44c8f-b43f-463e-84af-ddeb566a1356" class="">5.Select the calc.ico file, which is the raw payload renamed to have the <code>.ico</code> extension.</p><figure id="c2be09af-0c3d-4774-b7a8-88f1568809a3" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-5.png"><img style="width:973px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-5.png"/></a></figure><p id="f6e7de30-6896-4c50-a624-ab098120c90f" class="">6.A prompt will appear requesting the resource type. Enter &quot;RCDATA&quot; without the quotes.</p><figure id="c35df260-5d15-4090-b5c2-553374c2701d" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-6.png"><img style="width:973px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-6.png"/></a></figure><p id="ce00975b-466a-433b-a7ad-19aa8ec5451f" class="">7.After clicking OK, the payload should be displayed in raw binary format within the Visual Studio project</p><figure id="3ea722ac-3e91-4721-8c3b-6cbd0133db3e" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-7.png"><img style="width:973px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-7.png"/></a></figure><p id="d6b97f1b-4327-435e-a6db-ec765ad32a5f" class="">8.When exiting the Resource View, the &quot;resource.h&quot; header file should be visible and named according to the .rc file from Step 2. This file contains a define statement that refers to the payload&#x27;s ID in the resource section (IDR_RCDATA1). This is important in order to be able to retrieve the payload from the resource section later.</p><figure id="1fac70fd-74c7-4194-9963-145f8e20b028" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-8.png"><img style="width:975px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-8.png"/></a></figure><p id="315e7fe1-521f-4a06-8878-d9c6bd18d6e8" class="">Once compiled, the payload will now be stored in the <code>.rsrc</code> section, but it cannot be accessed directly. Instead, several WinAPIs must be used to access it.</p><ul id="0d517230-b6f2-4b9b-8d6a-b4bfa64a7bb3" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-findresourcew">FindResourceW</a> - Get the location of the specified data stored in the resource section of a special ID passed in (this is defined in the header file)</li></ul><ul id="5e4448d8-d2f8-47da-b0e6-c816c373f865" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-loadresource">LoadResource</a> - Retrieves a <code>HGLOBAL</code> handle of the resource data. This handle can be used to obtain the base address of the specified resource in memory.</li></ul><ul id="1c12d7c4-b40c-4396-94c2-90c248eadfbc" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-lockresource">LockResource</a> - Obtain a pointer to the specified data in the resource section from its handle.</li></ul><ul id="aa9aa899-1a34-40ea-af30-e9dfe5d9ee5f" class="bulleted-list"><li style="list-style-type:disc"><a href="https://learn.microsoft.com/en-us/windows/win32/api/libloaderapi/nf-libloaderapi-sizeofresource">SizeofResource</a> - Get the size of the specified data in the resource section.</li></ul><p id="4adb1edf-5bba-4eab-9f33-93d985beca23" class="">The code snippet below will utilize the above Windows APIs to access the <code>.rsrc</code> section and fetch the payload address and size.</p><pre id="eff4a8c3-0e17-4625-bf9e-6eecf7cabe1f" class="code code-wrap"><code>#include &lt;Windows.h&gt;#include &lt;stdio.h&gt;#include &quot;resource.h&quot;int main() {

	HRSRC		hRsrc                   = NULL;
	HGLOBAL		hGlobal                 = NULL;
	PVOID		pPayloadAddress         = NULL;
	SIZE_T		sPayloadSize            = NULL;


	// Get the location to the data stored in .rsrc by its id *IDR_RCDATA1*
	hRsrc = FindResourceW(NULL, MAKEINTRESOURCEW(IDR_RCDATA1), RT_RCDATA);
	if (hRsrc == NULL) {
		// in case of function failure
		printf(&quot;[!] FindResourceW Failed With Error : %d \n&quot;, GetLastError());
		return -1;
	}

	// Get HGLOBAL, or the handle of the specified resource data since its required to call LockResource later
	hGlobal = LoadResource(NULL, hRsrc);
	if (hGlobal == NULL) {
		// in case of function failure
		printf(&quot;[!] LoadResource Failed With Error : %d \n&quot;, GetLastError());
		return -1;
	}

	// Get the address of our payload in .rsrc section
	pPayloadAddress = LockResource(hGlobal);
	if (pPayloadAddress == NULL) {
		// in case of function failure
		printf(&quot;[!] LockResource Failed With Error : %d \n&quot;, GetLastError());
		return -1;
	}

	// Get the size of our payload in .rsrc section
	sPayloadSize = SizeofResource(NULL, hRsrc);
	if (sPayloadSize == NULL) {
		// in case of function failure
		printf(&quot;[!] SizeofResource Failed With Error : %d \n&quot;, GetLastError());
		return -1;
	}

	// Printing pointer and size to the screen
	printf(&quot;[i] pPayloadAddress var : 0x%p \n&quot;, pPayloadAddress);
	printf(&quot;[i] sPayloadSize var : %ld \n&quot;, sPayloadSize);
	printf(&quot;[#] Press &lt;Enter&gt; To Quit ...&quot;);
	getchar();
	return 0;
}
</code></pre><p id="ed35f36d-0d14-4e6f-9244-92dbf09195fc" class="">After compiling and running the code above, the payload address along with its size will be printed onto the screen. It is important to note that this address is in the <code>.rsrc</code> section, which is read-only memory, and any attempts to change or edit data within it will cause an access violation error. To edit the payload, a buffer must be allocated with the same size as the payload and copied over. This new buffer is where changes, such as decrypting the payload, can be made.</p><h3 id="0ffdd29d-4420-48c1-b0de-873ebd13c1c3" class=""><strong>Updating .rsrc Payload</strong></h3><p id="17693139-cefe-4a65-a2bc-7cfc313fdb9a" class="">Since the payload can&#x27;t be edited directly from within the resource section, it must be moved to a temporary buffer. To do so, memory is allocated the size of the payload using <a href="https://learn.microsoft.com/en-us/windows/win32/api/heapapi/nf-heapapi-heapalloc">HeapAlloc</a> and then the payload is moved from the resource section to the temporary buffer using <code>memcpy</code>.</p><pre id="18f1068d-c9c4-4ff4-ac09-402649074d81" class="code code-wrap"><code>// Allocating memory using a HeapAlloc call
PVOID pTmpBuffer = HeapAlloc(GetProcessHeap(), 0, sPayloadSize);
if (pTmpBuffer != NULL){
	// copying the payload from resource section to the new buffer
	memcpy(pTmpBuffer, pPayloadAddress, sPayloadSize);
}

// Printing the base address of our buffer (pTmpBuffer)
printf(&quot;[i] pTmpBuffer var : 0x%p \n&quot;, pTmpBuffer);

</code></pre><p id="ba221f45-00b2-4420-8c07-2d6218dd90ea" class="">Since <code>pTmpBuffer</code> now points to a writable memory region that is holding the payload, it&#x27;s possible to decrypt the payload or perform any updates to it.</p><p id="ff4f4837-b165-4278-807a-ceaa9c201764" class="">The image below shows the Msfvenom shellcode stored in the resource section.</p><figure id="0cd9bb0a-6c2c-4bec-a6af-5697957218ca" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-payload.png"><img style="width:1660px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-payload.png"/></a></figure><p id="d1089381-3853-4c89-82ff-ab93f28afa55" class="">Proceeding with the execution, the payload is saved in the temporary buffer.</p><figure id="27193ab5-79bc-429b-9a8e-4d22aed1e2dc" class="image"><a href="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-tmpbuffer.png"><img style="width:1533px" src="15%20Payload%20Placement%20-%20rsrc%20Section%20c6369f39745844c8af17d37db5a75eac/rsrc-tmpbuffer.png"/></a></figure><p id="90143dc5-04a1-4a87-8280-e8fa86e62f34" class="">
</p></div></article></body></html>